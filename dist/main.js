(()=>{"use strict";const e=e=>{let t=[],s=0;const a=(e=>{const t=[];for(let s=0;s<e*e;s++)t.push({coords:{x:s%e,y:Math.floor(s/e)},hasShip:"",isShot:!1});return t})(e),r=t=>a[t.x+t.y*e],i=e=>{const t=[-1,1];let s=[];for(const a of t)for(const t in e){const r=e[t]+a;r<=9&&r>=0&&s.push({...e,[t]:r})}return s};return{at:r,isValidAttack:e=>!r(e).isShot,isShipHit:e=>""!==r(e).hasShip,receiveAttack:e=>{const a=r(e);a.isShot=!0,a.hasShip&&(e=>{const a=t.find((t=>t.name===e));a.hit(),a.isSunk()&&s++})(a.hasShip)},setShip:(e,s,a="x")=>{t.push(e);let i=s;for(let t=0;t<e.getLength();t++)r(i).hasShip=e.name,"x"===a?i.x++:i.y++},getShipCoordsArray:e=>a.filter((t=>t.hasShip===e.name)).map((e=>e.coords)),getValidAdjacentCoords:i,isCollisions:t=>{for(const s of t){if(s.x>e-1||s.y>e-1)return!0;if(""!==r(s).hasShip)return!0;const t=i(s);for(const e of t)if(""!==r(e).hasShip)return!0}return!1},getShipByCoords:e=>t.find((t=>t.name===r(e).hasShip)),getBoard:()=>a,getShips:()=>t,reset:()=>{t=[];for(const e of a)e.isShot=!1,e.hasShip=""},allShipsSunk:()=>s>=t.length}},t=(t,s)=>({name:t,displayName:s,gameboard:e(10),isActive:!1}),s=(()=>{const e=document.querySelector(".gameboards-container"),t=document.querySelector(".modal"),s=document.querySelector(".modal-win");let a="PLAY";const r=e=>{const t=e.split(" ");return{x:+t[0],y:+t[1]}},n=(e,t=null,s=null)=>{const a=document.createElement(e);return t&&t.forEach((e=>a.classList.add(e))),s&&(a.textContent=s),a};return{renderGameboard:(s,d,c=!1)=>{a="sample"===s?"PLACE":"PLAY";const h=(e=>{const t=n("div",["container"]);return t.appendChild(n("div",[`${e}`,"board"])),t.appendChild(n("div",["ships-display"])),t})(s);"PLACE"===a?t.appendChild(h):e.appendChild(h),c&&h.firstChild.classList.add("active"),d.forEach((e=>h.firstChild.appendChild((e=>{const t=n("div",["cell"]);return t.setAttribute("data-coords",`${e.coords.x} ${e.coords.y}`),e.hasShip&&t.classList.add("ship"),(e=>{"PLACE"===a?(e.addEventListener("click",(()=>{o.placeShip(r(e.getAttribute("data-coords")))})),e.addEventListener("mouseover",(()=>{o.showShip(r(e.getAttribute("data-coords")))}))):e.addEventListener("click",(()=>{i.playTurn(r(e.getAttribute("data-coords")))}))})(t),t})(e))))},updateShipsDisplay:(e,t,s=-1)=>{const r=document.querySelector(`.${e}`).nextElementSibling;r.textContent="",t.forEach(((e,t)=>{r.appendChild(((e,t=!1)=>{const s=n("div",["ship-container"]);(e.isSunk()||"PLACE"===a&&t)&&s.classList.add("sunk"),s.appendChild(n("div",["ship-name"],e.name));const r=n("div",["ship-body"]);for(let t=0;t<e.getLength();t++)r.appendChild(n("div",["ship-cell"]));return s.appendChild(r),s})(e,t<=s))}))},cellHit:e=>{const t=`${e.x} ${e.y}`;document.querySelector(`.active > [data-coords="${t}"]`).classList.add("hit")},shipSunk:e=>{e.forEach((e=>{document.querySelector(`.active > [data-coords="${e.x} ${e.y}"]`).classList.add("sunk")}))},toggleActiveBoard:()=>{Array.from(e.children).forEach((e=>{e.classList.contains("container")&&e.firstChild.classList.toggle("active")}))},showWinner:e=>{s.firstChild.textContent=`${e} wins`,s.classList.add("visible")}}})(),a=(e,t)=>{const s=e;let a=0;return{name:t,getLength:()=>s,getHits:()=>a,hit:()=>{a++},isSunk:()=>a>=s}},r=(()=>{const e=t("AI"),s=[a(5,"Carrier"),a(4,"Battleship"),a(3,"Cruiser"),a(3,"Submarine"),a(2,"Destroyer")];let r=null;const i=()=>{const t=e.gameboard.getBoard().filter((e=>!e.isShot));return t[Math.floor(Math.random()*t.length)].coords},o=(e,t,s=!1)=>Object.keys(e).reduce(((a,r)=>({...a,[r]:e[r]+(s?-1:1)*t[r]})),{});return{getCoords:t=>{let s;return e.gameboard=t,r?e.gameboard.getShips().find((t=>t.name===e.gameboard.at(r).hasShip)).isSunk()?(r=null,s=i()):s=(()=>{const t=function(e){let t=e.length;for(;t--;){const s=Math.floor(Math.random()*t);[e[t],e[s]]=[e[s],e[t]]}return e}(e.gameboard.getValidAdjacentCoords(r));for(const s of t){let t=e.gameboard.at(s);if(t.isShot&&t.hasShip){let a={...s},i=o(a,r,!0);for(;t.isShot&&t.hasShip&&(a=o(a,i),!(a.x<0||a.x>9||a.y<0||a.y>9));)t=e.gameboard.at(a);return t.isShot?o(r,i,!0):a}}for(const s of t)if(!e.gameboard.at(s).isShot)return s})():s=i(),e.gameboard.isShipHit(s)&&(r=s),s},getAIPlayer:()=>(e.gameboard.setShip(s[0],{x:0,y:0},"x"),e.gameboard.setShip(s[1],{x:9,y:6},"y"),e.gameboard.setShip(s[2],{x:1,y:7},"y"),e.gameboard.setShip(s[3],{x:7,y:1},"x"),e.gameboard.setShip(s[4],{x:4,y:3},"x"),e)}})(),i=(()=>{const e=t("P1","Player"),a=t("P2","Enemy");function i(e){return new Promise((t=>setTimeout(t,e)))}const n=()=>e.isActive?a:e,d=async t=>{const r=n().gameboard;if(r.isValidAttack(t)){if(r.receiveAttack(t),s.cellHit(t),r.isShipHit(t)){s.updateShipsDisplay(n().name,r.getShips());const i=r.getShipByCoords(t);if(i.isSunk()&&(s.shipSunk(r.getShipCoordsArray(i)),r.allShipsSunk()))return void s.showWinner((e.isActive?e:a).displayName)}else await i(300),e.isActive=!e.isActive,a.isActive=!a.isActive,s.toggleActiveBoard();c()}},c=async()=>{a.isActive&&(await i(300*Math.random()+300),d(r.getCoords(n().gameboard)))};return{init:()=>{e.isActive=!0,e.gameboard=o.getSamplePlayer().gameboard,s.renderGameboard(e.name,e.gameboard.getBoard()),s.updateShipsDisplay(e.name,e.gameboard.getShips()),a.isActive=!1,a.gameboard=r.getAIPlayer().gameboard,s.renderGameboard(a.name,a.gameboard.getBoard(),!0),s.updateShipsDisplay(a.name,a.gameboard.getShips())},playTurn:d}})(),o=(()=>{const e=t("sample"),r=[a(5,"Carrier"),a(4,"Battleship"),a(3,"Cruiser"),a(3,"Submarine"),a(2,"Destroyer")];let o={shipNum:0,shipCoordsArray:[],axis:"x"};const n=document.querySelector(".modal"),d=document.querySelector("button.play"),c=document.querySelector("button.reset"),h=e=>document.querySelector(`[data-coords="${e.x} ${e.y}"]`),l=e=>{o.shipNum>=r.length||(0!==o.shipCoordsArray.length&&o.shipCoordsArray.forEach((e=>{h(e).classList.remove("temp"),h(e).classList.remove("invalid")})),o.shipCoordsArray=p(e),o.shipCoordsArray.forEach((e=>{h(e).classList.add("temp")})),m()||o.shipCoordsArray.forEach((e=>{h(e).classList.add("invalid")})))},p=e=>{let t=[],s=e;for(let e=0;e<r[o.shipNum].getLength()&&(t.push({x:s.x,y:s.y}),"x"===o.axis?s.x++:s.y++,!(s.x>9||s.y>9));e++);return t},m=()=>!e.gameboard.isCollisions(o.shipCoordsArray)&&o.shipCoordsArray.length===r[o.shipNum].getLength(),u=()=>{e.gameboard.reset(),e.gameboard.getBoard().forEach((e=>{h(e.coords).classList.remove("ship"),h(e.coords).classList.remove("temp"),h(e.coords).classList.remove("invalid")})),Array.from(document.querySelector(".ships-display").children).forEach((e=>e.classList.remove("sunk"))),o={shipNum:0,shipCoordsArray:[],axis:"x"},d.style.display="none"};return{init:()=>{s.renderGameboard(e.name,e.gameboard.getBoard()),s.updateShipsDisplay(e.name,r),document.addEventListener("keyup",(({key:e})=>{"R"!==e&&"r"!==e||(o.axis="x"===o.axis?"y":"x",l(o.shipCoordsArray[0],o.axis))})),d.addEventListener("click",(()=>{n.remove(),i.init()})),c.addEventListener("click",u)},placeShip:t=>{m()&&(e.gameboard.setShip(r[o.shipNum++],t,o.axis),o.shipCoordsArray.forEach((e=>{h(e).classList.add("ship"),h(e).classList.remove("temp")})),s.updateShipsDisplay(e.name,r,o.shipNum-1),o.shipNum===r.length&&(d.style.display="block"))},showShip:l,getSamplePlayer:()=>e}})();o.init()})();
//# sourceMappingURL=data:application/json;charset=utf-8;base64,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bkNvRCxTQUFTNEIsaUJBQWlCLFNBQVMsRUFBRzdELElBQUFBLE1BQ3hCLE1BQVJBLEdBQXVCLE1BQVJBLElBQ2pCMkgsRUFBUTdHLEtBQXdCLE1BQWpCNkcsRUFBUTdHLEtBQWUsSUFBSyxJQUMzQ2lILEVBQVNKLEVBQVF0RyxnQkFBZ0IsR0FBSXNHLEVBQVE3RyxVQUlqRDhHLEVBQVkvRCxpQkFBaUIsU0FBUyxLQUNwQzFCLEVBQU82RixTQUNQLFlBR0ZILEVBQWFoRSxpQkFBaUIsUUFBU25DLElBS3ZDMkcsVUFyRGlCbEosSUFDWitJLE1BQ0xSLEVBQU81RixVQUFVakIsUUFBUWhDLEVBQU04SSxFQUFRekQsV0FBWS9FLEVBQVF3SSxFQUFRN0csTUFDbkU2RyxFQUFRdEcsZ0JBQWdCMkIsU0FBUTdELElBQzlCMkksRUFBTzNJLEdBQVErRCxVQUFVQyxJQUFJLFFBQzdCMkUsRUFBTzNJLEdBQVErRCxVQUFVOEUsT0FBTyxXQUVsQyxxQkFBc0JOLEVBQU9qSCxLQUFNNUIsRUFBTzhJLEVBQVF6RCxRQUFVLEdBQ3hEeUQsRUFBUXpELFVBQVlyRixFQUFNK0MsU0FDNUJnRyxFQUFZTyxNQUFNQyxRQUFVLFdBNkM5QkwsU0FBQUEsRUFDQU8sZ0JBekJzQixJQUFNWixJQXRGYixHQ0ZuQixVIiwic291cmNlcyI6WyJ3ZWJwYWNrOi8vYmF0dGxlc2hpcC8uL3NyYy9GYWN0b3JpZXMvR2FtZWJvYXJkLmpzIiwid2VicGFjazovL2JhdHRsZXNoaXAvLi9zcmMvRmFjdG9yaWVzL1BsYXllci5qcyIsIndlYnBhY2s6Ly9iYXR0bGVzaGlwLy4vc3JjL01vZHVsZXMvVUkuanMiLCJ3ZWJwYWNrOi8vYmF0dGxlc2hpcC8uL3NyYy9GYWN0b3JpZXMvU2hpcC5qcyIsIndlYnBhY2s6Ly9iYXR0bGVzaGlwLy4vc3JjL01vZHVsZXMvQUlQbGF5ZXIuanMiLCJ3ZWJwYWNrOi8vYmF0dGxlc2hpcC8uL3NyYy9Nb2R1bGVzL0dhbWVDb250cm9sbGVyLmpzIiwid2VicGFjazovL2JhdHRsZXNoaXAvLi9zcmMvTW9kdWxlcy9QbGFjZVNoaXBzLmpzIiwid2VicGFjazovL2JhdHRsZXNoaXAvLi9zcmMvaW5kZXguanMiXSwic291cmNlc0NvbnRlbnQiOlsiY29uc3QgR2FtZWJvYXJkID0gKHNpemUpID0+IHtcblxuICBsZXQgc2hpcHMgPSBbXTtcbiAgbGV0IHN1bmsgPSAwO1xuXG4gIGNvbnN0IGNlbGwgPSAoeCwgeSkgPT4ge1xuICAgIHJldHVybiB7XG4gICAgICBjb29yZHM6IHt4LCB5fSxcbiAgICAgIGhhc1NoaXA6ICcnLFxuICAgICAgaXNTaG90OiBmYWxzZVxuICAgIH07XG4gIH1cblxuICBjb25zdCBfbWFrZUdyaWQgPSAoc2l6ZSkgPT4ge1xuICAgIGNvbnN0IGFyciA9IFtdO1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgc2l6ZSAqIHNpemU7IGkrKykge1xuICAgICAgYXJyLnB1c2goY2VsbChpICUgc2l6ZSwgTWF0aC5mbG9vcihpIC8gc2l6ZSkpKTtcbiAgICB9XG4gICAgcmV0dXJuIGFycjtcbiAgfVxuXG4gIGNvbnN0IGJvYXJkID0gX21ha2VHcmlkKHNpemUpO1xuICBjb25zdCBhdCA9IChjb29yZHMpID0+IGJvYXJkW2Nvb3Jkcy54ICsgY29vcmRzLnkgKiBzaXplXTtcblxuICBjb25zdCBpc1ZhbGlkQXR0YWNrID0gKGNvb3JkcykgPT4ge1xuICAgIHJldHVybiAhYXQoY29vcmRzKS5pc1Nob3Q7XG4gIH1cblxuICBjb25zdCBzZXRTaGlwID0gKHNoaXAsIGNvb3JkcywgYXhpcyA9ICd4JykgPT4ge1xuICAgIHNoaXBzLnB1c2goc2hpcCk7XG4gICAgbGV0IG5ld0Nvb3JkcyA9IGNvb3JkcztcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHNoaXAuZ2V0TGVuZ3RoKCk7IGkrKykge1xuICAgICAgYXQobmV3Q29vcmRzKS5oYXNTaGlwID0gc2hpcC5uYW1lO1xuICAgICAgYXhpcyA9PT0gJ3gnID8gbmV3Q29vcmRzLngrKzogbmV3Q29vcmRzLnkrKztcbiAgICB9XG4gIH1cblxuICBjb25zdCBpc1NoaXBIaXQgPSAoY29vcmRzKSA9PiB7XG4gICAgcmV0dXJuIGF0KGNvb3JkcykuaGFzU2hpcCAhPT0gJyc7XG4gIH1cblxuICBjb25zdCByZWNlaXZlQXR0YWNrID0gKGNvb3JkcykgPT4ge1xuICAgIGNvbnN0IGNlbGwgPSBhdChjb29yZHMpO1xuICAgIGNlbGwuaXNTaG90ID0gdHJ1ZTtcbiAgICBpZiAoY2VsbC5oYXNTaGlwKSBzaGlwSGl0KGNlbGwuaGFzU2hpcCk7XG4gIH1cblxuICBjb25zdCBzaGlwSGl0ID0gKHNoaXBOYW1lKSA9PiB7XG4gICAgY29uc3Qgc2hpcCA9IHNoaXBzLmZpbmQoc2hpcCA9PiBzaGlwLm5hbWUgPT09IHNoaXBOYW1lKTtcbiAgICBzaGlwLmhpdCgpO1xuICAgIGlmIChzaGlwLmlzU3VuaygpKSBzdW5rKys7XG4gIH1cblxuICBjb25zdCBnZXRTaGlwQ29vcmRzQXJyYXkgPSAoc2hpcCkgPT4ge1xuICAgIHJldHVybiBib2FyZC5maWx0ZXIoY2VsbCA9PiBjZWxsLmhhc1NoaXAgPT09IHNoaXAubmFtZSkubWFwKGNlbGwgPT4gY2VsbC5jb29yZHMpO1xuICB9XG5cbiAgY29uc3QgaXNDb2xsaXNpb25zID0gKHNoaXBDb29yZHNBcnJheSkgPT4ge1xuICAgIGZvciAoY29uc3Qgc2hpcENvb3JkcyBvZiBzaGlwQ29vcmRzQXJyYXkpIHtcbiAgICAgIGlmIChzaGlwQ29vcmRzLnggPiBzaXplIC0gMSB8fCBzaGlwQ29vcmRzLnkgPiBzaXplIC0gMSkgcmV0dXJuIHRydWU7XG4gICAgICBpZiAoYXQoc2hpcENvb3JkcykuaGFzU2hpcCAhPT0gJycpIHJldHVybiB0cnVlO1xuICAgICAgY29uc3QgYWRqYWNlbnRDb29yZHMgPSBnZXRWYWxpZEFkamFjZW50Q29vcmRzKHNoaXBDb29yZHMpO1xuICAgICAgZm9yIChjb25zdCBjb29yZHMgb2YgYWRqYWNlbnRDb29yZHMpIHtcbiAgICAgICAgaWYgKGF0KGNvb3JkcykuaGFzU2hpcCAhPT0gJycpIHJldHVybiB0cnVlO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cblxuICBjb25zdCBnZXRWYWxpZEFkamFjZW50Q29vcmRzID0gKGNvb3JkcykgPT4ge1xuICAgIGNvbnN0IGFkamFjZW5jeSA9IFstMSwgMV07IC8vIDQtd2F5IGFkamFjZW5jeVxuICAgIGxldCBhZGphY2VudENvb3JkcyA9IFtdO1xuICAgIGZvcihjb25zdCBhZGphY2VudCBvZiBhZGphY2VuY3kpIHtcbiAgICAgIGZvciAoY29uc3Qga2V5IGluIGNvb3Jkcykge1xuICAgICAgICBjb25zdCBuZXdQb2ludCA9IGNvb3Jkc1trZXldICsgYWRqYWNlbnQ7XG4gICAgICAgIGlmIChuZXdQb2ludCA8PSA5ICYmIG5ld1BvaW50ID49IDApe1xuICAgICAgICAgIGFkamFjZW50Q29vcmRzLnB1c2goey4uLmNvb3JkcywgW2tleV06IG5ld1BvaW50fSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIGFkamFjZW50Q29vcmRzO1xuICB9XG5cbiAgY29uc3QgZ2V0U2hpcEJ5Q29vcmRzID0gKGNvb3JkcykgPT4ge1xuICAgIHJldHVybiBzaGlwcy5maW5kKHNoaXAgPT4gc2hpcC5uYW1lID09PSBhdChjb29yZHMpLmhhc1NoaXApO1xuICB9XG5cbiAgY29uc3QgcmVzZXQgPSAoKSA9PiB7XG4gICAgc2hpcHMgPSBbXTtcbiAgICBmb3IgKGNvbnN0IGNlbGwgb2YgYm9hcmQpIHtcbiAgICAgIGNlbGwuaXNTaG90ID0gZmFsc2U7XG4gICAgICBjZWxsLmhhc1NoaXAgPSAnJztcbiAgICB9XG4gIH1cblxuICBjb25zdCBhbGxTaGlwc1N1bmsgPSAoKSA9PiB7XG4gICAgcmV0dXJuIHN1bmsgPj0gc2hpcHMubGVuZ3RoO1xuICB9XG5cbiAgY29uc3QgZ2V0Qm9hcmQgPSAoKSA9PiBib2FyZDtcbiAgY29uc3QgZ2V0U2hpcHMgPSAoKSA9PiBzaGlwcztcblxuICByZXR1cm4ge1xuICAgIGF0LFxuICAgIGlzVmFsaWRBdHRhY2ssXG4gICAgaXNTaGlwSGl0LFxuICAgIHJlY2VpdmVBdHRhY2ssXG4gICAgc2V0U2hpcCxcbiAgICBnZXRTaGlwQ29vcmRzQXJyYXksXG4gICAgZ2V0VmFsaWRBZGphY2VudENvb3JkcyxcbiAgICBpc0NvbGxpc2lvbnMsXG4gICAgZ2V0U2hpcEJ5Q29vcmRzLFxuICAgIGdldEJvYXJkLFxuICAgIGdldFNoaXBzLFxuICAgIHJlc2V0LFxuICAgIGFsbFNoaXBzU3Vua1xuICB9O1xufVxuXG5leHBvcnQgZGVmYXVsdCBHYW1lYm9hcmQ7IiwiaW1wb3J0IEdhbWVib2FyZCBmcm9tIFwiLi9HYW1lYm9hcmRcIlxuXG5jb25zdCBQbGF5ZXIgPSAobmFtZSwgZGlzcGxheU5hbWUpID0+IHtcbiAgcmV0dXJuIHtcbiAgICBuYW1lLFxuICAgIGRpc3BsYXlOYW1lLFxuICAgIGdhbWVib2FyZDogR2FtZWJvYXJkKDEwKSxcbiAgICBpc0FjdGl2ZTogZmFsc2UsXG4gIH07XG59XG5cbmV4cG9ydCBkZWZhdWx0IFBsYXllcjsiLCJpbXBvcnQgR2FtZUNvbnRyb2xsZXIgZnJvbSBcIi4vR2FtZUNvbnRyb2xsZXJcIjtcbmltcG9ydCBQbGFjZVNoaXBzIGZyb20gXCIuL1BsYWNlU2hpcHNcIjtcblxuY29uc3QgVUkgPSAoKCkgPT4ge1xuICBjb25zdCAkZ2FtZWJvYXJkc0NvbnRhaW5lciA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJy5nYW1lYm9hcmRzLWNvbnRhaW5lcicpO1xuICBjb25zdCAkbW9kYWwgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcubW9kYWwnKTtcbiAgY29uc3QgJHdpbk1vZGFsID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignLm1vZGFsLXdpbicpO1xuICBsZXQgbW9kZSA9ICdQTEFZJztcblxuICBjb25zdCBkZWNvZGVDb29yZHMgPSAoY29vcmRzU3RyaW5nKSA9PiB7XG4gICAgY29uc3QgY29vcmRzQXJyYXkgPSBjb29yZHNTdHJpbmcuc3BsaXQoJyAnKTtcbiAgICByZXR1cm4ge3g6ICtjb29yZHNBcnJheVswXSwgeTogK2Nvb3Jkc0FycmF5WzFdfTtcbiAgfVxuXG4gIGNvbnN0IGNyZWF0ZUh0bWxFbGVtZW50ID0gKHR5cGUsIGNsYXNzQXJyYXkgPSBudWxsLCB0ZXh0ID0gbnVsbCkgPT4ge1xuICAgIGNvbnN0IGVsZW1lbnQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KHR5cGUpO1xuICAgIGlmIChjbGFzc0FycmF5KSBjbGFzc0FycmF5LmZvckVhY2goY2xzID0+IGVsZW1lbnQuY2xhc3NMaXN0LmFkZChjbHMpKTtcbiAgICBpZiAodGV4dCkgZWxlbWVudC50ZXh0Q29udGVudCA9IHRleHQ7XG4gICAgcmV0dXJuIGVsZW1lbnQ7XG4gIH1cbiAgXG4gIGNvbnN0IG5ld0NlbGxET00gPSAoY2VsbCkgPT4ge1xuICAgICAgY29uc3QgJGNlbGwgPSBjcmVhdGVIdG1sRWxlbWVudCgnZGl2JywgWydjZWxsJ10pO1xuICAgICAgJGNlbGwuc2V0QXR0cmlidXRlKCdkYXRhLWNvb3JkcycsIGAke2NlbGwuY29vcmRzLnh9ICR7Y2VsbC5jb29yZHMueX1gKTtcbiAgICAgIGlmIChjZWxsLmhhc1NoaXApICRjZWxsLmNsYXNzTGlzdC5hZGQoJ3NoaXAnKTtcbiAgICAgIGFkZENlbGxMaXN0ZW5lcigkY2VsbCk7XG4gICAgICByZXR1cm4gJGNlbGw7XG4gIH1cblxuICBjb25zdCBhZGRDZWxsTGlzdGVuZXIgPSAoJGNlbGwpID0+IHtcbiAgICBpZiAobW9kZSA9PT0gJ1BMQUNFJykge1xuICAgICAgJGNlbGwuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoKSA9PiB7XG4gICAgICAgIFBsYWNlU2hpcHMucGxhY2VTaGlwKGRlY29kZUNvb3JkcygkY2VsbC5nZXRBdHRyaWJ1dGUoJ2RhdGEtY29vcmRzJykpKTtcbiAgICAgIH0pO1xuICBcbiAgICAgICRjZWxsLmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlb3ZlcicsICgpID0+IHtcbiAgICAgICAgUGxhY2VTaGlwcy5zaG93U2hpcChkZWNvZGVDb29yZHMoJGNlbGwuZ2V0QXR0cmlidXRlKCdkYXRhLWNvb3JkcycpKSk7XG4gICAgICB9KTtcbiAgICB9XG4gICAgZWxzZSAkY2VsbC5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsICgpID0+IHtcbiAgICAgIEdhbWVDb250cm9sbGVyLnBsYXlUdXJuKGRlY29kZUNvb3JkcygkY2VsbC5nZXRBdHRyaWJ1dGUoJ2RhdGEtY29vcmRzJykpKTtcbiAgICB9KTtcbiAgfVxuXG4gIGNvbnN0IGNlbGxIaXQgPSAoY29vcmRzKSA9PiB7XG4gICAgY29uc3QgZW5jb2RlZENvb3JkcyA9IGAke2Nvb3Jkcy54fSAke2Nvb3Jkcy55fWA7XG4gICAgY29uc3QgJGNlbGwgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKGAuYWN0aXZlID4gW2RhdGEtY29vcmRzPVwiJHtlbmNvZGVkQ29vcmRzfVwiXWApO1xuICAgICRjZWxsLmNsYXNzTGlzdC5hZGQoJ2hpdCcpO1xuICB9XG5cbiAgY29uc3QgdG9nZ2xlQWN0aXZlQm9hcmQgPSAoKSA9PiB7XG4gICAgY29uc3QgJGdhbWVib2FyZENvbnRhaW5lcnMgPSBBcnJheS5mcm9tKCRnYW1lYm9hcmRzQ29udGFpbmVyLmNoaWxkcmVuKTtcbiAgICAkZ2FtZWJvYXJkQ29udGFpbmVycy5mb3JFYWNoKCRnYW1lYm9hcmRDb250YWluZXIgPT4ge1xuICAgICAgaWYgKCRnYW1lYm9hcmRDb250YWluZXIuY2xhc3NMaXN0LmNvbnRhaW5zKCdjb250YWluZXInKSlcbiAgICAgICAgJGdhbWVib2FyZENvbnRhaW5lci5maXJzdENoaWxkLmNsYXNzTGlzdC50b2dnbGUoJ2FjdGl2ZScpO1xuICAgIH0pO1xuICB9XG5cbiAgY29uc3Qgc2hpcFN1bmsgPSAoY29vcmRzQXJyYXkpID0+IHtcbiAgICBjb29yZHNBcnJheS5mb3JFYWNoKGNvb3JkcyA9PiB7XG4gICAgICBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKGAuYWN0aXZlID4gW2RhdGEtY29vcmRzPVwiJHtjb29yZHMueH0gJHtjb29yZHMueX1cIl1gKS5jbGFzc0xpc3QuYWRkKCdzdW5rJyk7XG4gICAgfSlcbiAgfVxuXG4gIGNvbnN0IG5ld0dhbWVib2FyZENvbnRhaW5lckRPTSA9IChwbGF5ZXJOYW1lKSA9PiB7XG4gICAgY29uc3QgJGNvbnRhaW5lciA9IGNyZWF0ZUh0bWxFbGVtZW50KCdkaXYnLCBbJ2NvbnRhaW5lciddKTtcbiAgICAkY29udGFpbmVyLmFwcGVuZENoaWxkKGNyZWF0ZUh0bWxFbGVtZW50KCdkaXYnLCBbYCR7cGxheWVyTmFtZX1gLCAnYm9hcmQnXSkpO1xuICAgICRjb250YWluZXIuYXBwZW5kQ2hpbGQoY3JlYXRlSHRtbEVsZW1lbnQoJ2RpdicsIFsnc2hpcHMtZGlzcGxheSddKSk7XG4gICAgcmV0dXJuICRjb250YWluZXI7XG4gIH1cblxuICBjb25zdCByZW5kZXJHYW1lYm9hcmQgPSAocGxheWVyTmFtZSwgYm9hcmQsIGlzQWN0aXZlID0gZmFsc2UpID0+IHtcbiAgICBtb2RlID0gcGxheWVyTmFtZSA9PT0gJ3NhbXBsZScgPyAnUExBQ0UnOiAnUExBWSc7XG4gICAgY29uc3QgJGNvbnRhaW5lciA9IG5ld0dhbWVib2FyZENvbnRhaW5lckRPTShwbGF5ZXJOYW1lKTtcbiAgICBtb2RlID09PSAnUExBQ0UnID8gJG1vZGFsLmFwcGVuZENoaWxkKCRjb250YWluZXIpOiAkZ2FtZWJvYXJkc0NvbnRhaW5lci5hcHBlbmRDaGlsZCgkY29udGFpbmVyKTtcbiAgICBpZiAoaXNBY3RpdmUpICRjb250YWluZXIuZmlyc3RDaGlsZC5jbGFzc0xpc3QuYWRkKCdhY3RpdmUnKTtcbiAgICBib2FyZC5mb3JFYWNoKGNlbGwgPT4gJGNvbnRhaW5lci5maXJzdENoaWxkLmFwcGVuZENoaWxkKG5ld0NlbGxET00oY2VsbCkpKTtcbiAgfVxuXG4gIGNvbnN0IG5ld1NoaXBET00gPSAoc2hpcCwgaXNQbGFjZWQgPSBmYWxzZSkgPT4ge1xuICAgIGNvbnN0ICRzaGlwQ29udGFpbmVyID0gY3JlYXRlSHRtbEVsZW1lbnQoJ2RpdicsIFsnc2hpcC1jb250YWluZXInXSk7XG4gICAgaWYgKHNoaXAuaXNTdW5rKCkgfHwgKG1vZGUgPT09ICdQTEFDRScgJiYgaXNQbGFjZWQpKSAkc2hpcENvbnRhaW5lci5jbGFzc0xpc3QuYWRkKCdzdW5rJyk7XG4gICAgJHNoaXBDb250YWluZXIuYXBwZW5kQ2hpbGQoY3JlYXRlSHRtbEVsZW1lbnQoJ2RpdicsIFsnc2hpcC1uYW1lJ10sIHNoaXAubmFtZSkpO1xuICAgIGNvbnN0ICRzaGlwQm9keSA9IGNyZWF0ZUh0bWxFbGVtZW50KCdkaXYnLCBbJ3NoaXAtYm9keSddKTtcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHNoaXAuZ2V0TGVuZ3RoKCk7IGkrKykge1xuICAgICAgJHNoaXBCb2R5LmFwcGVuZENoaWxkKGNyZWF0ZUh0bWxFbGVtZW50KCdkaXYnLCBbJ3NoaXAtY2VsbCddKSk7XG4gICAgfVxuICAgICRzaGlwQ29udGFpbmVyLmFwcGVuZENoaWxkKCRzaGlwQm9keSk7XG4gICAgcmV0dXJuICRzaGlwQ29udGFpbmVyO1xuICB9XG5cbiAgY29uc3QgdXBkYXRlU2hpcHNEaXNwbGF5ID0gKHBsYXllck5hbWUsIHNoaXBzLCBzaGlwTnVtID0gLTEpID0+IHtcbiAgICBjb25zdCAkc2hpcHNEaXNwbGF5ID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcihgLiR7cGxheWVyTmFtZX1gKS5uZXh0RWxlbWVudFNpYmxpbmc7XG4gICAgJHNoaXBzRGlzcGxheS50ZXh0Q29udGVudCA9ICcnO1xuICAgIHNoaXBzLmZvckVhY2goKHNoaXAsIGluZGV4KSA9PiB7XG4gICAgICAkc2hpcHNEaXNwbGF5LmFwcGVuZENoaWxkKG5ld1NoaXBET00oc2hpcCwgaW5kZXggPD0gc2hpcE51bSkpO1xuICAgIH0pO1xuICB9XG5cbiAgY29uc3Qgc2hvd1dpbm5lciA9IChwbGF5ZXJEaXNwbGF5TmFtZSkgPT4ge1xuICAgICR3aW5Nb2RhbC5maXJzdENoaWxkLnRleHRDb250ZW50ID0gYCR7cGxheWVyRGlzcGxheU5hbWV9IHdpbnNgO1xuICAgICR3aW5Nb2RhbC5jbGFzc0xpc3QuYWRkKCd2aXNpYmxlJyk7XG4gIH1cblxuICByZXR1cm4ge1xuICAgIHJlbmRlckdhbWVib2FyZCxcbiAgICB1cGRhdGVTaGlwc0Rpc3BsYXksXG4gICAgY2VsbEhpdCxcbiAgICBzaGlwU3VuayxcbiAgICB0b2dnbGVBY3RpdmVCb2FyZCxcbiAgICBzaG93V2lubmVyLFxuICB9O1xuXG59KSgpO1xuXG5leHBvcnQgZGVmYXVsdCBVSTsiLCJjb25zdCBTaGlwID0gKGxlbmd0aCwgbmFtZSkgPT4ge1xuICBjb25zdCBzaGlwTGVuZ3RoID0gbGVuZ3RoO1xuICBsZXQgaGl0Q291bnQgPSAwO1xuXG4gIC8vIEdldHRlcnNcbiAgY29uc3QgZ2V0TGVuZ3RoID0gKCkgPT4gc2hpcExlbmd0aDtcbiAgY29uc3QgZ2V0SGl0cyA9ICgpID0+IGhpdENvdW50O1xuXG4gIGNvbnN0IGhpdCA9ICgpID0+IHtcbiAgICBoaXRDb3VudCsrO1xuICB9XG5cbiAgY29uc3QgaXNTdW5rID0gKCkgPT4ge1xuICAgIHJldHVybiBoaXRDb3VudCA+PSBzaGlwTGVuZ3RoO1xuICB9XG5cbiAgcmV0dXJuIHtcbiAgICBuYW1lLFxuICAgIGdldExlbmd0aCxcbiAgICBnZXRIaXRzLFxuICAgIGhpdCxcbiAgICBpc1N1bmssXG4gIH07XG59XG5cbmV4cG9ydCBkZWZhdWx0IFNoaXA7IiwiaW1wb3J0IFBsYXllciBmcm9tIFwiLi4vRmFjdG9yaWVzL1BsYXllclwiO1xuaW1wb3J0IFNoaXAgZnJvbSBcIi4uL0ZhY3Rvcmllcy9TaGlwXCI7XG5cbmNvbnN0IEFJID0gKCgpID0+IHtcblxuICBjb25zdCBBSXBsYXllciA9IFBsYXllcignQUknKTtcbiAgY29uc3Qgc2hpcHMgPSBbU2hpcCg1LCAnQ2FycmllcicpLCBTaGlwKDQsICdCYXR0bGVzaGlwJyksIFNoaXAoMywgJ0NydWlzZXInKSwgU2hpcCgzLCAnU3VibWFyaW5lJyksIFNoaXAoMiwgJ0Rlc3Ryb3llcicpXTtcbiAgbGV0IHByZXZTaGlwSGl0ID0gbnVsbDtcblxuICBjb25zdCBwbGFjZVNoaXBzID0gKCkgPT4ge1xuICAgIEFJcGxheWVyLmdhbWVib2FyZC5zZXRTaGlwKHNoaXBzWzBdLCB7IHg6IDAsIHk6IDAgfSwgJ3gnKTtcbiAgICBBSXBsYXllci5nYW1lYm9hcmQuc2V0U2hpcChzaGlwc1sxXSwgeyB4OiA5LCB5OiA2IH0sICd5Jyk7XG4gICAgQUlwbGF5ZXIuZ2FtZWJvYXJkLnNldFNoaXAoc2hpcHNbMl0sIHsgeDogMSwgeTogNyB9LCAneScpO1xuICAgIEFJcGxheWVyLmdhbWVib2FyZC5zZXRTaGlwKHNoaXBzWzNdLCB7IHg6IDcsIHk6IDEgfSwgJ3gnKTtcbiAgICBBSXBsYXllci5nYW1lYm9hcmQuc2V0U2hpcChzaGlwc1s0XSwgeyB4OiA0LCB5OiAzIH0sICd4Jyk7XG4gIH1cblxuICBjb25zdCBnZXRSYW5kb21WYWxpZENvb3JkcyA9ICgpID0+IHtcbiAgICBjb25zdCBib2FyZCA9IEFJcGxheWVyLmdhbWVib2FyZC5nZXRCb2FyZCgpO1xuICAgIGNvbnN0IHZhbGlkQ2VsbHMgPSBib2FyZC5maWx0ZXIoY2VsbCA9PiAhY2VsbC5pc1Nob3QpO1xuICAgIGNvbnN0IGNvb3JkcyA9IHZhbGlkQ2VsbHNbTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogdmFsaWRDZWxscy5sZW5ndGgpXS5jb29yZHM7XG4gICAgcmV0dXJuIGNvb3JkcztcbiAgfVxuXG4gIGZ1bmN0aW9uIHNodWZmbGVGaXNoZXJZYXRlcyhhcnJheSkge1xuICAgIGxldCBpID0gYXJyYXkubGVuZ3RoO1xuICAgIHdoaWxlIChpLS0pIHtcbiAgICAgIGNvbnN0IHJpID0gTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogaSk7XG4gICAgICBbYXJyYXlbaV0sIGFycmF5W3JpXV0gPSBbYXJyYXlbcmldLCBhcnJheVtpXV07XG4gICAgfVxuICAgIHJldHVybiBhcnJheTtcbiAgfVxuXG4gIGNvbnN0IHN1bSA9IChvYmoxLCBvYmoyLCBzdWJ0cmFjdCA9IGZhbHNlKSA9PiB7XG4gICAgcmV0dXJuIE9iamVjdC5rZXlzKG9iajEpLnJlZHVjZSgoYWNjdW11bGF0b3IsIGtleSkgPT4gXG4gICAgICAgICAgKHsuLi5hY2N1bXVsYXRvciwgW2tleV06IG9iajFba2V5XSArIChzdWJ0cmFjdCA/IC0xOiAxKSAqIG9iajJba2V5XX0pLCBcbiAgICAgICAgICB7fSk7XG4gIH1cblxuICBjb25zdCB0cmFjZUxhc3RTaGlwSGl0ID0gKCkgPT4ge1xuICAgIGNvbnN0IGFkamFjZW50Q29vcmRzID0gc2h1ZmZsZUZpc2hlcllhdGVzKEFJcGxheWVyLmdhbWVib2FyZC5nZXRWYWxpZEFkamFjZW50Q29vcmRzKHByZXZTaGlwSGl0KSk7XG4gICAgZm9yIChjb25zdCBjb29yZHMgb2YgYWRqYWNlbnRDb29yZHMpIHtcbiAgICAgIGxldCBjZWxsID0gQUlwbGF5ZXIuZ2FtZWJvYXJkLmF0KGNvb3Jkcyk7XG4gICAgICBpZiAoY2VsbC5pc1Nob3QgJiYgY2VsbC5oYXNTaGlwKSB7XG4gICAgICAgIGxldCBuZXdDb29yZHMgPSB7Li4uY29vcmRzfTtcbiAgICAgICAgbGV0IGRpcmVjdGlvbiA9IHN1bShuZXdDb29yZHMsIHByZXZTaGlwSGl0LCB0cnVlKTtcbiAgICAgICAgd2hpbGUgKGNlbGwuaXNTaG90ICYmIGNlbGwuaGFzU2hpcCkge1xuICAgICAgICAgIG5ld0Nvb3JkcyA9IHN1bShuZXdDb29yZHMsIGRpcmVjdGlvbik7XG4gICAgICAgICAgaWYgKG5ld0Nvb3Jkcy54IDwgMCB8fCBuZXdDb29yZHMueCA+IDkgfHwgbmV3Q29vcmRzLnkgPCAwIHx8IG5ld0Nvb3Jkcy55ID4gOSkgYnJlYWs7XG4gICAgICAgICAgY2VsbCA9IEFJcGxheWVyLmdhbWVib2FyZC5hdChuZXdDb29yZHMpO1xuICAgICAgICB9XG4gICAgICAgIGlmIChjZWxsLmlzU2hvdCkge1xuICAgICAgICAgIHJldHVybiBzdW0ocHJldlNoaXBIaXQsIGRpcmVjdGlvbiwgdHJ1ZSk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIG5ld0Nvb3JkcztcbiAgICAgIH1cbiAgICB9XG4gICAgZm9yIChjb25zdCBjb29yZHMgb2YgYWRqYWNlbnRDb29yZHMpIHtcbiAgICAgIGxldCBjZWxsID0gQUlwbGF5ZXIuZ2FtZWJvYXJkLmF0KGNvb3Jkcyk7XG4gICAgICBpZiAoY2VsbC5pc1Nob3QpIGNvbnRpbnVlO1xuICAgICAgZWxzZSByZXR1cm4gY29vcmRzO1xuICAgIH1cbiAgfVxuXG4gIGNvbnN0IGdldENvb3JkcyA9IChnYW1lYm9hcmQpID0+IHtcbiAgICBsZXQgY29vcmRzO1xuICAgIEFJcGxheWVyLmdhbWVib2FyZCA9IGdhbWVib2FyZDtcbiAgICBpZiAocHJldlNoaXBIaXQpIHtcbiAgICAgIC8vIGlmIHByZXYgaGl0IHN1bmsgYSBzaGlwIHRoZW4gcmVzZXRcbiAgICAgIGlmIChBSXBsYXllci5nYW1lYm9hcmRcbiAgICAgIC5nZXRTaGlwcygpXG4gICAgICAuZmluZChzaGlwID0+IHNoaXAubmFtZSA9PT0gQUlwbGF5ZXIuZ2FtZWJvYXJkLmF0KHByZXZTaGlwSGl0KS5oYXNTaGlwKVxuICAgICAgLmlzU3VuaygpKSB7XG4gICAgICAgIHByZXZTaGlwSGl0ID0gbnVsbDtcbiAgICAgICAgY29vcmRzID0gZ2V0UmFuZG9tVmFsaWRDb29yZHMoKTtcbiAgICAgIH0gZWxzZSBjb29yZHMgPSB0cmFjZUxhc3RTaGlwSGl0KCk7XG4gICAgfSBlbHNlIGNvb3JkcyA9IGdldFJhbmRvbVZhbGlkQ29vcmRzKCk7XG4gICAgaWYgKEFJcGxheWVyLmdhbWVib2FyZC5pc1NoaXBIaXQoY29vcmRzKSkgcHJldlNoaXBIaXQgPSBjb29yZHM7XG4gICAgcmV0dXJuIGNvb3JkcztcbiAgfTtcblxuICBjb25zdCBnZXRBSVBsYXllciA9ICgpID0+IHtcbiAgICBwbGFjZVNoaXBzKCk7XG4gICAgcmV0dXJuIEFJcGxheWVyO1xuICB9XG5cbiAgcmV0dXJuIHtcbiAgICBnZXRDb29yZHMsXG4gICAgZ2V0QUlQbGF5ZXIsXG4gIH07XG5cbn0pKCk7XG5cbmV4cG9ydCBkZWZhdWx0IEFJOyIsImltcG9ydCBQbGF5ZXIgZnJvbSBcIi4uL0ZhY3Rvcmllcy9QbGF5ZXJcIjtcbmltcG9ydCBVSSBmcm9tIFwiLi9VSVwiO1xuaW1wb3J0IFBsYWNlU2hpcHMgZnJvbSBcIi4vUGxhY2VTaGlwc1wiO1xuaW1wb3J0IEFJIGZyb20gXCIuL0FJUGxheWVyXCI7XG5cbmNvbnN0IEdhbWVDb250cm9sbGVyID0gKCgpID0+IHtcblxuICBjb25zdCBwbGF5ZXIxID0gUGxheWVyKCdQMScsICdQbGF5ZXInKTtcbiAgY29uc3QgcGxheWVyMiA9IFBsYXllcignUDInLCAnRW5lbXknKTtcblxuICBmdW5jdGlvbiBzbGVlcChtcykge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZShyZXNvbHZlID0+IHNldFRpbWVvdXQocmVzb2x2ZSwgbXMpKTtcbiAgfSBcblxuICBjb25zdCBvcHBvbmVudCA9ICgpID0+IHtcbiAgICByZXR1cm4gcGxheWVyMS5pc0FjdGl2ZSA/IHBsYXllcjI6IHBsYXllcjE7XG4gIH1cblxuICBjb25zdCBhY3RpdmVQbGF5ZXIgPSAoKSA9PiB7XG4gICAgcmV0dXJuIHBsYXllcjEuaXNBY3RpdmUgPyBwbGF5ZXIxOiBwbGF5ZXIyO1xuICB9XG5cbiAgY29uc3QgdG9nZ2xlQWN0aXZlUGxheWVyID0gKCkgPT4ge1xuICAgIHBsYXllcjEuaXNBY3RpdmUgPSAhcGxheWVyMS5pc0FjdGl2ZTtcbiAgICBwbGF5ZXIyLmlzQWN0aXZlID0gIXBsYXllcjIuaXNBY3RpdmU7XG4gICAgVUkudG9nZ2xlQWN0aXZlQm9hcmQoKTtcbiAgfVxuXG4gIGNvbnN0IGluaXRQbGF5ZXIxID0gKCkgPT4ge1xuICAgIHBsYXllcjEuaXNBY3RpdmUgPSB0cnVlO1xuICAgIHBsYXllcjEuZ2FtZWJvYXJkID0gUGxhY2VTaGlwcy5nZXRTYW1wbGVQbGF5ZXIoKS5nYW1lYm9hcmQ7XG4gICAgVUkucmVuZGVyR2FtZWJvYXJkKHBsYXllcjEubmFtZSwgcGxheWVyMS5nYW1lYm9hcmQuZ2V0Qm9hcmQoKSk7XG4gICAgVUkudXBkYXRlU2hpcHNEaXNwbGF5KHBsYXllcjEubmFtZSwgcGxheWVyMS5nYW1lYm9hcmQuZ2V0U2hpcHMoKSk7XG4gIH1cblxuICBjb25zdCBpbml0UGxheWVyMiA9ICgpID0+IHtcbiAgICBwbGF5ZXIyLmlzQWN0aXZlID0gZmFsc2U7XG4gICAgcGxheWVyMi5nYW1lYm9hcmQgPSBBSS5nZXRBSVBsYXllcigpLmdhbWVib2FyZDtcbiAgICBVSS5yZW5kZXJHYW1lYm9hcmQocGxheWVyMi5uYW1lLCBwbGF5ZXIyLmdhbWVib2FyZC5nZXRCb2FyZCgpLCB0cnVlKTtcbiAgICBVSS51cGRhdGVTaGlwc0Rpc3BsYXkocGxheWVyMi5uYW1lLCBwbGF5ZXIyLmdhbWVib2FyZC5nZXRTaGlwcygpKTtcblxuICB9XG5cbiAgY29uc3QgcGxheVR1cm4gPSBhc3luYyAoY29vcmRzKSA9PiB7XG4gICAgY29uc3Qgb3Bwb25lbnRCb2FyZCA9IG9wcG9uZW50KCkuZ2FtZWJvYXJkO1xuICAgIGlmICghb3Bwb25lbnRCb2FyZC5pc1ZhbGlkQXR0YWNrKGNvb3JkcykpIHJldHVybjtcblxuICAgIG9wcG9uZW50Qm9hcmQucmVjZWl2ZUF0dGFjayhjb29yZHMpO1xuICAgIFVJLmNlbGxIaXQoY29vcmRzKTtcbiAgICBcbiAgICBpZiAoIW9wcG9uZW50Qm9hcmQuaXNTaGlwSGl0KGNvb3JkcykpIHtcbiAgICAgIGF3YWl0IHNsZWVwKDMwMCk7XG4gICAgICB0b2dnbGVBY3RpdmVQbGF5ZXIoKTtcbiAgICB9IGVsc2Uge1xuICAgICAgVUkudXBkYXRlU2hpcHNEaXNwbGF5KG9wcG9uZW50KCkubmFtZSwgb3Bwb25lbnRCb2FyZC5nZXRTaGlwcygpKTtcbiAgICAgIGNvbnN0IHNoaXAgPSBvcHBvbmVudEJvYXJkLmdldFNoaXBCeUNvb3Jkcyhjb29yZHMpO1xuICAgICAgaWYoc2hpcC5pc1N1bmsoKSkge1xuICAgICAgICBVSS5zaGlwU3VuayhvcHBvbmVudEJvYXJkLmdldFNoaXBDb29yZHNBcnJheShzaGlwKSk7XG4gICAgICAgIGlmIChvcHBvbmVudEJvYXJkLmFsbFNoaXBzU3VuaygpKSB7XG4gICAgICAgICAgVUkuc2hvd1dpbm5lcihhY3RpdmVQbGF5ZXIoKS5kaXNwbGF5TmFtZSk7XG4gICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICAgIHBsYXlHYW1lKCk7XG4gIH1cblxuICBjb25zdCBwbGF5R2FtZSA9IGFzeW5jICgpID0+IHtcbiAgICBpZiAocGxheWVyMi5pc0FjdGl2ZSkge1xuICAgICAgYXdhaXQgc2xlZXAoTWF0aC5yYW5kb20oKSozMDAgKyAzMDApO1xuICAgICAgcGxheVR1cm4oQUkuZ2V0Q29vcmRzKG9wcG9uZW50KCkuZ2FtZWJvYXJkKSk7XG4gICAgfVxuICB9XG5cbiAgY29uc3QgaW5pdCA9ICgpID0+IHtcbiAgICBpbml0UGxheWVyMSgpO1xuICAgIGluaXRQbGF5ZXIyKCk7XG4gIH07XG5cbiAgcmV0dXJuIHtcbiAgICBpbml0LFxuICAgIHBsYXlUdXJuLFxuICB9O1xuXG59KSgpO1xuXG5leHBvcnQgZGVmYXVsdCBHYW1lQ29udHJvbGxlcjsiLCJpbXBvcnQgR2FtZUNvbnRyb2xsZXIgZnJvbSBcIi4vR2FtZUNvbnRyb2xsZXJcIjtcbmltcG9ydCBQbGF5ZXIgZnJvbSBcIi4uL0ZhY3Rvcmllcy9QbGF5ZXJcIjtcbmltcG9ydCBTaGlwIGZyb20gXCIuLi9GYWN0b3JpZXMvU2hpcFwiO1xuaW1wb3J0IFVJIGZyb20gXCIuL1VJXCI7XG5cbmNvbnN0IFBsYWNlU2hpcHMgPSAoKCkgPT4ge1xuICBjb25zdCBwbGF5ZXIgPSBQbGF5ZXIoJ3NhbXBsZScpO1xuICBjb25zdCBzaGlwcyA9IFtTaGlwKDUsICdDYXJyaWVyJyksIFNoaXAoNCwgJ0JhdHRsZXNoaXAnKSwgU2hpcCgzLCAnQ3J1aXNlcicpLCBTaGlwKDMsICdTdWJtYXJpbmUnKSwgU2hpcCgyLCAnRGVzdHJveWVyJyldO1xuICBsZXQgY3VycmVudCA9IHtcbiAgICBzaGlwTnVtOiAwLFxuICAgIHNoaXBDb29yZHNBcnJheTogW10sXG4gICAgYXhpczogJ3gnXG4gIH07XG4gIGNvbnN0ICRtb2RhbCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJy5tb2RhbCcpO1xuICBjb25zdCAkcGxheUJ1dHRvbiA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJ2J1dHRvbi5wbGF5Jyk7XG4gIGNvbnN0ICRyZXNldEJ1dHRvbiA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJ2J1dHRvbi5yZXNldCcpO1xuXG4gIC8vIFV0aWwgXG5cbiAgY29uc3QgY2VsbEF0ID0gKGNvb3JkcykgPT4ge1xuICAgIHJldHVybiBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKGBbZGF0YS1jb29yZHM9XCIke2Nvb3Jkcy54fSAke2Nvb3Jkcy55fVwiXWApO1xuICB9XG5cbiAgLy8gRE9NXG5cbiAgY29uc3Qgc2hvd1NoaXAgPSAoY29vcmRzKSA9PiB7XG4gICAgaWYgKGN1cnJlbnQuc2hpcE51bSA+PSBzaGlwcy5sZW5ndGgpIHJldHVybjtcbiAgICBpZiAoY3VycmVudC5zaGlwQ29vcmRzQXJyYXkubGVuZ3RoICE9PSAwKSB7XG4gICAgICBjdXJyZW50LnNoaXBDb29yZHNBcnJheS5mb3JFYWNoKGNvb3JkcyA9PiB7XG4gICAgICAgIGNlbGxBdChjb29yZHMpLmNsYXNzTGlzdC5yZW1vdmUoJ3RlbXAnKTtcbiAgICAgICAgY2VsbEF0KGNvb3JkcykuY2xhc3NMaXN0LnJlbW92ZSgnaW52YWxpZCcpO1xuICAgICAgfSlcbiAgICB9XG4gICAgY3VycmVudC5zaGlwQ29vcmRzQXJyYXkgPSBtYWtlU2hpcChjb29yZHMpO1xuICAgIGN1cnJlbnQuc2hpcENvb3Jkc0FycmF5LmZvckVhY2goY29vcmRzID0+IHtcbiAgICAgIGNlbGxBdChjb29yZHMpLmNsYXNzTGlzdC5hZGQoXCJ0ZW1wXCIpO1xuICAgIH0pXG4gICAgaWYgKCFpc1NoaXBWYWxpZCgpKSB7XG4gICAgICBjdXJyZW50LnNoaXBDb29yZHNBcnJheS5mb3JFYWNoKGNvb3JkcyA9PiB7XG4gICAgICAgIGNlbGxBdChjb29yZHMpLmNsYXNzTGlzdC5hZGQoXCJpbnZhbGlkXCIpO1xuICAgICAgfSlcbiAgICB9XG4gIH1cblxuICBjb25zdCBtYWtlU2hpcCA9IChjb29yZHMpID0+IHtcbiAgICBsZXQgc2hpcENvb3Jkc0FycmF5ID0gW107XG4gICAgbGV0IG5ld0Nvb3JkcyA9IGNvb3JkcztcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHNoaXBzW2N1cnJlbnQuc2hpcE51bV0uZ2V0TGVuZ3RoKCk7IGkrKykge1xuICAgICAgc2hpcENvb3Jkc0FycmF5LnB1c2goe3g6IG5ld0Nvb3Jkcy54LCB5OiBuZXdDb29yZHMueX0pO1xuICAgICAgY3VycmVudC5heGlzID09PSAneCcgPyBuZXdDb29yZHMueCsrOiBuZXdDb29yZHMueSsrO1xuICAgICAgaWYgKG5ld0Nvb3Jkcy54ID4gOSB8fCBuZXdDb29yZHMueSA+IDkpIGJyZWFrO1xuICAgIH1cbiAgICByZXR1cm4gc2hpcENvb3Jkc0FycmF5O1xuICB9XG5cbiAgY29uc3QgaXNTaGlwVmFsaWQgPSAoKSA9PiB7XG4gICAgcmV0dXJuICghcGxheWVyLmdhbWVib2FyZC5pc0NvbGxpc2lvbnMoY3VycmVudC5zaGlwQ29vcmRzQXJyYXkpICYmIFxuICAgICAgICAgIGN1cnJlbnQuc2hpcENvb3Jkc0FycmF5Lmxlbmd0aCA9PT0gc2hpcHNbY3VycmVudC5zaGlwTnVtXS5nZXRMZW5ndGgoKSk7XG4gIH1cblxuICBcbiAgY29uc3QgcGxhY2VTaGlwID0gKGNvb3JkcykgPT4ge1xuICAgIGlmICghaXNTaGlwVmFsaWQoKSkgcmV0dXJuO1xuICAgIHBsYXllci5nYW1lYm9hcmQuc2V0U2hpcChzaGlwc1tjdXJyZW50LnNoaXBOdW0rK10sIGNvb3JkcywgY3VycmVudC5heGlzKTtcbiAgICBjdXJyZW50LnNoaXBDb29yZHNBcnJheS5mb3JFYWNoKGNvb3JkcyA9PiB7XG4gICAgICBjZWxsQXQoY29vcmRzKS5jbGFzc0xpc3QuYWRkKCdzaGlwJyk7XG4gICAgICBjZWxsQXQoY29vcmRzKS5jbGFzc0xpc3QucmVtb3ZlKCd0ZW1wJyk7XG4gICAgfSk7XG4gICAgVUkudXBkYXRlU2hpcHNEaXNwbGF5KHBsYXllci5uYW1lLCBzaGlwcywgY3VycmVudC5zaGlwTnVtIC0gMSk7XG4gICAgaWYgKGN1cnJlbnQuc2hpcE51bSA9PT0gc2hpcHMubGVuZ3RoKSB7XG4gICAgICAkcGxheUJ1dHRvbi5zdHlsZS5kaXNwbGF5ID0gJ2Jsb2NrJztcbiAgICB9XG4gIH1cblxuICBjb25zdCByZXNldCA9ICgpID0+IHtcbiAgICBwbGF5ZXIuZ2FtZWJvYXJkLnJlc2V0KCk7XG4gICAgcGxheWVyLmdhbWVib2FyZC5nZXRCb2FyZCgpLmZvckVhY2goY2VsbCA9PiB7XG4gICAgICBjZWxsQXQoY2VsbC5jb29yZHMpLmNsYXNzTGlzdC5yZW1vdmUoJ3NoaXAnKTtcbiAgICAgIGNlbGxBdChjZWxsLmNvb3JkcykuY2xhc3NMaXN0LnJlbW92ZSgndGVtcCcpO1xuICAgICAgY2VsbEF0KGNlbGwuY29vcmRzKS5jbGFzc0xpc3QucmVtb3ZlKCdpbnZhbGlkJyk7XG4gICAgfSk7XG4gICAgY29uc3QgJHNoaXBDb250YWluZXJzID0gQXJyYXkuZnJvbShkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcuc2hpcHMtZGlzcGxheScpLmNoaWxkcmVuKTtcbiAgICAkc2hpcENvbnRhaW5lcnMuZm9yRWFjaCgkc2hpcENvbnRhaW5lciA9PiAkc2hpcENvbnRhaW5lci5jbGFzc0xpc3QucmVtb3ZlKCdzdW5rJykpO1xuICAgIGN1cnJlbnQgPSB7XG4gICAgICBzaGlwTnVtOiAwLFxuICAgICAgc2hpcENvb3Jkc0FycmF5OiBbXSxcbiAgICAgIGF4aXM6ICd4J1xuICAgIH07XG4gICAgJHBsYXlCdXR0b24uc3R5bGUuZGlzcGxheSA9ICdub25lJztcbiAgfVxuICBcbiAgY29uc3QgZ2V0U2FtcGxlUGxheWVyID0gKCkgPT4gcGxheWVyO1xuXG4gIGNvbnN0IGluaXQgPSAoKSA9PiB7XG4gICAgVUkucmVuZGVyR2FtZWJvYXJkKHBsYXllci5uYW1lLCBwbGF5ZXIuZ2FtZWJvYXJkLmdldEJvYXJkKCkpO1xuICAgIFVJLnVwZGF0ZVNoaXBzRGlzcGxheShwbGF5ZXIubmFtZSwgc2hpcHMpO1xuXG4gICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigna2V5dXAnLCAoeyBrZXkgfSkgPT4ge1xuICAgICAgaWYgKGtleSA9PT0gJ1InIHx8IGtleSA9PT0gJ3InKSB7XG4gICAgICAgIGN1cnJlbnQuYXhpcyA9IGN1cnJlbnQuYXhpcyA9PT0gJ3gnID8gJ3knOiAneCc7XG4gICAgICAgIHNob3dTaGlwKGN1cnJlbnQuc2hpcENvb3Jkc0FycmF5WzBdLCBjdXJyZW50LmF4aXMpO1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgJHBsYXlCdXR0b24uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoKSA9PiB7XG4gICAgICAkbW9kYWwucmVtb3ZlKCk7XG4gICAgICBHYW1lQ29udHJvbGxlci5pbml0KCk7XG4gICAgfSlcblxuICAgICRyZXNldEJ1dHRvbi5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIHJlc2V0KTtcbiAgfVxuXG4gIHJldHVybiB7XG4gICAgaW5pdCxcbiAgICBwbGFjZVNoaXAsXG4gICAgc2hvd1NoaXAsXG4gICAgZ2V0U2FtcGxlUGxheWVyLFxuICB9XG5cbn0pKCk7XG5cbmV4cG9ydCBkZWZhdWx0IFBsYWNlU2hpcHM7IiwiLy8gaW1wb3J0IEdhbWVDb250cm9sbGVyIGZyb20gXCIuL01vZHVsZXMvR2FtZUNvbnRyb2xsZXJcIjtcbmltcG9ydCBQbGFjZVNoaXBzIGZyb20gXCIuL01vZHVsZXMvUGxhY2VTaGlwc1wiO1xuXG5QbGFjZVNoaXBzLmluaXQoKTsiXSwibmFtZXMiOlsic2l6ZSIsInNoaXBzIiwic3VuayIsImJvYXJkIiwiYXJyIiwiaSIsInB1c2giLCJjb29yZHMiLCJ4IiwieSIsIk1hdGgiLCJmbG9vciIsImhhc1NoaXAiLCJpc1Nob3QiLCJfbWFrZUdyaWQiLCJhdCIsImdldFZhbGlkQWRqYWNlbnRDb29yZHMiLCJhZGphY2VuY3kiLCJhZGphY2VudENvb3JkcyIsImFkamFjZW50Iiwia2V5IiwibmV3UG9pbnQiLCJpc1ZhbGlkQXR0YWNrIiwiaXNTaGlwSGl0IiwicmVjZWl2ZUF0dGFjayIsImNlbGwiLCJzaGlwTmFtZSIsInNoaXAiLCJmaW5kIiwibmFtZSIsImhpdCIsImlzU3VuayIsInNoaXBIaXQiLCJzZXRTaGlwIiwiYXhpcyIsIm5ld0Nvb3JkcyIsImdldExlbmd0aCIsImdldFNoaXBDb29yZHNBcnJheSIsImZpbHRlciIsIm1hcCIsImlzQ29sbGlzaW9ucyIsInNoaXBDb29yZHNBcnJheSIsInNoaXBDb29yZHMiLCJnZXRTaGlwQnlDb29yZHMiLCJnZXRCb2FyZCIsImdldFNoaXBzIiwicmVzZXQiLCJhbGxTaGlwc1N1bmsiLCJsZW5ndGgiLCJkaXNwbGF5TmFtZSIsImdhbWVib2FyZCIsImlzQWN0aXZlIiwiJGdhbWVib2FyZHNDb250YWluZXIiLCJkb2N1bWVudCIsInF1ZXJ5U2VsZWN0b3IiLCIkbW9kYWwiLCIkd2luTW9kYWwiLCJtb2RlIiwiZGVjb2RlQ29vcmRzIiwiY29vcmRzU3RyaW5nIiwiY29vcmRzQXJyYXkiLCJzcGxpdCIsImNyZWF0ZUh0bWxFbGVtZW50IiwidHlwZSIsImNsYXNzQXJyYXkiLCJ0ZXh0IiwiZWxlbWVudCIsImNyZWF0ZUVsZW1lbnQiLCJmb3JFYWNoIiwiY2xzIiwiY2xhc3NMaXN0IiwiYWRkIiwidGV4dENvbnRlbnQiLCJyZW5kZXJHYW1lYm9hcmQiLCJwbGF5ZXJOYW1lIiwiJGNvbnRhaW5lciIsImFwcGVuZENoaWxkIiwibmV3R2FtZWJvYXJkQ29udGFpbmVyRE9NIiwiZmlyc3RDaGlsZCIsIiRjZWxsIiwic2V0QXR0cmlidXRlIiwiYWRkRXZlbnRMaXN0ZW5lciIsImdldEF0dHJpYnV0ZSIsImFkZENlbGxMaXN0ZW5lciIsIm5ld0NlbGxET00iLCJ1cGRhdGVTaGlwc0Rpc3BsYXkiLCJzaGlwTnVtIiwiJHNoaXBzRGlzcGxheSIsIm5leHRFbGVtZW50U2libGluZyIsImluZGV4IiwiaXNQbGFjZWQiLCIkc2hpcENvbnRhaW5lciIsIiRzaGlwQm9keSIsIm5ld1NoaXBET00iLCJjZWxsSGl0IiwiZW5jb2RlZENvb3JkcyIsInNoaXBTdW5rIiwidG9nZ2xlQWN0aXZlQm9hcmQiLCJBcnJheSIsImZyb20iLCJjaGlsZHJlbiIsIiRnYW1lYm9hcmRDb250YWluZXIiLCJjb250YWlucyIsInRvZ2dsZSIsInNob3dXaW5uZXIiLCJwbGF5ZXJEaXNwbGF5TmFtZSIsInNoaXBMZW5ndGgiLCJoaXRDb3VudCIsImdldEhpdHMiLCJBSXBsYXllciIsInByZXZTaGlwSGl0IiwiZ2V0UmFuZG9tVmFsaWRDb29yZHMiLCJ2YWxpZENlbGxzIiwicmFuZG9tIiwic3VtIiwib2JqMSIsIm9iajIiLCJzdWJ0cmFjdCIsIk9iamVjdCIsImtleXMiLCJyZWR1Y2UiLCJhY2N1bXVsYXRvciIsImdldENvb3JkcyIsImFycmF5IiwicmkiLCJzaHVmZmxlRmlzaGVyWWF0ZXMiLCJkaXJlY3Rpb24iLCJ0cmFjZUxhc3RTaGlwSGl0IiwiZ2V0QUlQbGF5ZXIiLCJwbGF5ZXIxIiwicGxheWVyMiIsInNsZWVwIiwibXMiLCJQcm9taXNlIiwicmVzb2x2ZSIsInNldFRpbWVvdXQiLCJvcHBvbmVudCIsInBsYXlUdXJuIiwiYXN5bmMiLCJvcHBvbmVudEJvYXJkIiwicGxheUdhbWUiLCJpbml0IiwicGxheWVyIiwiY3VycmVudCIsIiRwbGF5QnV0dG9uIiwiJHJlc2V0QnV0dG9uIiwiY2VsbEF0Iiwic2hvd1NoaXAiLCJyZW1vdmUiLCJtYWtlU2hpcCIsImlzU2hpcFZhbGlkIiwic3R5bGUiLCJkaXNwbGF5IiwicGxhY2VTaGlwIiwiZ2V0U2FtcGxlUGxheWVyIl0sInNvdXJjZVJvb3QiOiIifQ==