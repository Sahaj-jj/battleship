(()=>{"use strict";const e=(()=>{const e=document.querySelector(".gameboards-container"),t=document.querySelector(".modal"),s=document.querySelector(".modal-win");let a="PLAY";const r=e=>{const t=e.split(" ");return{x:+t[0],y:+t[1]}},n=(e,t=null,s=null)=>{const a=document.createElement(e);return t&&t.forEach((e=>a.classList.add(e))),s&&(a.textContent=s),a};return{renderGameboard:(s,d,c=!1)=>{a="sample"===s?"PLACE":"PLAY";const h=(e=>{const t=n("div",["container"]);return t.appendChild(n("div",[`${e}`,"board"])),t.appendChild(n("div",["ships-display"])),t})(s);"PLACE"===a?t.appendChild(h):e.appendChild(h),c&&h.firstChild.classList.add("active"),d.forEach((e=>h.firstChild.appendChild((e=>{const t=n("div",["cell"]);return t.setAttribute("data-coords",`${e.coords.x} ${e.coords.y}`),e.hasShip&&t.classList.add("ship"),(e=>{"PLACE"===a?(e.addEventListener("click",(()=>{o.placeShip(r(e.getAttribute("data-coords")))})),e.addEventListener("mouseover",(()=>{o.showShip(r(e.getAttribute("data-coords")))}))):e.addEventListener("click",(()=>{i.playTurn(r(e.getAttribute("data-coords")))}))})(t),t})(e))))},updateShipsDisplay:(e,t,s=-1)=>{const r=document.querySelector(`.${e}`).nextElementSibling;r.textContent="",t.forEach(((e,t)=>{r.appendChild(((e,t=!1)=>{const s=n("div",["ship-container"]);(e.isSunk()||"PLACE"===a&&t)&&s.classList.add("sunk"),s.appendChild(n("div",["ship-name"],e.name));const r=n("div",["ship-body"]);for(let t=0;t<e.getLength();t++)r.appendChild(n("div",["ship-cell"]));return s.appendChild(r),s})(e,t<=s))}))},cellHit:e=>{const t=`${e.x} ${e.y}`;document.querySelector(`.active > [data-coords="${t}"]`).classList.add("hit")},shipSunk:e=>{e.forEach((e=>{document.querySelector(`.active > [data-coords="${e.x} ${e.y}"]`).classList.add("sunk")}))},toggleActiveBoard:()=>{Array.from(e.children).forEach((e=>{e.classList.contains("container")&&e.firstChild.classList.toggle("active")}))},showWinner:e=>{s.firstChild.textContent=`${e} wins`,s.classList.add("visible")}}})(),t=t=>{let s=[],a=0;const r=(e=>{const t=[];for(let s=0;s<e*e;s++)t.push({coords:{x:s%e,y:Math.floor(s/e)},hasShip:"",isShot:!1});return t})(t),i=e=>r[e.x+e.y*t];return{at:i,isValidAttack:e=>!i(e).isShot,isShipHit:e=>""!==i(e).hasShip,receiveAttack:t=>{const o=i(t);if(o.isShot=!0,e.cellHit(t),o.hasShip){const t=s.find((e=>e.name===o.hasShip));t.hit(),t.isSunk()&&(t=>{a++;const s=r.filter((e=>e.hasShip===t)).map((e=>e.coords));e.shipSunk(s)})(t.name)}},setShip:(e,t,a="x")=>{s.push(e);let r=t;for(let t=0;t<e.getLength();t++)i(r).hasShip=e.name,"x"===a?r.x++:r.y++},isCollisions:e=>{for(const a of e){if(a.x>t-1||a.y>t-1)return!0;if(""!==i(a).hasShip)return!0;const e=[{x:(s=a).x+1,y:s.y},{x:s.x-1,y:s.y},{x:s.x,y:s.y+1},{x:s.x,y:s.y-1}];for(const s of e)if(!(s.x>t-1||s.x<0||s.y>t-1||s.y<0)&&""!==i(s).hasShip)return!0}var s;return!1},getBoard:()=>r,getShips:()=>s,reset:()=>{s=[];for(const e of r)e.isShot=!1,e.hasShip=""},allShipsSunk:()=>a>=s.length}},s=(e,s)=>({name:e,displayName:s,gameboard:t(10),isActive:!1}),a=(e,t)=>{const s=e;let a=0;return{name:t,getLength:()=>s,getHits:()=>a,hit:()=>{a++},isSunk:()=>a>=s}},r=(()=>{const e=s("AI"),t=[a(5,"Carrier"),a(4,"Battleship"),a(3,"Cruiser"),a(3,"Submarine"),a(2,"Destroyer")];let r=null;const i=()=>{const t=e.gameboard.getBoard().filter((e=>!e.isShot));return t[Math.floor(Math.random()*t.length)].coords},o=(e,t,s=!1)=>Object.keys(e).reduce(((a,r)=>({...a,[r]:e[r]+(s?-1:1)*t[r]})),{});return{getCoords:t=>{let s;return e.gameboard=t,r?e.gameboard.getShips().find((t=>t.name===e.gameboard.at(r).hasShip)).isSunk()?(r=null,s=i()):s=(()=>{const t=function(e){let t=e.length;for(;t--;){const s=Math.floor(Math.random()*t);[e[t],e[s]]=[e[s],e[t]]}return e}((e=>{const t=[-1,1];let s=[];for(const a of t)for(const t in e){const r=e[t]+a;r<=9&&r>=0&&s.push({...e,[t]:r})}return s})(r));for(const s of t){let t=e.gameboard.at(s);if(t.isShot&&t.hasShip){let a={...s},i=o(a,r,!0);for(;t.isShot&&t.hasShip&&(a=o(a,i),!(a.x<0||a.x>9||a.y<0||a.y>9));)t=e.gameboard.at(a);return t.isShot?o(r,i,!0):a}}for(const s of t)if(!e.gameboard.at(s).isShot)return s})():s=i(),e.gameboard.isShipHit(s)&&(r=s),s},getAIPlayer:()=>(e.gameboard.setShip(t[0],{x:0,y:0},"x"),e.gameboard.setShip(t[1],{x:9,y:6},"y"),e.gameboard.setShip(t[2],{x:1,y:7},"y"),e.gameboard.setShip(t[3],{x:7,y:1},"x"),e.gameboard.setShip(t[4],{x:4,y:3},"x"),e)}})(),i=(()=>{const t=s("P1","Player"),a=s("P2","Enemy");function i(e){return new Promise((t=>setTimeout(t,e)))}const n=()=>t.isActive?a:t,d=async s=>{const r=n().gameboard;if(r.isValidAttack(s)){if(r.receiveAttack(s),r.isShipHit(s)){if(e.updateShipsDisplay(n().name,r.getShips()),r.allShipsSunk())return void e.showWinner((t.isActive?t:a).displayName)}else await i(300),t.isActive=!t.isActive,a.isActive=!a.isActive,e.toggleActiveBoard();c()}},c=async()=>{a.isActive&&(await i(300*Math.random()+300),d(r.getCoords(n().gameboard)))};return{init:()=>{t.isActive=!0,t.gameboard=o.getSamplePlayer().gameboard,e.renderGameboard(t.name,t.gameboard.getBoard()),e.updateShipsDisplay(t.name,t.gameboard.getShips()),a.isActive=!1,a.gameboard=r.getAIPlayer().gameboard,e.renderGameboard(a.name,a.gameboard.getBoard(),!0),e.updateShipsDisplay(a.name,a.gameboard.getShips())},playTurn:d}})(),o=(()=>{const t=s("sample"),r=[a(5,"Carrier"),a(4,"Battleship"),a(3,"Cruiser"),a(3,"Submarine"),a(2,"Destroyer")];let o={shipNum:0,shipCoordsArray:[],axis:"x"};const n=document.querySelector(".modal"),d=document.querySelector("button.play"),c=document.querySelector("button.reset"),h=e=>document.querySelector(`[data-coords="${e.x} ${e.y}"]`),l=e=>{o.shipNum>=r.length||(0!==o.shipCoordsArray.length&&o.shipCoordsArray.forEach((e=>{h(e).classList.remove("temp"),h(e).classList.remove("invalid")})),o.shipCoordsArray=p(e),o.shipCoordsArray.forEach((e=>{h(e).classList.add("temp")})),m()||o.shipCoordsArray.forEach((e=>{h(e).classList.add("invalid")})))},p=e=>{let t=[],s=e;for(let e=0;e<r[o.shipNum].getLength()&&(t.push({x:s.x,y:s.y}),"x"===o.axis?s.x++:s.y++,!(s.x>9||s.y>9));e++);return t},m=()=>!t.gameboard.isCollisions(o.shipCoordsArray)&&o.shipCoordsArray.length===r[o.shipNum].getLength(),u=()=>{t.gameboard.reset(),t.gameboard.getBoard().forEach((e=>{h(e.coords).classList.remove("ship"),h(e.coords).classList.remove("temp"),h(e.coords).classList.remove("invalid")})),Array.from(document.querySelector(".ships-display").children).forEach((e=>e.classList.remove("sunk"))),o={shipNum:0,shipCoordsArray:[],axis:"x"},d.style.display="none"};return{init:()=>{e.renderGameboard(t.name,t.gameboard.getBoard()),e.updateShipsDisplay(t.name,r),document.addEventListener("keyup",(({key:e})=>{"R"!==e&&"r"!==e||(o.axis="x"===o.axis?"y":"x",l(o.shipCoordsArray[0],o.axis))})),d.addEventListener("click",(()=>{n.remove(),i.init()})),c.addEventListener("click",u)},placeShip:s=>{m()&&(t.gameboard.setShip(r[o.shipNum++],s,o.axis),o.shipCoordsArray.forEach((e=>{h(e).classList.add("ship"),h(e).classList.remove("temp")})),e.updateShipsDisplay(t.name,r,o.shipNum-1),o.shipNum===r.length&&(d.style.display="block"))},showShip:l,getSamplePlayer:()=>t}})();o.init()})();
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWFpbi5qcyIsIm1hcHBpbmdzIjoibUJBR0EsTUFnSEEsRUFoSFcsTUFDVCxNQUFNQSxFQUF1QkMsU0FBU0MsY0FBYyx5QkFDOUNDLEVBQVNGLFNBQVNDLGNBQWMsVUFDaENFLEVBQVlILFNBQVNDLGNBQWMsY0FDekMsSUFBSUcsRUFBTyxPQUVYLE1BQU1DLEVBQWdCQyxJQUNwQixNQUFNQyxFQUFjRCxFQUFhRSxNQUFNLEtBQ3ZDLE1BQU8sQ0FBQ0MsR0FBSUYsRUFBWSxHQUFJRyxHQUFJSCxFQUFZLEtBR3hDSSxFQUFvQixDQUFDQyxFQUFNQyxFQUFhLEtBQU1DLEVBQU8sUUFDekQsTUFBTUMsRUFBVWYsU0FBU2dCLGNBQWNKLEdBR3ZDLE9BRklDLEdBQVlBLEVBQVdJLFNBQVFDLEdBQU9ILEVBQVFJLFVBQVVDLElBQUlGLEtBQzVESixJQUFNQyxFQUFRTSxZQUFjUCxHQUN6QkMsR0FzRlQsTUFBTyxDQUNMTyxnQkFsQ3NCLENBQUNDLEVBQVlDLEVBQU9DLEdBQVcsS0FDckRyQixFQUFzQixXQUFmbUIsRUFBMEIsUUFBUyxPQUMxQyxNQUFNRyxFQVR5QixDQUFDSCxJQUNoQyxNQUFNRyxFQUFhZixFQUFrQixNQUFPLENBQUMsY0FHN0MsT0FGQWUsRUFBV0MsWUFBWWhCLEVBQWtCLE1BQU8sQ0FBQyxHQUFHWSxJQUFjLFdBQ2xFRyxFQUFXQyxZQUFZaEIsRUFBa0IsTUFBTyxDQUFDLG1CQUMxQ2UsR0FLWUUsQ0FBeUJMLEdBQ25DLFVBQVRuQixFQUFtQkYsRUFBT3lCLFlBQVlELEdBQWEzQixFQUFxQjRCLFlBQVlELEdBQ2hGRCxHQUFVQyxFQUFXRyxXQUFXVixVQUFVQyxJQUFJLFVBQ2xESSxFQUFNUCxTQUFRYSxHQUFRSixFQUFXRyxXQUFXRixZQXZEM0IsQ0FBQ0csSUFDaEIsTUFBTUMsRUFBUXBCLEVBQWtCLE1BQU8sQ0FBQyxTQUl4QyxPQUhBb0IsRUFBTUMsYUFBYSxjQUFlLEdBQUdGLEVBQUtHLE9BQU94QixLQUFLcUIsRUFBS0csT0FBT3ZCLEtBQzlEb0IsRUFBS0ksU0FBU0gsRUFBTVosVUFBVUMsSUFBSSxRQUtsQixDQUFDVyxJQUNWLFVBQVQzQixHQUNGMkIsRUFBTUksaUJBQWlCLFNBQVMsS0FDOUIsWUFBcUI5QixFQUFhMEIsRUFBTUssYUFBYSxvQkFHdkRMLEVBQU1JLGlCQUFpQixhQUFhLEtBQ2xDLFdBQW9COUIsRUFBYTBCLEVBQU1LLGFBQWEscUJBR25ETCxFQUFNSSxpQkFBaUIsU0FBUyxLQUNuQyxXQUF3QjlCLEVBQWEwQixFQUFNSyxhQUFhLHFCQWZ4REMsQ0FBZ0JOLEdBQ1RBLEdBa0QrQ08sQ0FBV1IsT0E4Qm5FUyxtQkFmeUIsQ0FBQ2hCLEVBQVlpQixFQUFPQyxHQUFVLEtBQ3ZELE1BQU1DLEVBQWdCMUMsU0FBU0MsY0FBYyxJQUFJc0IsS0FBY29CLG1CQUMvREQsRUFBY3JCLFlBQWMsR0FDNUJtQixFQUFNdkIsU0FBUSxDQUFDMkIsRUFBTUMsS0FDbkJILEVBQWNmLFlBaEJDLEVBQUNpQixFQUFNRSxHQUFXLEtBQ25DLE1BQU1DLEVBQWlCcEMsRUFBa0IsTUFBTyxDQUFDLG9CQUM3Q2lDLEVBQUtJLFVBQXNCLFVBQVQ1QyxHQUFvQjBDLElBQVdDLEVBQWU1QixVQUFVQyxJQUFJLFFBQ2xGMkIsRUFBZXBCLFlBQVloQixFQUFrQixNQUFPLENBQUMsYUFBY2lDLEVBQUtLLE9BQ3hFLE1BQU1DLEVBQVl2QyxFQUFrQixNQUFPLENBQUMsY0FDNUMsSUFBSyxJQUFJd0MsRUFBSSxFQUFHQSxFQUFJUCxFQUFLUSxZQUFhRCxJQUNwQ0QsRUFBVXZCLFlBQVloQixFQUFrQixNQUFPLENBQUMsZUFHbEQsT0FEQW9DLEVBQWVwQixZQUFZdUIsR0FDcEJILEdBT3FCTSxDQUFXVCxFQUFNQyxHQUFTSixRQVl0RGEsUUEvRGVyQixJQUNmLE1BQU1zQixFQUFnQixHQUFHdEIsRUFBT3hCLEtBQUt3QixFQUFPdkIsSUFDOUJWLFNBQVNDLGNBQWMsMkJBQTJCc0QsT0FDMURwQyxVQUFVQyxJQUFJLFFBNkRwQm9DLFNBbERnQmpELElBQ2hCQSxFQUFZVSxTQUFRZ0IsSUFDbEJqQyxTQUFTQyxjQUFjLDJCQUEyQmdDLEVBQU94QixLQUFLd0IsRUFBT3ZCLE9BQU9TLFVBQVVDLElBQUksWUFpRDVGcUMsa0JBM0R3QixLQUNLQyxNQUFNQyxLQUFLNUQsRUFBcUI2RCxVQUN4QzNDLFNBQVE0QyxJQUN2QkEsRUFBb0IxQyxVQUFVMkMsU0FBUyxjQUN6Q0QsRUFBb0JoQyxXQUFXVixVQUFVNEMsT0FBTyxjQXdEcERDLFdBWGtCQyxJQUNsQjlELEVBQVUwQixXQUFXUixZQUFjLEdBQUc0QyxTQUN0QzlELEVBQVVnQixVQUFVQyxJQUFJLGNBbEdqQixHQzRHWCxFQTdHbUI4QyxJQUVqQixJQUFJMUIsRUFBUSxHQUNSMkIsRUFBTyxFQUVYLE1BZ0JNM0MsRUFSWSxDQUFDMEMsSUFDakIsTUFBTUUsRUFBTSxHQUNaLElBQUssSUFBSWpCLEVBQUksRUFBR0EsRUFBSWUsRUFBT0EsRUFBTWYsSUFDL0JpQixFQUFJQyxLQVZDLENBQ0xwQyxPQUFRLENBQUN4QixFQVNLMEMsRUFBSWUsRUFUTnhELEVBU1k0RCxLQUFLQyxNQUFNcEIsRUFBSWUsSUFSdkNoQyxRQUFTLEdBQ1RzQyxRQUFRLElBU1YsT0FBT0osR0FHS0ssQ0FBVVAsR0FDbEJRLEVBQU16QyxHQUFXVCxFQUFNUyxFQUFPeEIsRUFBSXdCLEVBQU92QixFQUFJd0QsR0F5RW5ELE1BQU8sQ0FDTFEsR0FBQUEsRUFDQUMsY0F6RXFCMUMsSUFDYnlDLEVBQUd6QyxHQUFRdUMsT0F5RW5CSSxVQXRFaUIzQyxHQUNhLEtBQXZCeUMsRUFBR3pDLEdBQVFDLFFBc0VsQjJDLGNBbkVxQjVDLElBQ3JCLE1BQU1ILEVBQU80QyxFQUFHekMsR0FHaEIsR0FGQUgsRUFBSzBDLFFBQVMsRUFDZCxVQUFXdkMsR0FDUEgsRUFBS0ksUUFBUyxDQUNoQixNQUFNVSxFQUFPSixFQUFNc0MsTUFBS2xDLEdBQVFBLEVBQUtLLE9BQVNuQixFQUFLSSxVQUNuRFUsRUFBS21DLE1BQ0RuQyxFQUFLSSxVQWFJLENBQUNnQyxJQUNoQmIsSUFDQSxNQUFNNUQsRUFBY2lCLEVBQU15RCxRQUFPbkQsR0FBUUEsRUFBS0ksVUFBWThDLElBQVVFLEtBQUlwRCxHQUFRQSxFQUFLRyxTQUNyRixXQUFZMUIsSUFoQlNpRCxDQUFTWixFQUFLSyxRQTZEbkNrQyxRQXpEYyxDQUFDdkMsRUFBTVgsRUFBUW1ELEVBQU8sT0FDcEM1QyxFQUFNNkIsS0FBS3pCLEdBQ1gsSUFBSXlDLEVBQVlwRCxFQUNoQixJQUFLLElBQUlrQixFQUFJLEVBQUdBLEVBQUlQLEVBQUtRLFlBQWFELElBQ3BDdUIsRUFBR1csR0FBV25ELFFBQVVVLEVBQUtLLEtBQ3BCLE1BQVRtQyxFQUFlQyxFQUFVNUUsSUFBSzRFLEVBQVUzRSxLQXFEMUM0RSxhQTNDb0JDLElBQ3BCLElBQUssTUFBTUMsS0FBY0QsRUFBaUIsQ0FDeEMsR0FBSUMsRUFBVy9FLEVBQUl5RCxFQUFPLEdBQUtzQixFQUFXOUUsRUFBSXdELEVBQU8sRUFBRyxPQUFPLEVBQy9ELEdBQStCLEtBQTNCUSxFQUFHYyxHQUFZdEQsUUFBZ0IsT0FBTyxFQUMxQyxNQUFNdUQsRUFVRCxDQUNMLENBQUNoRixHQUYyQndCLEVBVGtCdUQsR0FXbkMvRSxFQUFJLEVBQUdDLEVBQUd1QixFQUFPdkIsR0FDNUIsQ0FBQ0QsRUFBR3dCLEVBQU94QixFQUFJLEVBQUdDLEVBQUd1QixFQUFPdkIsR0FDNUIsQ0FBQ0QsRUFBR3dCLEVBQU94QixFQUFHQyxFQUFHdUIsRUFBT3ZCLEVBQUksR0FDNUIsQ0FBQ0QsRUFBR3dCLEVBQU94QixFQUFHQyxFQUFHdUIsRUFBT3ZCLEVBQUksSUFiNUIsSUFBSyxNQUFNdUIsS0FBVXdELEVBQ25CLEtBQUl4RCxFQUFPeEIsRUFBSXlELEVBQU8sR0FBS2pDLEVBQU94QixFQUFJLEdBQUt3QixFQUFPdkIsRUFBSXdELEVBQU8sR0FBS2pDLEVBQU92QixFQUFJLElBQ2xELEtBQXZCZ0UsRUFBR3pDLEdBQVFDLFFBQWdCLE9BQU8sRUFNYixJQUFDRCxFQUg5QixPQUFPLEdBa0NQeUQsU0FWZSxJQUFNbEUsRUFXckJtRSxTQVZlLElBQU1uRCxFQVdyQm9ELE1BeEJZLEtBQ1pwRCxFQUFRLEdBQ1IsSUFBSyxNQUFNVixLQUFRTixFQUNqQk0sRUFBSzBDLFFBQVMsRUFDZDFDLEVBQUtJLFFBQVUsSUFxQmpCMkQsYUFqQm1CLElBQ1oxQixHQUFRM0IsRUFBTXNELFNDaEZ6QixFQVRlLENBQUM3QyxFQUFNOEMsS0FDYixDQUNMOUMsS0FBQUEsRUFDQThDLFlBQUFBLEVBQ0FDLFVBQVcsRUFBVSxJQUNyQnZFLFVBQVUsSUNrQmQsRUF6QmEsQ0FBQ3FFLEVBQVE3QyxLQUNwQixNQUFNZ0QsRUFBYUgsRUFDbkIsSUFBSUksRUFBVyxFQWNmLE1BQU8sQ0FDTGpELEtBQUFBLEVBQ0FHLFVBYmdCLElBQU02QyxFQWN0QkUsUUFiYyxJQUFNRCxFQWNwQm5CLElBWlUsS0FDVm1CLEtBWUFsRCxPQVRhLElBQ05rRCxHQUFZRCxJQzhGdkIsRUF4R1csTUFFVCxNQUFNRyxFQUFXLEVBQU8sTUFDbEI1RCxFQUFRLENBQUMsRUFBSyxFQUFHLFdBQVksRUFBSyxFQUFHLGNBQWUsRUFBSyxFQUFHLFdBQVksRUFBSyxFQUFHLGFBQWMsRUFBSyxFQUFHLGNBQzVHLElBQUk2RCxFQUFjLEtBRWxCLE1BUU1DLEVBQXVCLEtBQzNCLE1BQ01DLEVBRFFILEVBQVNKLFVBQVVOLFdBQ1JULFFBQU9uRCxJQUFTQSxFQUFLMEMsU0FFOUMsT0FEZStCLEVBQVdqQyxLQUFLQyxNQUFNRCxLQUFLa0MsU0FBV0QsRUFBV1QsU0FBUzdELFFBMkJyRXdFLEVBQU0sQ0FBQ0MsRUFBTUMsRUFBTUMsR0FBVyxJQUMzQkMsT0FBT0MsS0FBS0osR0FBTUssUUFBTyxDQUFDQyxFQUFhQyxLQUN4QyxJQUFLRCxFQUFhLENBQUNDLEdBQU1QLEVBQUtPLElBQVFMLEdBQVksRUFBRyxHQUFLRCxFQUFLTSxNQUMvRCxJQWtEUixNQUFPLENBQ0xDLFVBdkJpQmxCLElBQ2pCLElBQUkvRCxFQWFKLE9BWkFtRSxFQUFTSixVQUFZQSxFQUNqQkssRUFFRUQsRUFBU0osVUFDWkwsV0FDQWIsTUFBS2xDLEdBQVFBLEVBQUtLLE9BQVNtRCxFQUFTSixVQUFVdEIsR0FBRzJCLEdBQWFuRSxVQUM5RGMsVUFDQ3FELEVBQWMsS0FDZHBFLEVBQVNxRSxLQUNKckUsRUFwQ2MsTUFDdkIsTUFBTXdELEVBaEJSLFNBQTRCMEIsR0FDMUIsSUFBSWhFLEVBQUlnRSxFQUFNckIsT0FDZCxLQUFPM0MsS0FBSyxDQUNWLE1BQU1pRSxFQUFLOUMsS0FBS0MsTUFBTUQsS0FBS2tDLFNBQVdyRCxJQUNyQ2dFLEVBQU1oRSxHQUFJZ0UsRUFBTUMsSUFBTyxDQUFDRCxFQUFNQyxHQUFLRCxFQUFNaEUsSUFFNUMsT0FBT2dFLEVBVWdCRSxDQTlCTSxDQUFDcEYsSUFDOUIsTUFBTXFGLEVBQVksRUFBRSxFQUFHLEdBQ3ZCLElBQUk3QixFQUFpQixHQUNyQixJQUFJLE1BQU04QixLQUFZRCxFQUNwQixJQUFLLE1BQU1MLEtBQU9oRixFQUFRLENBQ3hCLE1BQU11RixFQUFXdkYsRUFBT2dGLEdBQU9NLEVBQzNCQyxHQUFZLEdBQUtBLEdBQVksR0FDL0IvQixFQUFlcEIsS0FBSyxJQUFJcEMsRUFBUSxDQUFDZ0YsR0FBTU8sSUFJN0MsT0FBTy9CLEdBbUJtQ2dDLENBQXVCcEIsSUFDakUsSUFBSyxNQUFNcEUsS0FBVXdELEVBQWdCLENBQ25DLElBQUkzRCxFQUFPc0UsRUFBU0osVUFBVXRCLEdBQUd6QyxHQUNqQyxHQUFJSCxFQUFLMEMsUUFBVTFDLEVBQUtJLFFBQVMsQ0FDL0IsSUFBSW1ELEVBQVksSUFBSXBELEdBQ2hCeUYsRUFBWWpCLEVBQUlwQixFQUFXZ0IsR0FBYSxHQUM1QyxLQUFPdkUsRUFBSzBDLFFBQVUxQyxFQUFLSSxVQUN6Qm1ELEVBQVlvQixFQUFJcEIsRUFBV3FDLEtBQ3ZCckMsRUFBVTVFLEVBQUksR0FBSzRFLEVBQVU1RSxFQUFJLEdBQUs0RSxFQUFVM0UsRUFBSSxHQUFLMkUsRUFBVTNFLEVBQUksS0FDM0VvQixFQUFPc0UsRUFBU0osVUFBVXRCLEdBQUdXLEdBRS9CLE9BQUl2RCxFQUFLMEMsT0FDQWlDLEVBQUlKLEVBQWFxQixHQUFXLEdBRTlCckMsR0FHWCxJQUFLLE1BQU1wRCxLQUFVd0QsRUFFbkIsSUFEV1csRUFBU0osVUFBVXRCLEdBQUd6QyxHQUN4QnVDLE9BQ0osT0FBT3ZDLEdBZUkwRixHQUNYMUYsRUFBU3FFLElBQ1pGLEVBQVNKLFVBQVVwQixVQUFVM0MsS0FBU29FLEVBQWNwRSxHQUNqREEsR0FVUDJGLFlBUGtCLEtBckZsQnhCLEVBQVNKLFVBQVViLFFBQVEzQyxFQUFNLEdBQUksQ0FBRS9CLEVBQUcsRUFBR0MsRUFBRyxHQUFLLEtBQ3JEMEYsRUFBU0osVUFBVWIsUUFBUTNDLEVBQU0sR0FBSSxDQUFFL0IsRUFBRyxFQUFHQyxFQUFHLEdBQUssS0FDckQwRixFQUFTSixVQUFVYixRQUFRM0MsRUFBTSxHQUFJLENBQUUvQixFQUFHLEVBQUdDLEVBQUcsR0FBSyxLQUNyRDBGLEVBQVNKLFVBQVViLFFBQVEzQyxFQUFNLEdBQUksQ0FBRS9CLEVBQUcsRUFBR0MsRUFBRyxHQUFLLEtBQ3JEMEYsRUFBU0osVUFBVWIsUUFBUTNDLEVBQU0sR0FBSSxDQUFFL0IsRUFBRyxFQUFHQyxFQUFHLEdBQUssS0FtRjlDMEYsS0E5RkEsR0M4RVgsRUE1RXVCLE1BRXJCLE1BQU15QixFQUFVLEVBQU8sS0FBTSxVQUN2QkMsRUFBVSxFQUFPLEtBQU0sU0FFN0IsU0FBU0MsRUFBTUMsR0FDYixPQUFPLElBQUlDLFNBQVFDLEdBQVdDLFdBQVdELEVBQVNGLEtBR3BELE1BQU1JLEVBQVcsSUFDUlAsRUFBUXBHLFNBQVdxRyxFQUFTRCxFQTRCL0JRLEVBQVdDLE1BQU9yRyxJQUN0QixNQUFNc0csRUFBZ0JILElBQVdwQyxVQUNqQyxHQUFLdUMsRUFBYzVELGNBQWMxQyxHQUFqQyxDQUlBLEdBRkFzRyxFQUFjMUQsY0FBYzVDLEdBRXZCc0csRUFBYzNELFVBQVUzQyxJQUszQixHQURBLHFCQUFzQm1HLElBQVduRixLQUFNc0YsRUFBYzVDLFlBQ2pENEMsRUFBYzFDLGVBRWhCLFlBREEsY0FwQ0dnQyxFQUFRcEcsU0FBV29HLEVBQVNDLEdBb0NGL0Isd0JBTHpCZ0MsRUFBTSxLQTNCZEYsRUFBUXBHLFVBQVlvRyxFQUFRcEcsU0FDNUJxRyxFQUFRckcsVUFBWXFHLEVBQVFyRyxTQUM1QixzQkFrQ0ErRyxNQUdJQSxFQUFXRixVQUNYUixFQUFRckcsaUJBQ0pzRyxFQUFvQixJQUFkekQsS0FBS2tDLFNBQWUsS0FDaEM2QixFQUFTLFlBQWFELElBQVdwQyxjQVNyQyxNQUFPLENBQ0x5QyxLQU5XLEtBeENYWixFQUFRcEcsVUFBVyxFQUNuQm9HLEVBQVE3QixVQUFZLG9CQUE2QkEsVUFDakQsa0JBQW1CNkIsRUFBUTVFLEtBQU00RSxFQUFRN0IsVUFBVU4sWUFDbkQscUJBQXNCbUMsRUFBUTVFLEtBQU00RSxFQUFRN0IsVUFBVUwsWUFJdERtQyxFQUFRckcsVUFBVyxFQUNuQnFHLEVBQVE5QixVQUFZLGdCQUFpQkEsVUFDckMsa0JBQW1COEIsRUFBUTdFLEtBQU02RSxFQUFROUIsVUFBVU4sWUFBWSxHQUMvRCxxQkFBc0JvQyxFQUFRN0UsS0FBTTZFLEVBQVE5QixVQUFVTCxhQXFDdEQwQyxTQUFBQSxJQXZFbUIsR0NvSHZCLEVBcEhtQixNQUNqQixNQUFNSyxFQUFTLEVBQU8sVUFDaEJsRyxFQUFRLENBQUMsRUFBSyxFQUFHLFdBQVksRUFBSyxFQUFHLGNBQWUsRUFBSyxFQUFHLFdBQVksRUFBSyxFQUFHLGFBQWMsRUFBSyxFQUFHLGNBQzVHLElBQUltRyxFQUFVLENBQ1psRyxRQUFTLEVBQ1Q4QyxnQkFBaUIsR0FDakJILEtBQU0sS0FFUixNQUFNbEYsRUFBU0YsU0FBU0MsY0FBYyxVQUNoQzJJLEVBQWM1SSxTQUFTQyxjQUFjLGVBQ3JDNEksRUFBZTdJLFNBQVNDLGNBQWMsZ0JBSXRDNkksRUFBVTdHLEdBQ1BqQyxTQUFTQyxjQUFjLGlCQUFpQmdDLEVBQU94QixLQUFLd0IsRUFBT3ZCLE9BSzlEcUksRUFBWTlHLElBQ1owRyxFQUFRbEcsU0FBV0QsRUFBTXNELFNBQ1UsSUFBbkM2QyxFQUFRcEQsZ0JBQWdCTyxRQUMxQjZDLEVBQVFwRCxnQkFBZ0J0RSxTQUFRZ0IsSUFDOUI2RyxFQUFPN0csR0FBUWQsVUFBVTZILE9BQU8sUUFDaENGLEVBQU83RyxHQUFRZCxVQUFVNkgsT0FBTyxjQUdwQ0wsRUFBUXBELGdCQUFrQjBELEVBQVNoSCxHQUNuQzBHLEVBQVFwRCxnQkFBZ0J0RSxTQUFRZ0IsSUFDOUI2RyxFQUFPN0csR0FBUWQsVUFBVUMsSUFBSSxXQUUxQjhILEtBQ0hQLEVBQVFwRCxnQkFBZ0J0RSxTQUFRZ0IsSUFDOUI2RyxFQUFPN0csR0FBUWQsVUFBVUMsSUFBSSxnQkFLN0I2SCxFQUFZaEgsSUFDaEIsSUFBSXNELEVBQWtCLEdBQ2xCRixFQUFZcEQsRUFDaEIsSUFBSyxJQUFJa0IsRUFBSSxFQUFHQSxFQUFJWCxFQUFNbUcsRUFBUWxHLFNBQVNXLGNBQ3pDbUMsRUFBZ0JsQixLQUFLLENBQUM1RCxFQUFHNEUsRUFBVTVFLEVBQUdDLEVBQUcyRSxFQUFVM0UsSUFDbEMsTUFBakJpSSxFQUFRdkQsS0FBZUMsRUFBVTVFLElBQUs0RSxFQUFVM0UsTUFDNUMyRSxFQUFVNUUsRUFBSSxHQUFLNEUsRUFBVTNFLEVBQUksSUFIaUJ5QyxLQUt4RCxPQUFPb0MsR0FHSDJELEVBQWMsS0FDVFIsRUFBTzFDLFVBQVVWLGFBQWFxRCxFQUFRcEQsa0JBQ3pDb0QsRUFBUXBELGdCQUFnQk8sU0FBV3RELEVBQU1tRyxFQUFRbEcsU0FBU1csWUFpQjVEd0MsRUFBUSxLQUNaOEMsRUFBTzFDLFVBQVVKLFFBQ2pCOEMsRUFBTzFDLFVBQVVOLFdBQVd6RSxTQUFRYSxJQUNsQ2dILEVBQU9oSCxFQUFLRyxRQUFRZCxVQUFVNkgsT0FBTyxRQUNyQ0YsRUFBT2hILEVBQUtHLFFBQVFkLFVBQVU2SCxPQUFPLFFBQ3JDRixFQUFPaEgsRUFBS0csUUFBUWQsVUFBVTZILE9BQU8sY0FFZnRGLE1BQU1DLEtBQUszRCxTQUFTQyxjQUFjLGtCQUFrQjJELFVBQzVEM0MsU0FBUThCLEdBQWtCQSxFQUFlNUIsVUFBVTZILE9BQU8sVUFDMUVMLEVBQVUsQ0FDUmxHLFFBQVMsRUFDVDhDLGdCQUFpQixHQUNqQkgsS0FBTSxLQUVSd0QsRUFBWU8sTUFBTUMsUUFBVSxRQXdCOUIsTUFBTyxDQUNMWCxLQXBCVyxLQUNYLGtCQUFtQkMsRUFBT3pGLEtBQU15RixFQUFPMUMsVUFBVU4sWUFDakQscUJBQXNCZ0QsRUFBT3pGLEtBQU1ULEdBRW5DeEMsU0FBU21DLGlCQUFpQixTQUFTLEVBQUc4RSxJQUFBQSxNQUN4QixNQUFSQSxHQUF1QixNQUFSQSxJQUNqQjBCLEVBQVF2RCxLQUF3QixNQUFqQnVELEVBQVF2RCxLQUFlLElBQUssSUFDM0MyRCxFQUFTSixFQUFRcEQsZ0JBQWdCLEdBQUlvRCxFQUFRdkQsVUFJakR3RCxFQUFZekcsaUJBQWlCLFNBQVMsS0FDcENqQyxFQUFPOEksU0FDUCxZQUdGSCxFQUFhMUcsaUJBQWlCLFFBQVN5RCxJQUt2Q3lELFVBckRpQnBILElBQ1ppSCxNQUNMUixFQUFPMUMsVUFBVWIsUUFBUTNDLEVBQU1tRyxFQUFRbEcsV0FBWVIsRUFBUTBHLEVBQVF2RCxNQUNuRXVELEVBQVFwRCxnQkFBZ0J0RSxTQUFRZ0IsSUFDOUI2RyxFQUFPN0csR0FBUWQsVUFBVUMsSUFBSSxRQUM3QjBILEVBQU83RyxHQUFRZCxVQUFVNkgsT0FBTyxXQUVsQyxxQkFBc0JOLEVBQU96RixLQUFNVCxFQUFPbUcsRUFBUWxHLFFBQVUsR0FDeERrRyxFQUFRbEcsVUFBWUQsRUFBTXNELFNBQzVCOEMsRUFBWU8sTUFBTUMsUUFBVSxXQTZDOUJMLFNBQUFBLEVBQ0FPLGdCQXpCc0IsSUFBTVosSUF0RmIsR0NGbkIsVSIsInNvdXJjZXMiOlsid2VicGFjazovL2JhdHRsZXNoaXAvLi9zcmMvTW9kdWxlcy9VSS5qcyIsIndlYnBhY2s6Ly9iYXR0bGVzaGlwLy4vc3JjL0ZhY3Rvcmllcy9HYW1lYm9hcmQuanMiLCJ3ZWJwYWNrOi8vYmF0dGxlc2hpcC8uL3NyYy9GYWN0b3JpZXMvUGxheWVyLmpzIiwid2VicGFjazovL2JhdHRsZXNoaXAvLi9zcmMvRmFjdG9yaWVzL1NoaXAuanMiLCJ3ZWJwYWNrOi8vYmF0dGxlc2hpcC8uL3NyYy9Nb2R1bGVzL0FJUGxheWVyLmpzIiwid2VicGFjazovL2JhdHRsZXNoaXAvLi9zcmMvTW9kdWxlcy9HYW1lQ29udHJvbGxlci5qcyIsIndlYnBhY2s6Ly9iYXR0bGVzaGlwLy4vc3JjL01vZHVsZXMvUGxhY2VTaGlwcy5qcyIsIndlYnBhY2s6Ly9iYXR0bGVzaGlwLy4vc3JjL2luZGV4LmpzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBHYW1lQ29udHJvbGxlciBmcm9tIFwiLi9HYW1lQ29udHJvbGxlclwiO1xuaW1wb3J0IFBsYWNlU2hpcHMgZnJvbSBcIi4vUGxhY2VTaGlwc1wiO1xuXG5jb25zdCBVSSA9ICgoKSA9PiB7XG4gIGNvbnN0ICRnYW1lYm9hcmRzQ29udGFpbmVyID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignLmdhbWVib2FyZHMtY29udGFpbmVyJyk7XG4gIGNvbnN0ICRtb2RhbCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJy5tb2RhbCcpO1xuICBjb25zdCAkd2luTW9kYWwgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcubW9kYWwtd2luJyk7XG4gIGxldCBtb2RlID0gJ1BMQVknO1xuXG4gIGNvbnN0IGRlY29kZUNvb3JkcyA9IChjb29yZHNTdHJpbmcpID0+IHtcbiAgICBjb25zdCBjb29yZHNBcnJheSA9IGNvb3Jkc1N0cmluZy5zcGxpdCgnICcpO1xuICAgIHJldHVybiB7eDogK2Nvb3Jkc0FycmF5WzBdLCB5OiArY29vcmRzQXJyYXlbMV19O1xuICB9XG5cbiAgY29uc3QgY3JlYXRlSHRtbEVsZW1lbnQgPSAodHlwZSwgY2xhc3NBcnJheSA9IG51bGwsIHRleHQgPSBudWxsKSA9PiB7XG4gICAgY29uc3QgZWxlbWVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQodHlwZSk7XG4gICAgaWYgKGNsYXNzQXJyYXkpIGNsYXNzQXJyYXkuZm9yRWFjaChjbHMgPT4gZWxlbWVudC5jbGFzc0xpc3QuYWRkKGNscykpO1xuICAgIGlmICh0ZXh0KSBlbGVtZW50LnRleHRDb250ZW50ID0gdGV4dDtcbiAgICByZXR1cm4gZWxlbWVudDtcbiAgfVxuICBcbiAgY29uc3QgbmV3Q2VsbERPTSA9IChjZWxsKSA9PiB7XG4gICAgICBjb25zdCAkY2VsbCA9IGNyZWF0ZUh0bWxFbGVtZW50KCdkaXYnLCBbJ2NlbGwnXSk7XG4gICAgICAkY2VsbC5zZXRBdHRyaWJ1dGUoJ2RhdGEtY29vcmRzJywgYCR7Y2VsbC5jb29yZHMueH0gJHtjZWxsLmNvb3Jkcy55fWApO1xuICAgICAgaWYgKGNlbGwuaGFzU2hpcCkgJGNlbGwuY2xhc3NMaXN0LmFkZCgnc2hpcCcpO1xuICAgICAgYWRkQ2VsbExpc3RlbmVyKCRjZWxsKTtcbiAgICAgIHJldHVybiAkY2VsbDtcbiAgfVxuXG4gIGNvbnN0IGFkZENlbGxMaXN0ZW5lciA9ICgkY2VsbCkgPT4ge1xuICAgIGlmIChtb2RlID09PSAnUExBQ0UnKSB7XG4gICAgICAkY2VsbC5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsICgpID0+IHtcbiAgICAgICAgUGxhY2VTaGlwcy5wbGFjZVNoaXAoZGVjb2RlQ29vcmRzKCRjZWxsLmdldEF0dHJpYnV0ZSgnZGF0YS1jb29yZHMnKSkpO1xuICAgICAgfSk7XG4gIFxuICAgICAgJGNlbGwuYWRkRXZlbnRMaXN0ZW5lcignbW91c2VvdmVyJywgKCkgPT4ge1xuICAgICAgICBQbGFjZVNoaXBzLnNob3dTaGlwKGRlY29kZUNvb3JkcygkY2VsbC5nZXRBdHRyaWJ1dGUoJ2RhdGEtY29vcmRzJykpKTtcbiAgICAgIH0pO1xuICAgIH1cbiAgICBlbHNlICRjZWxsLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKCkgPT4ge1xuICAgICAgR2FtZUNvbnRyb2xsZXIucGxheVR1cm4oZGVjb2RlQ29vcmRzKCRjZWxsLmdldEF0dHJpYnV0ZSgnZGF0YS1jb29yZHMnKSkpO1xuICAgIH0pO1xuICB9XG5cbiAgY29uc3QgY2VsbEhpdCA9IChjb29yZHMpID0+IHtcbiAgICBjb25zdCBlbmNvZGVkQ29vcmRzID0gYCR7Y29vcmRzLnh9ICR7Y29vcmRzLnl9YDtcbiAgICBjb25zdCAkY2VsbCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoYC5hY3RpdmUgPiBbZGF0YS1jb29yZHM9XCIke2VuY29kZWRDb29yZHN9XCJdYCk7XG4gICAgJGNlbGwuY2xhc3NMaXN0LmFkZCgnaGl0Jyk7XG4gIH1cblxuICBjb25zdCB0b2dnbGVBY3RpdmVCb2FyZCA9ICgpID0+IHtcbiAgICBjb25zdCAkZ2FtZWJvYXJkQ29udGFpbmVycyA9IEFycmF5LmZyb20oJGdhbWVib2FyZHNDb250YWluZXIuY2hpbGRyZW4pO1xuICAgICRnYW1lYm9hcmRDb250YWluZXJzLmZvckVhY2goJGdhbWVib2FyZENvbnRhaW5lciA9PiB7XG4gICAgICBpZiAoJGdhbWVib2FyZENvbnRhaW5lci5jbGFzc0xpc3QuY29udGFpbnMoJ2NvbnRhaW5lcicpKVxuICAgICAgICAkZ2FtZWJvYXJkQ29udGFpbmVyLmZpcnN0Q2hpbGQuY2xhc3NMaXN0LnRvZ2dsZSgnYWN0aXZlJyk7XG4gICAgfSk7XG4gIH1cblxuICBjb25zdCBzaGlwU3VuayA9IChjb29yZHNBcnJheSkgPT4ge1xuICAgIGNvb3Jkc0FycmF5LmZvckVhY2goY29vcmRzID0+IHtcbiAgICAgIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoYC5hY3RpdmUgPiBbZGF0YS1jb29yZHM9XCIke2Nvb3Jkcy54fSAke2Nvb3Jkcy55fVwiXWApLmNsYXNzTGlzdC5hZGQoJ3N1bmsnKTtcbiAgICB9KVxuICB9XG5cbiAgY29uc3QgbmV3R2FtZWJvYXJkQ29udGFpbmVyRE9NID0gKHBsYXllck5hbWUpID0+IHtcbiAgICBjb25zdCAkY29udGFpbmVyID0gY3JlYXRlSHRtbEVsZW1lbnQoJ2RpdicsIFsnY29udGFpbmVyJ10pO1xuICAgICRjb250YWluZXIuYXBwZW5kQ2hpbGQoY3JlYXRlSHRtbEVsZW1lbnQoJ2RpdicsIFtgJHtwbGF5ZXJOYW1lfWAsICdib2FyZCddKSk7XG4gICAgJGNvbnRhaW5lci5hcHBlbmRDaGlsZChjcmVhdGVIdG1sRWxlbWVudCgnZGl2JywgWydzaGlwcy1kaXNwbGF5J10pKTtcbiAgICByZXR1cm4gJGNvbnRhaW5lcjtcbiAgfVxuXG4gIGNvbnN0IHJlbmRlckdhbWVib2FyZCA9IChwbGF5ZXJOYW1lLCBib2FyZCwgaXNBY3RpdmUgPSBmYWxzZSkgPT4ge1xuICAgIG1vZGUgPSBwbGF5ZXJOYW1lID09PSAnc2FtcGxlJyA/ICdQTEFDRSc6ICdQTEFZJztcbiAgICBjb25zdCAkY29udGFpbmVyID0gbmV3R2FtZWJvYXJkQ29udGFpbmVyRE9NKHBsYXllck5hbWUpO1xuICAgIG1vZGUgPT09ICdQTEFDRScgPyAkbW9kYWwuYXBwZW5kQ2hpbGQoJGNvbnRhaW5lcik6ICRnYW1lYm9hcmRzQ29udGFpbmVyLmFwcGVuZENoaWxkKCRjb250YWluZXIpO1xuICAgIGlmIChpc0FjdGl2ZSkgJGNvbnRhaW5lci5maXJzdENoaWxkLmNsYXNzTGlzdC5hZGQoJ2FjdGl2ZScpO1xuICAgIGJvYXJkLmZvckVhY2goY2VsbCA9PiAkY29udGFpbmVyLmZpcnN0Q2hpbGQuYXBwZW5kQ2hpbGQobmV3Q2VsbERPTShjZWxsKSkpO1xuICB9XG5cbiAgY29uc3QgbmV3U2hpcERPTSA9IChzaGlwLCBpc1BsYWNlZCA9IGZhbHNlKSA9PiB7XG4gICAgY29uc3QgJHNoaXBDb250YWluZXIgPSBjcmVhdGVIdG1sRWxlbWVudCgnZGl2JywgWydzaGlwLWNvbnRhaW5lciddKTtcbiAgICBpZiAoc2hpcC5pc1N1bmsoKSB8fCAobW9kZSA9PT0gJ1BMQUNFJyAmJiBpc1BsYWNlZCkpICRzaGlwQ29udGFpbmVyLmNsYXNzTGlzdC5hZGQoJ3N1bmsnKTtcbiAgICAkc2hpcENvbnRhaW5lci5hcHBlbmRDaGlsZChjcmVhdGVIdG1sRWxlbWVudCgnZGl2JywgWydzaGlwLW5hbWUnXSwgc2hpcC5uYW1lKSk7XG4gICAgY29uc3QgJHNoaXBCb2R5ID0gY3JlYXRlSHRtbEVsZW1lbnQoJ2RpdicsIFsnc2hpcC1ib2R5J10pO1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgc2hpcC5nZXRMZW5ndGgoKTsgaSsrKSB7XG4gICAgICAkc2hpcEJvZHkuYXBwZW5kQ2hpbGQoY3JlYXRlSHRtbEVsZW1lbnQoJ2RpdicsIFsnc2hpcC1jZWxsJ10pKTtcbiAgICB9XG4gICAgJHNoaXBDb250YWluZXIuYXBwZW5kQ2hpbGQoJHNoaXBCb2R5KTtcbiAgICByZXR1cm4gJHNoaXBDb250YWluZXI7XG4gIH1cblxuICBjb25zdCB1cGRhdGVTaGlwc0Rpc3BsYXkgPSAocGxheWVyTmFtZSwgc2hpcHMsIHNoaXBOdW0gPSAtMSkgPT4ge1xuICAgIGNvbnN0ICRzaGlwc0Rpc3BsYXkgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKGAuJHtwbGF5ZXJOYW1lfWApLm5leHRFbGVtZW50U2libGluZztcbiAgICAkc2hpcHNEaXNwbGF5LnRleHRDb250ZW50ID0gJyc7XG4gICAgc2hpcHMuZm9yRWFjaCgoc2hpcCwgaW5kZXgpID0+IHtcbiAgICAgICRzaGlwc0Rpc3BsYXkuYXBwZW5kQ2hpbGQobmV3U2hpcERPTShzaGlwLCBpbmRleCA8PSBzaGlwTnVtKSk7XG4gICAgfSk7XG4gIH1cblxuICBjb25zdCBzaG93V2lubmVyID0gKHBsYXllckRpc3BsYXlOYW1lKSA9PiB7XG4gICAgJHdpbk1vZGFsLmZpcnN0Q2hpbGQudGV4dENvbnRlbnQgPSBgJHtwbGF5ZXJEaXNwbGF5TmFtZX0gd2luc2A7XG4gICAgJHdpbk1vZGFsLmNsYXNzTGlzdC5hZGQoJ3Zpc2libGUnKTtcbiAgfVxuXG4gIHJldHVybiB7XG4gICAgcmVuZGVyR2FtZWJvYXJkLFxuICAgIHVwZGF0ZVNoaXBzRGlzcGxheSxcbiAgICBjZWxsSGl0LFxuICAgIHNoaXBTdW5rLFxuICAgIHRvZ2dsZUFjdGl2ZUJvYXJkLFxuICAgIHNob3dXaW5uZXIsXG4gIH07XG5cbn0pKCk7XG5cbmV4cG9ydCBkZWZhdWx0IFVJOyIsImltcG9ydCBVSSBmcm9tIFwiLi4vTW9kdWxlcy9VSVwiO1xuXG5jb25zdCBHYW1lYm9hcmQgPSAoc2l6ZSkgPT4ge1xuXG4gIGxldCBzaGlwcyA9IFtdO1xuICBsZXQgc3VuayA9IDA7XG5cbiAgY29uc3QgY2VsbCA9ICh4LCB5KSA9PiB7XG4gICAgcmV0dXJuIHtcbiAgICAgIGNvb3Jkczoge3gsIHl9LFxuICAgICAgaGFzU2hpcDogJycsXG4gICAgICBpc1Nob3Q6IGZhbHNlXG4gICAgfTtcbiAgfVxuXG4gIGNvbnN0IF9tYWtlR3JpZCA9IChzaXplKSA9PiB7XG4gICAgY29uc3QgYXJyID0gW107XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBzaXplICogc2l6ZTsgaSsrKSB7XG4gICAgICBhcnIucHVzaChjZWxsKGkgJSBzaXplLCBNYXRoLmZsb29yKGkgLyBzaXplKSkpO1xuICAgIH1cbiAgICByZXR1cm4gYXJyO1xuICB9XG5cbiAgY29uc3QgYm9hcmQgPSBfbWFrZUdyaWQoc2l6ZSk7XG4gIGNvbnN0IGF0ID0gKGNvb3JkcykgPT4gYm9hcmRbY29vcmRzLnggKyBjb29yZHMueSAqIHNpemVdO1xuXG4gIGNvbnN0IGlzVmFsaWRBdHRhY2sgPSAoY29vcmRzKSA9PiB7XG4gICAgcmV0dXJuICFhdChjb29yZHMpLmlzU2hvdDtcbiAgfVxuXG4gIGNvbnN0IGlzU2hpcEhpdCA9IChjb29yZHMpID0+IHtcbiAgICByZXR1cm4gYXQoY29vcmRzKS5oYXNTaGlwICE9PSAnJztcbiAgfVxuXG4gIGNvbnN0IHJlY2VpdmVBdHRhY2sgPSAoY29vcmRzKSA9PiB7XG4gICAgY29uc3QgY2VsbCA9IGF0KGNvb3Jkcyk7XG4gICAgY2VsbC5pc1Nob3QgPSB0cnVlO1xuICAgIFVJLmNlbGxIaXQoY29vcmRzKTtcbiAgICBpZiAoY2VsbC5oYXNTaGlwKSB7XG4gICAgICBjb25zdCBzaGlwID0gc2hpcHMuZmluZChzaGlwID0+IHNoaXAubmFtZSA9PT0gY2VsbC5oYXNTaGlwKTtcbiAgICAgIHNoaXAuaGl0KCk7XG4gICAgICBpZiAoc2hpcC5pc1N1bmsoKSkgc2hpcFN1bmsoc2hpcC5uYW1lKTtcbiAgICB9XG4gIH1cblxuICBjb25zdCBzZXRTaGlwID0gKHNoaXAsIGNvb3JkcywgYXhpcyA9ICd4JykgPT4ge1xuICAgIHNoaXBzLnB1c2goc2hpcCk7XG4gICAgbGV0IG5ld0Nvb3JkcyA9IGNvb3JkcztcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHNoaXAuZ2V0TGVuZ3RoKCk7IGkrKykge1xuICAgICAgYXQobmV3Q29vcmRzKS5oYXNTaGlwID0gc2hpcC5uYW1lO1xuICAgICAgYXhpcyA9PT0gJ3gnID8gbmV3Q29vcmRzLngrKzogbmV3Q29vcmRzLnkrKztcbiAgICB9XG4gIH1cblxuICBjb25zdCBzaGlwU3VuayA9IChzaGlwTmFtZSkgPT4ge1xuICAgIHN1bmsrKztcbiAgICBjb25zdCBjb29yZHNBcnJheSA9IGJvYXJkLmZpbHRlcihjZWxsID0+IGNlbGwuaGFzU2hpcCA9PT0gc2hpcE5hbWUpLm1hcChjZWxsID0+IGNlbGwuY29vcmRzKTtcbiAgICBVSS5zaGlwU3Vuayhjb29yZHNBcnJheSk7XG4gIH1cblxuICBjb25zdCBpc0NvbGxpc2lvbnMgPSAoc2hpcENvb3Jkc0FycmF5KSA9PiB7XG4gICAgZm9yIChjb25zdCBzaGlwQ29vcmRzIG9mIHNoaXBDb29yZHNBcnJheSkge1xuICAgICAgaWYgKHNoaXBDb29yZHMueCA+IHNpemUgLSAxIHx8IHNoaXBDb29yZHMueSA+IHNpemUgLSAxKSByZXR1cm4gdHJ1ZTtcbiAgICAgIGlmIChhdChzaGlwQ29vcmRzKS5oYXNTaGlwICE9PSAnJykgcmV0dXJuIHRydWU7XG4gICAgICBjb25zdCBhZGphY2VudENvb3JkcyA9IGdldEFkamFjZW50Q29vcmRzQXJyYXkoc2hpcENvb3Jkcyk7XG4gICAgICBmb3IgKGNvbnN0IGNvb3JkcyBvZiBhZGphY2VudENvb3Jkcykge1xuICAgICAgICBpZiAoY29vcmRzLnggPiBzaXplIC0gMSB8fCBjb29yZHMueCA8IDAgfHwgY29vcmRzLnkgPiBzaXplIC0gMSB8fCBjb29yZHMueSA8IDApIGNvbnRpbnVlO1xuICAgICAgICBpZiAoYXQoY29vcmRzKS5oYXNTaGlwICE9PSAnJykgcmV0dXJuIHRydWU7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiBmYWxzZTtcbiAgfVxuXG4gIGNvbnN0IGdldEFkamFjZW50Q29vcmRzQXJyYXkgPSAoY29vcmRzKSA9PiB7XG4gICAgcmV0dXJuIFtcbiAgICAgIHt4OiBjb29yZHMueCArIDEsIHk6IGNvb3Jkcy55fSxcbiAgICAgIHt4OiBjb29yZHMueCAtIDEsIHk6IGNvb3Jkcy55fSxcbiAgICAgIHt4OiBjb29yZHMueCwgeTogY29vcmRzLnkgKyAxfSxcbiAgICAgIHt4OiBjb29yZHMueCwgeTogY29vcmRzLnkgLSAxfVxuICAgIF07XG4gIH1cblxuICBjb25zdCByZXNldCA9ICgpID0+IHtcbiAgICBzaGlwcyA9IFtdO1xuICAgIGZvciAoY29uc3QgY2VsbCBvZiBib2FyZCkge1xuICAgICAgY2VsbC5pc1Nob3QgPSBmYWxzZTtcbiAgICAgIGNlbGwuaGFzU2hpcCA9ICcnO1xuICAgIH1cbiAgfVxuXG4gIGNvbnN0IGFsbFNoaXBzU3VuayA9ICgpID0+IHtcbiAgICByZXR1cm4gc3VuayA+PSBzaGlwcy5sZW5ndGg7XG4gIH1cblxuICBjb25zdCBnZXRCb2FyZCA9ICgpID0+IGJvYXJkO1xuICBjb25zdCBnZXRTaGlwcyA9ICgpID0+IHNoaXBzO1xuXG4gIHJldHVybiB7XG4gICAgYXQsXG4gICAgaXNWYWxpZEF0dGFjayxcbiAgICBpc1NoaXBIaXQsXG4gICAgcmVjZWl2ZUF0dGFjayxcbiAgICBzZXRTaGlwLFxuICAgIGlzQ29sbGlzaW9ucyxcbiAgICBnZXRCb2FyZCxcbiAgICBnZXRTaGlwcyxcbiAgICByZXNldCxcbiAgICBhbGxTaGlwc1N1bmtcbiAgfTtcbn1cblxuZXhwb3J0IGRlZmF1bHQgR2FtZWJvYXJkOyIsImltcG9ydCBHYW1lYm9hcmQgZnJvbSBcIi4vR2FtZWJvYXJkXCJcblxuY29uc3QgUGxheWVyID0gKG5hbWUsIGRpc3BsYXlOYW1lKSA9PiB7XG4gIHJldHVybiB7XG4gICAgbmFtZSxcbiAgICBkaXNwbGF5TmFtZSxcbiAgICBnYW1lYm9hcmQ6IEdhbWVib2FyZCgxMCksXG4gICAgaXNBY3RpdmU6IGZhbHNlLFxuICB9O1xufVxuXG5leHBvcnQgZGVmYXVsdCBQbGF5ZXI7IiwiY29uc3QgU2hpcCA9IChsZW5ndGgsIG5hbWUpID0+IHtcbiAgY29uc3Qgc2hpcExlbmd0aCA9IGxlbmd0aDtcbiAgbGV0IGhpdENvdW50ID0gMDtcblxuICAvLyBHZXR0ZXJzXG4gIGNvbnN0IGdldExlbmd0aCA9ICgpID0+IHNoaXBMZW5ndGg7XG4gIGNvbnN0IGdldEhpdHMgPSAoKSA9PiBoaXRDb3VudDtcblxuICBjb25zdCBoaXQgPSAoKSA9PiB7XG4gICAgaGl0Q291bnQrKztcbiAgfVxuXG4gIGNvbnN0IGlzU3VuayA9ICgpID0+IHtcbiAgICByZXR1cm4gaGl0Q291bnQgPj0gc2hpcExlbmd0aDtcbiAgfVxuXG4gIHJldHVybiB7XG4gICAgbmFtZSxcbiAgICBnZXRMZW5ndGgsXG4gICAgZ2V0SGl0cyxcbiAgICBoaXQsXG4gICAgaXNTdW5rLFxuICB9O1xufVxuXG5leHBvcnQgZGVmYXVsdCBTaGlwOyIsImltcG9ydCBQbGF5ZXIgZnJvbSBcIi4uL0ZhY3Rvcmllcy9QbGF5ZXJcIjtcbmltcG9ydCBTaGlwIGZyb20gXCIuLi9GYWN0b3JpZXMvU2hpcFwiO1xuXG5jb25zdCBBSSA9ICgoKSA9PiB7XG5cbiAgY29uc3QgQUlwbGF5ZXIgPSBQbGF5ZXIoJ0FJJyk7XG4gIGNvbnN0IHNoaXBzID0gW1NoaXAoNSwgJ0NhcnJpZXInKSwgU2hpcCg0LCAnQmF0dGxlc2hpcCcpLCBTaGlwKDMsICdDcnVpc2VyJyksIFNoaXAoMywgJ1N1Ym1hcmluZScpLCBTaGlwKDIsICdEZXN0cm95ZXInKV07XG4gIGxldCBwcmV2U2hpcEhpdCA9IG51bGw7XG5cbiAgY29uc3QgcGxhY2VTaGlwcyA9ICgpID0+IHtcbiAgICBBSXBsYXllci5nYW1lYm9hcmQuc2V0U2hpcChzaGlwc1swXSwgeyB4OiAwLCB5OiAwIH0sICd4Jyk7XG4gICAgQUlwbGF5ZXIuZ2FtZWJvYXJkLnNldFNoaXAoc2hpcHNbMV0sIHsgeDogOSwgeTogNiB9LCAneScpO1xuICAgIEFJcGxheWVyLmdhbWVib2FyZC5zZXRTaGlwKHNoaXBzWzJdLCB7IHg6IDEsIHk6IDcgfSwgJ3knKTtcbiAgICBBSXBsYXllci5nYW1lYm9hcmQuc2V0U2hpcChzaGlwc1szXSwgeyB4OiA3LCB5OiAxIH0sICd4Jyk7XG4gICAgQUlwbGF5ZXIuZ2FtZWJvYXJkLnNldFNoaXAoc2hpcHNbNF0sIHsgeDogNCwgeTogMyB9LCAneCcpO1xuICB9XG5cbiAgY29uc3QgZ2V0UmFuZG9tVmFsaWRDb29yZHMgPSAoKSA9PiB7XG4gICAgY29uc3QgYm9hcmQgPSBBSXBsYXllci5nYW1lYm9hcmQuZ2V0Qm9hcmQoKTtcbiAgICBjb25zdCB2YWxpZENlbGxzID0gYm9hcmQuZmlsdGVyKGNlbGwgPT4gIWNlbGwuaXNTaG90KTtcbiAgICBjb25zdCBjb29yZHMgPSB2YWxpZENlbGxzW01hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIHZhbGlkQ2VsbHMubGVuZ3RoKV0uY29vcmRzO1xuICAgIHJldHVybiBjb29yZHM7XG4gIH1cblxuICBjb25zdCBnZXRWYWxpZEFkamFjZW50Q29vcmRzID0gKGNvb3JkcykgPT4ge1xuICAgIGNvbnN0IGFkamFjZW5jeSA9IFstMSwgMV07IC8vIDQtd2F5IGFkamFjZW5jeVxuICAgIGxldCBhZGphY2VudENvb3JkcyA9IFtdO1xuICAgIGZvcihjb25zdCBhZGphY2VudCBvZiBhZGphY2VuY3kpIHtcbiAgICAgIGZvciAoY29uc3Qga2V5IGluIGNvb3Jkcykge1xuICAgICAgICBjb25zdCBuZXdQb2ludCA9IGNvb3Jkc1trZXldICsgYWRqYWNlbnQ7XG4gICAgICAgIGlmIChuZXdQb2ludCA8PSA5ICYmIG5ld1BvaW50ID49IDApe1xuICAgICAgICAgIGFkamFjZW50Q29vcmRzLnB1c2goey4uLmNvb3JkcywgW2tleV06IG5ld1BvaW50fSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIGFkamFjZW50Q29vcmRzO1xuICB9XG5cbiAgZnVuY3Rpb24gc2h1ZmZsZUZpc2hlcllhdGVzKGFycmF5KSB7XG4gICAgbGV0IGkgPSBhcnJheS5sZW5ndGg7XG4gICAgd2hpbGUgKGktLSkge1xuICAgICAgY29uc3QgcmkgPSBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiBpKTtcbiAgICAgIFthcnJheVtpXSwgYXJyYXlbcmldXSA9IFthcnJheVtyaV0sIGFycmF5W2ldXTtcbiAgICB9XG4gICAgcmV0dXJuIGFycmF5O1xuICB9XG5cbiAgY29uc3Qgc3VtID0gKG9iajEsIG9iajIsIHN1YnRyYWN0ID0gZmFsc2UpID0+IHtcbiAgICByZXR1cm4gT2JqZWN0LmtleXMob2JqMSkucmVkdWNlKChhY2N1bXVsYXRvciwga2V5KSA9PiBcbiAgICAgICAgICAoey4uLmFjY3VtdWxhdG9yLCBba2V5XTogb2JqMVtrZXldICsgKHN1YnRyYWN0ID8gLTE6IDEpICogb2JqMltrZXldfSksIFxuICAgICAgICAgIHt9KTtcbiAgfVxuXG4gIGNvbnN0IHRyYWNlTGFzdFNoaXBIaXQgPSAoKSA9PiB7XG4gICAgY29uc3QgYWRqYWNlbnRDb29yZHMgPSBzaHVmZmxlRmlzaGVyWWF0ZXMoZ2V0VmFsaWRBZGphY2VudENvb3JkcyhwcmV2U2hpcEhpdCkpO1xuICAgIGZvciAoY29uc3QgY29vcmRzIG9mIGFkamFjZW50Q29vcmRzKSB7XG4gICAgICBsZXQgY2VsbCA9IEFJcGxheWVyLmdhbWVib2FyZC5hdChjb29yZHMpO1xuICAgICAgaWYgKGNlbGwuaXNTaG90ICYmIGNlbGwuaGFzU2hpcCkge1xuICAgICAgICBsZXQgbmV3Q29vcmRzID0gey4uLmNvb3Jkc307XG4gICAgICAgIGxldCBkaXJlY3Rpb24gPSBzdW0obmV3Q29vcmRzLCBwcmV2U2hpcEhpdCwgdHJ1ZSk7XG4gICAgICAgIHdoaWxlIChjZWxsLmlzU2hvdCAmJiBjZWxsLmhhc1NoaXApIHtcbiAgICAgICAgICBuZXdDb29yZHMgPSBzdW0obmV3Q29vcmRzLCBkaXJlY3Rpb24pO1xuICAgICAgICAgIGlmIChuZXdDb29yZHMueCA8IDAgfHwgbmV3Q29vcmRzLnggPiA5IHx8IG5ld0Nvb3Jkcy55IDwgMCB8fCBuZXdDb29yZHMueSA+IDkpIGJyZWFrO1xuICAgICAgICAgIGNlbGwgPSBBSXBsYXllci5nYW1lYm9hcmQuYXQobmV3Q29vcmRzKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoY2VsbC5pc1Nob3QpIHtcbiAgICAgICAgICByZXR1cm4gc3VtKHByZXZTaGlwSGl0LCBkaXJlY3Rpb24sIHRydWUpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBuZXdDb29yZHM7XG4gICAgICB9XG4gICAgfVxuICAgIGZvciAoY29uc3QgY29vcmRzIG9mIGFkamFjZW50Q29vcmRzKSB7XG4gICAgICBsZXQgY2VsbCA9IEFJcGxheWVyLmdhbWVib2FyZC5hdChjb29yZHMpO1xuICAgICAgaWYgKGNlbGwuaXNTaG90KSBjb250aW51ZTtcbiAgICAgIGVsc2UgcmV0dXJuIGNvb3JkcztcbiAgICB9XG4gIH1cblxuICBjb25zdCBnZXRDb29yZHMgPSAoZ2FtZWJvYXJkKSA9PiB7XG4gICAgbGV0IGNvb3JkcztcbiAgICBBSXBsYXllci5nYW1lYm9hcmQgPSBnYW1lYm9hcmQ7XG4gICAgaWYgKHByZXZTaGlwSGl0KSB7XG4gICAgICAvLyBpZiBwcmV2IGhpdCBzdW5rIGEgc2hpcCB0aGVuIHJlc2V0XG4gICAgICBpZiAoQUlwbGF5ZXIuZ2FtZWJvYXJkXG4gICAgICAuZ2V0U2hpcHMoKVxuICAgICAgLmZpbmQoc2hpcCA9PiBzaGlwLm5hbWUgPT09IEFJcGxheWVyLmdhbWVib2FyZC5hdChwcmV2U2hpcEhpdCkuaGFzU2hpcClcbiAgICAgIC5pc1N1bmsoKSkge1xuICAgICAgICBwcmV2U2hpcEhpdCA9IG51bGw7XG4gICAgICAgIGNvb3JkcyA9IGdldFJhbmRvbVZhbGlkQ29vcmRzKCk7XG4gICAgICB9IGVsc2UgY29vcmRzID0gdHJhY2VMYXN0U2hpcEhpdCgpO1xuICAgIH0gZWxzZSBjb29yZHMgPSBnZXRSYW5kb21WYWxpZENvb3JkcygpO1xuICAgIGlmIChBSXBsYXllci5nYW1lYm9hcmQuaXNTaGlwSGl0KGNvb3JkcykpIHByZXZTaGlwSGl0ID0gY29vcmRzO1xuICAgIHJldHVybiBjb29yZHM7XG4gIH07XG5cbiAgY29uc3QgZ2V0QUlQbGF5ZXIgPSAoKSA9PiB7XG4gICAgcGxhY2VTaGlwcygpO1xuICAgIHJldHVybiBBSXBsYXllcjtcbiAgfVxuXG4gIHJldHVybiB7XG4gICAgZ2V0Q29vcmRzLFxuICAgIGdldEFJUGxheWVyLFxuICB9O1xuXG59KSgpO1xuXG5leHBvcnQgZGVmYXVsdCBBSTsiLCJpbXBvcnQgUGxheWVyIGZyb20gXCIuLi9GYWN0b3JpZXMvUGxheWVyXCI7XG5pbXBvcnQgVUkgZnJvbSBcIi4vVUlcIjtcbmltcG9ydCBBSSBmcm9tIFwiLi9BSVBsYXllclwiO1xuaW1wb3J0IFBsYWNlU2hpcHMgZnJvbSBcIi4vUGxhY2VTaGlwc1wiO1xuXG5jb25zdCBHYW1lQ29udHJvbGxlciA9ICgoKSA9PiB7XG5cbiAgY29uc3QgcGxheWVyMSA9IFBsYXllcignUDEnLCAnUGxheWVyJyk7XG4gIGNvbnN0IHBsYXllcjIgPSBQbGF5ZXIoJ1AyJywgJ0VuZW15Jyk7XG5cbiAgZnVuY3Rpb24gc2xlZXAobXMpIHtcbiAgICByZXR1cm4gbmV3IFByb21pc2UocmVzb2x2ZSA9PiBzZXRUaW1lb3V0KHJlc29sdmUsIG1zKSk7XG4gIH0gXG5cbiAgY29uc3Qgb3Bwb25lbnQgPSAoKSA9PiB7XG4gICAgcmV0dXJuIHBsYXllcjEuaXNBY3RpdmUgPyBwbGF5ZXIyOiBwbGF5ZXIxO1xuICB9XG5cbiAgY29uc3QgYWN0aXZlUGxheWVyID0gKCkgPT4ge1xuICAgIHJldHVybiBwbGF5ZXIxLmlzQWN0aXZlID8gcGxheWVyMTogcGxheWVyMjtcbiAgfVxuXG4gIGNvbnN0IHRvZ2dsZUFjdGl2ZVBsYXllciA9ICgpID0+IHtcbiAgICBwbGF5ZXIxLmlzQWN0aXZlID0gIXBsYXllcjEuaXNBY3RpdmU7XG4gICAgcGxheWVyMi5pc0FjdGl2ZSA9ICFwbGF5ZXIyLmlzQWN0aXZlO1xuICAgIFVJLnRvZ2dsZUFjdGl2ZUJvYXJkKCk7XG4gIH1cblxuICBjb25zdCBpbml0UGxheWVyMSA9ICgpID0+IHtcbiAgICBwbGF5ZXIxLmlzQWN0aXZlID0gdHJ1ZTtcbiAgICBwbGF5ZXIxLmdhbWVib2FyZCA9IFBsYWNlU2hpcHMuZ2V0U2FtcGxlUGxheWVyKCkuZ2FtZWJvYXJkO1xuICAgIFVJLnJlbmRlckdhbWVib2FyZChwbGF5ZXIxLm5hbWUsIHBsYXllcjEuZ2FtZWJvYXJkLmdldEJvYXJkKCkpO1xuICAgIFVJLnVwZGF0ZVNoaXBzRGlzcGxheShwbGF5ZXIxLm5hbWUsIHBsYXllcjEuZ2FtZWJvYXJkLmdldFNoaXBzKCkpO1xuICB9XG5cbiAgY29uc3QgaW5pdFBsYXllcjIgPSAoKSA9PiB7XG4gICAgcGxheWVyMi5pc0FjdGl2ZSA9IGZhbHNlO1xuICAgIHBsYXllcjIuZ2FtZWJvYXJkID0gQUkuZ2V0QUlQbGF5ZXIoKS5nYW1lYm9hcmQ7XG4gICAgVUkucmVuZGVyR2FtZWJvYXJkKHBsYXllcjIubmFtZSwgcGxheWVyMi5nYW1lYm9hcmQuZ2V0Qm9hcmQoKSwgdHJ1ZSk7XG4gICAgVUkudXBkYXRlU2hpcHNEaXNwbGF5KHBsYXllcjIubmFtZSwgcGxheWVyMi5nYW1lYm9hcmQuZ2V0U2hpcHMoKSk7XG5cbiAgfVxuXG4gIGNvbnN0IHBsYXlUdXJuID0gYXN5bmMgKGNvb3JkcykgPT4ge1xuICAgIGNvbnN0IG9wcG9uZW50Qm9hcmQgPSBvcHBvbmVudCgpLmdhbWVib2FyZDtcbiAgICBpZiAoIW9wcG9uZW50Qm9hcmQuaXNWYWxpZEF0dGFjayhjb29yZHMpKSByZXR1cm47XG5cbiAgICBvcHBvbmVudEJvYXJkLnJlY2VpdmVBdHRhY2soY29vcmRzKTtcbiAgICBcbiAgICBpZiAoIW9wcG9uZW50Qm9hcmQuaXNTaGlwSGl0KGNvb3JkcykpIHtcbiAgICAgIGF3YWl0IHNsZWVwKDMwMCk7XG4gICAgICB0b2dnbGVBY3RpdmVQbGF5ZXIoKTtcbiAgICB9IGVsc2Uge1xuICAgICAgVUkudXBkYXRlU2hpcHNEaXNwbGF5KG9wcG9uZW50KCkubmFtZSwgb3Bwb25lbnRCb2FyZC5nZXRTaGlwcygpKTtcbiAgICAgIGlmIChvcHBvbmVudEJvYXJkLmFsbFNoaXBzU3VuaygpKSB7XG4gICAgICAgIFVJLnNob3dXaW5uZXIoYWN0aXZlUGxheWVyKCkuZGlzcGxheU5hbWUpO1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG4gICAgfVxuICAgIHBsYXlHYW1lKCk7XG4gIH1cblxuICBjb25zdCBwbGF5R2FtZSA9IGFzeW5jICgpID0+IHtcbiAgICBpZiAocGxheWVyMi5pc0FjdGl2ZSkge1xuICAgICAgYXdhaXQgc2xlZXAoTWF0aC5yYW5kb20oKSozMDAgKyAzMDApO1xuICAgICAgcGxheVR1cm4oQUkuZ2V0Q29vcmRzKG9wcG9uZW50KCkuZ2FtZWJvYXJkKSk7XG4gICAgfVxuICB9XG5cbiAgY29uc3QgaW5pdCA9ICgpID0+IHtcbiAgICBpbml0UGxheWVyMSgpO1xuICAgIGluaXRQbGF5ZXIyKCk7XG4gIH07XG5cbiAgcmV0dXJuIHtcbiAgICBpbml0LFxuICAgIHBsYXlUdXJuLFxuICB9O1xuXG59KSgpO1xuXG5leHBvcnQgZGVmYXVsdCBHYW1lQ29udHJvbGxlcjsiLCJpbXBvcnQgR2FtZUNvbnRyb2xsZXIgZnJvbSBcIi4vR2FtZUNvbnRyb2xsZXJcIjtcbmltcG9ydCBQbGF5ZXIgZnJvbSBcIi4uL0ZhY3Rvcmllcy9QbGF5ZXJcIjtcbmltcG9ydCBTaGlwIGZyb20gXCIuLi9GYWN0b3JpZXMvU2hpcFwiO1xuaW1wb3J0IFVJIGZyb20gXCIuL1VJXCI7XG5cbmNvbnN0IFBsYWNlU2hpcHMgPSAoKCkgPT4ge1xuICBjb25zdCBwbGF5ZXIgPSBQbGF5ZXIoJ3NhbXBsZScpO1xuICBjb25zdCBzaGlwcyA9IFtTaGlwKDUsICdDYXJyaWVyJyksIFNoaXAoNCwgJ0JhdHRsZXNoaXAnKSwgU2hpcCgzLCAnQ3J1aXNlcicpLCBTaGlwKDMsICdTdWJtYXJpbmUnKSwgU2hpcCgyLCAnRGVzdHJveWVyJyldO1xuICBsZXQgY3VycmVudCA9IHtcbiAgICBzaGlwTnVtOiAwLFxuICAgIHNoaXBDb29yZHNBcnJheTogW10sXG4gICAgYXhpczogJ3gnXG4gIH07XG4gIGNvbnN0ICRtb2RhbCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJy5tb2RhbCcpO1xuICBjb25zdCAkcGxheUJ1dHRvbiA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJ2J1dHRvbi5wbGF5Jyk7XG4gIGNvbnN0ICRyZXNldEJ1dHRvbiA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJ2J1dHRvbi5yZXNldCcpO1xuXG4gIC8vIFV0aWwgXG5cbiAgY29uc3QgY2VsbEF0ID0gKGNvb3JkcykgPT4ge1xuICAgIHJldHVybiBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKGBbZGF0YS1jb29yZHM9XCIke2Nvb3Jkcy54fSAke2Nvb3Jkcy55fVwiXWApO1xuICB9XG5cbiAgLy8gRE9NXG5cbiAgY29uc3Qgc2hvd1NoaXAgPSAoY29vcmRzKSA9PiB7XG4gICAgaWYgKGN1cnJlbnQuc2hpcE51bSA+PSBzaGlwcy5sZW5ndGgpIHJldHVybjtcbiAgICBpZiAoY3VycmVudC5zaGlwQ29vcmRzQXJyYXkubGVuZ3RoICE9PSAwKSB7XG4gICAgICBjdXJyZW50LnNoaXBDb29yZHNBcnJheS5mb3JFYWNoKGNvb3JkcyA9PiB7XG4gICAgICAgIGNlbGxBdChjb29yZHMpLmNsYXNzTGlzdC5yZW1vdmUoJ3RlbXAnKTtcbiAgICAgICAgY2VsbEF0KGNvb3JkcykuY2xhc3NMaXN0LnJlbW92ZSgnaW52YWxpZCcpO1xuICAgICAgfSlcbiAgICB9XG4gICAgY3VycmVudC5zaGlwQ29vcmRzQXJyYXkgPSBtYWtlU2hpcChjb29yZHMpO1xuICAgIGN1cnJlbnQuc2hpcENvb3Jkc0FycmF5LmZvckVhY2goY29vcmRzID0+IHtcbiAgICAgIGNlbGxBdChjb29yZHMpLmNsYXNzTGlzdC5hZGQoXCJ0ZW1wXCIpO1xuICAgIH0pXG4gICAgaWYgKCFpc1NoaXBWYWxpZCgpKSB7XG4gICAgICBjdXJyZW50LnNoaXBDb29yZHNBcnJheS5mb3JFYWNoKGNvb3JkcyA9PiB7XG4gICAgICAgIGNlbGxBdChjb29yZHMpLmNsYXNzTGlzdC5hZGQoXCJpbnZhbGlkXCIpO1xuICAgICAgfSlcbiAgICB9XG4gIH1cblxuICBjb25zdCBtYWtlU2hpcCA9IChjb29yZHMpID0+IHtcbiAgICBsZXQgc2hpcENvb3Jkc0FycmF5ID0gW107XG4gICAgbGV0IG5ld0Nvb3JkcyA9IGNvb3JkcztcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHNoaXBzW2N1cnJlbnQuc2hpcE51bV0uZ2V0TGVuZ3RoKCk7IGkrKykge1xuICAgICAgc2hpcENvb3Jkc0FycmF5LnB1c2goe3g6IG5ld0Nvb3Jkcy54LCB5OiBuZXdDb29yZHMueX0pO1xuICAgICAgY3VycmVudC5heGlzID09PSAneCcgPyBuZXdDb29yZHMueCsrOiBuZXdDb29yZHMueSsrO1xuICAgICAgaWYgKG5ld0Nvb3Jkcy54ID4gOSB8fCBuZXdDb29yZHMueSA+IDkpIGJyZWFrO1xuICAgIH1cbiAgICByZXR1cm4gc2hpcENvb3Jkc0FycmF5O1xuICB9XG5cbiAgY29uc3QgaXNTaGlwVmFsaWQgPSAoKSA9PiB7XG4gICAgcmV0dXJuICghcGxheWVyLmdhbWVib2FyZC5pc0NvbGxpc2lvbnMoY3VycmVudC5zaGlwQ29vcmRzQXJyYXkpICYmIFxuICAgICAgICAgIGN1cnJlbnQuc2hpcENvb3Jkc0FycmF5Lmxlbmd0aCA9PT0gc2hpcHNbY3VycmVudC5zaGlwTnVtXS5nZXRMZW5ndGgoKSk7XG4gIH1cblxuICBcbiAgY29uc3QgcGxhY2VTaGlwID0gKGNvb3JkcykgPT4ge1xuICAgIGlmICghaXNTaGlwVmFsaWQoKSkgcmV0dXJuO1xuICAgIHBsYXllci5nYW1lYm9hcmQuc2V0U2hpcChzaGlwc1tjdXJyZW50LnNoaXBOdW0rK10sIGNvb3JkcywgY3VycmVudC5heGlzKTtcbiAgICBjdXJyZW50LnNoaXBDb29yZHNBcnJheS5mb3JFYWNoKGNvb3JkcyA9PiB7XG4gICAgICBjZWxsQXQoY29vcmRzKS5jbGFzc0xpc3QuYWRkKCdzaGlwJyk7XG4gICAgICBjZWxsQXQoY29vcmRzKS5jbGFzc0xpc3QucmVtb3ZlKCd0ZW1wJyk7XG4gICAgfSk7XG4gICAgVUkudXBkYXRlU2hpcHNEaXNwbGF5KHBsYXllci5uYW1lLCBzaGlwcywgY3VycmVudC5zaGlwTnVtIC0gMSk7XG4gICAgaWYgKGN1cnJlbnQuc2hpcE51bSA9PT0gc2hpcHMubGVuZ3RoKSB7XG4gICAgICAkcGxheUJ1dHRvbi5zdHlsZS5kaXNwbGF5ID0gJ2Jsb2NrJztcbiAgICB9XG4gIH1cblxuICBjb25zdCByZXNldCA9ICgpID0+IHtcbiAgICBwbGF5ZXIuZ2FtZWJvYXJkLnJlc2V0KCk7XG4gICAgcGxheWVyLmdhbWVib2FyZC5nZXRCb2FyZCgpLmZvckVhY2goY2VsbCA9PiB7XG4gICAgICBjZWxsQXQoY2VsbC5jb29yZHMpLmNsYXNzTGlzdC5yZW1vdmUoJ3NoaXAnKTtcbiAgICAgIGNlbGxBdChjZWxsLmNvb3JkcykuY2xhc3NMaXN0LnJlbW92ZSgndGVtcCcpO1xuICAgICAgY2VsbEF0KGNlbGwuY29vcmRzKS5jbGFzc0xpc3QucmVtb3ZlKCdpbnZhbGlkJyk7XG4gICAgfSk7XG4gICAgY29uc3QgJHNoaXBDb250YWluZXJzID0gQXJyYXkuZnJvbShkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcuc2hpcHMtZGlzcGxheScpLmNoaWxkcmVuKTtcbiAgICAkc2hpcENvbnRhaW5lcnMuZm9yRWFjaCgkc2hpcENvbnRhaW5lciA9PiAkc2hpcENvbnRhaW5lci5jbGFzc0xpc3QucmVtb3ZlKCdzdW5rJykpO1xuICAgIGN1cnJlbnQgPSB7XG4gICAgICBzaGlwTnVtOiAwLFxuICAgICAgc2hpcENvb3Jkc0FycmF5OiBbXSxcbiAgICAgIGF4aXM6ICd4J1xuICAgIH07XG4gICAgJHBsYXlCdXR0b24uc3R5bGUuZGlzcGxheSA9ICdub25lJztcbiAgfVxuICBcbiAgY29uc3QgZ2V0U2FtcGxlUGxheWVyID0gKCkgPT4gcGxheWVyO1xuXG4gIGNvbnN0IGluaXQgPSAoKSA9PiB7XG4gICAgVUkucmVuZGVyR2FtZWJvYXJkKHBsYXllci5uYW1lLCBwbGF5ZXIuZ2FtZWJvYXJkLmdldEJvYXJkKCkpO1xuICAgIFVJLnVwZGF0ZVNoaXBzRGlzcGxheShwbGF5ZXIubmFtZSwgc2hpcHMpO1xuXG4gICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigna2V5dXAnLCAoeyBrZXkgfSkgPT4ge1xuICAgICAgaWYgKGtleSA9PT0gJ1InIHx8IGtleSA9PT0gJ3InKSB7XG4gICAgICAgIGN1cnJlbnQuYXhpcyA9IGN1cnJlbnQuYXhpcyA9PT0gJ3gnID8gJ3knOiAneCc7XG4gICAgICAgIHNob3dTaGlwKGN1cnJlbnQuc2hpcENvb3Jkc0FycmF5WzBdLCBjdXJyZW50LmF4aXMpO1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgJHBsYXlCdXR0b24uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoKSA9PiB7XG4gICAgICAkbW9kYWwucmVtb3ZlKCk7XG4gICAgICBHYW1lQ29udHJvbGxlci5pbml0KCk7XG4gICAgfSlcblxuICAgICRyZXNldEJ1dHRvbi5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIHJlc2V0KTtcbiAgfVxuXG4gIHJldHVybiB7XG4gICAgaW5pdCxcbiAgICBwbGFjZVNoaXAsXG4gICAgc2hvd1NoaXAsXG4gICAgZ2V0U2FtcGxlUGxheWVyLFxuICB9XG5cbn0pKCk7XG5cbmV4cG9ydCBkZWZhdWx0IFBsYWNlU2hpcHM7IiwiLy8gaW1wb3J0IEdhbWVDb250cm9sbGVyIGZyb20gXCIuL01vZHVsZXMvR2FtZUNvbnRyb2xsZXJcIjtcbmltcG9ydCBQbGFjZVNoaXBzIGZyb20gXCIuL01vZHVsZXMvUGxhY2VTaGlwc1wiO1xuXG5QbGFjZVNoaXBzLmluaXQoKTsiXSwibmFtZXMiOlsiJGdhbWVib2FyZHNDb250YWluZXIiLCJkb2N1bWVudCIsInF1ZXJ5U2VsZWN0b3IiLCIkbW9kYWwiLCIkd2luTW9kYWwiLCJtb2RlIiwiZGVjb2RlQ29vcmRzIiwiY29vcmRzU3RyaW5nIiwiY29vcmRzQXJyYXkiLCJzcGxpdCIsIngiLCJ5IiwiY3JlYXRlSHRtbEVsZW1lbnQiLCJ0eXBlIiwiY2xhc3NBcnJheSIsInRleHQiLCJlbGVtZW50IiwiY3JlYXRlRWxlbWVudCIsImZvckVhY2giLCJjbHMiLCJjbGFzc0xpc3QiLCJhZGQiLCJ0ZXh0Q29udGVudCIsInJlbmRlckdhbWVib2FyZCIsInBsYXllck5hbWUiLCJib2FyZCIsImlzQWN0aXZlIiwiJGNvbnRhaW5lciIsImFwcGVuZENoaWxkIiwibmV3R2FtZWJvYXJkQ29udGFpbmVyRE9NIiwiZmlyc3RDaGlsZCIsImNlbGwiLCIkY2VsbCIsInNldEF0dHJpYnV0ZSIsImNvb3JkcyIsImhhc1NoaXAiLCJhZGRFdmVudExpc3RlbmVyIiwiZ2V0QXR0cmlidXRlIiwiYWRkQ2VsbExpc3RlbmVyIiwibmV3Q2VsbERPTSIsInVwZGF0ZVNoaXBzRGlzcGxheSIsInNoaXBzIiwic2hpcE51bSIsIiRzaGlwc0Rpc3BsYXkiLCJuZXh0RWxlbWVudFNpYmxpbmciLCJzaGlwIiwiaW5kZXgiLCJpc1BsYWNlZCIsIiRzaGlwQ29udGFpbmVyIiwiaXNTdW5rIiwibmFtZSIsIiRzaGlwQm9keSIsImkiLCJnZXRMZW5ndGgiLCJuZXdTaGlwRE9NIiwiY2VsbEhpdCIsImVuY29kZWRDb29yZHMiLCJzaGlwU3VuayIsInRvZ2dsZUFjdGl2ZUJvYXJkIiwiQXJyYXkiLCJmcm9tIiwiY2hpbGRyZW4iLCIkZ2FtZWJvYXJkQ29udGFpbmVyIiwiY29udGFpbnMiLCJ0b2dnbGUiLCJzaG93V2lubmVyIiwicGxheWVyRGlzcGxheU5hbWUiLCJzaXplIiwic3VuayIsImFyciIsInB1c2giLCJNYXRoIiwiZmxvb3IiLCJpc1Nob3QiLCJfbWFrZUdyaWQiLCJhdCIsImlzVmFsaWRBdHRhY2siLCJpc1NoaXBIaXQiLCJyZWNlaXZlQXR0YWNrIiwiZmluZCIsImhpdCIsInNoaXBOYW1lIiwiZmlsdGVyIiwibWFwIiwic2V0U2hpcCIsImF4aXMiLCJuZXdDb29yZHMiLCJpc0NvbGxpc2lvbnMiLCJzaGlwQ29vcmRzQXJyYXkiLCJzaGlwQ29vcmRzIiwiYWRqYWNlbnRDb29yZHMiLCJnZXRCb2FyZCIsImdldFNoaXBzIiwicmVzZXQiLCJhbGxTaGlwc1N1bmsiLCJsZW5ndGgiLCJkaXNwbGF5TmFtZSIsImdhbWVib2FyZCIsInNoaXBMZW5ndGgiLCJoaXRDb3VudCIsImdldEhpdHMiLCJBSXBsYXllciIsInByZXZTaGlwSGl0IiwiZ2V0UmFuZG9tVmFsaWRDb29yZHMiLCJ2YWxpZENlbGxzIiwicmFuZG9tIiwic3VtIiwib2JqMSIsIm9iajIiLCJzdWJ0cmFjdCIsIk9iamVjdCIsImtleXMiLCJyZWR1Y2UiLCJhY2N1bXVsYXRvciIsImtleSIsImdldENvb3JkcyIsImFycmF5IiwicmkiLCJzaHVmZmxlRmlzaGVyWWF0ZXMiLCJhZGphY2VuY3kiLCJhZGphY2VudCIsIm5ld1BvaW50IiwiZ2V0VmFsaWRBZGphY2VudENvb3JkcyIsImRpcmVjdGlvbiIsInRyYWNlTGFzdFNoaXBIaXQiLCJnZXRBSVBsYXllciIsInBsYXllcjEiLCJwbGF5ZXIyIiwic2xlZXAiLCJtcyIsIlByb21pc2UiLCJyZXNvbHZlIiwic2V0VGltZW91dCIsIm9wcG9uZW50IiwicGxheVR1cm4iLCJhc3luYyIsIm9wcG9uZW50Qm9hcmQiLCJwbGF5R2FtZSIsImluaXQiLCJwbGF5ZXIiLCJjdXJyZW50IiwiJHBsYXlCdXR0b24iLCIkcmVzZXRCdXR0b24iLCJjZWxsQXQiLCJzaG93U2hpcCIsInJlbW92ZSIsIm1ha2VTaGlwIiwiaXNTaGlwVmFsaWQiLCJzdHlsZSIsImRpc3BsYXkiLCJwbGFjZVNoaXAiLCJnZXRTYW1wbGVQbGF5ZXIiXSwic291cmNlUm9vdCI6IiJ9