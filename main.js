(()=>{"use strict";const e=(()=>{const e=document.querySelector(".main"),t=document.querySelector(".modal"),s=document.querySelector(".modal-win");let a="PLAY";const r=e=>{const t=e.split(" ");return{x:+t[0],y:+t[1]}},n=(e,t=null,s=null)=>{const a=document.createElement(e);return t&&t.forEach((e=>a.classList.add(e))),s&&(a.textContent=s),a};return{renderGameboard:(s,d,c,h=!1)=>{a="sample"===d?"PLACE":"PLAY";const l=(s=>{const r=n("div",["container"]);return r.appendChild(n("div",[`${s}`,"board"])),r.appendChild(n("div",["ships-display"])),"PLACE"===a?t.appendChild(r):e.appendChild(r),r})(d);h&&l.firstChild.classList.add("active"),c.forEach((e=>l.firstChild.appendChild((e=>{const t=n("div",["cell"]);return t.setAttribute("data-coords",`${e.coords.x} ${e.coords.y}`),e.hasShip&&t.classList.add("ship"),(e=>{"PLACE"===a?(e.addEventListener("click",(()=>{o.placeShip(r(e.getAttribute("data-coords")))})),e.addEventListener("mouseover",(()=>{o.showShip(r(e.getAttribute("data-coords")))}))):e.addEventListener("click",(()=>{i.playTurn(r(e.getAttribute("data-coords")))}))})(t),t})(e))))},updateShipsDisplay:(e,t,s=-1)=>{const r=document.querySelector(`.${e}`).nextElementSibling;r.textContent="",t.forEach(((e,t)=>{r.appendChild(((e,t=!1)=>{const s=n("div",["ship-container"]);(e.isSunk()||"PLACE"===a&&t)&&s.classList.add("sunk"),s.appendChild(n("div",["ship-name"],e.name));const r=n("div",["ship-body"]);for(let t=0;t<e.getLength();t++)r.appendChild(n("div",["ship-cell"]));return s.appendChild(r),s})(e,t<=s))}))},cellHit:e=>{const t=`${e.x} ${e.y}`;document.querySelector(`.active > [data-coords="${t}"]`).classList.add("hit")},shipSunk:e=>{e.forEach((e=>{document.querySelector(`.active > [data-coords="${e.x} ${e.y}"]`).classList.add("sunk")}))},toggleActiveBoard:()=>{Array.from(e.children).forEach((e=>{e.firstChild.classList.toggle("active")}))},showWinner:e=>{s.textContent=`${e} wins`,s.classList.add("visible")}}})(),t=t=>{let s=[],a=0;const r=(e=>{const t=[];for(let s=0;s<e*e;s++)t.push({coords:{x:s%e,y:Math.floor(s/e)},hasShip:"",isShot:!1});return t})(t),i=e=>r[e.x+e.y*t];return{at:i,isValidAttack:e=>!i(e).isShot,isShipHit:e=>""!==i(e).hasShip,receiveAttack:t=>{const o=i(t);if(o.isShot=!0,e.cellHit(t),o.hasShip){const t=s.find((e=>e.name===o.hasShip));t.hit(),t.isSunk()&&(t=>{a++;const s=r.filter((e=>e.hasShip===t)).map((e=>e.coords));e.shipSunk(s)})(t.name)}},setShip:(e,t,a="x")=>{s.push(e);let r=t;for(let t=0;t<e.getLength();t++)i(r).hasShip=e.name,"x"===a?r.x++:r.y++},isCollisions:e=>{for(const a of e){if(a.x>t-1||a.y>t-1)return!0;if(""!==i(a).hasShip)return!0;const e=[{x:(s=a).x+1,y:s.y},{x:s.x-1,y:s.y},{x:s.x,y:s.y+1},{x:s.x,y:s.y-1}];for(const s of e)if(!(s.x>t-1||s.x<0||s.y>t-1||s.y<0)&&""!==i(s).hasShip)return!0}var s;return!1},getBoard:()=>r,getShips:()=>s,reset:()=>{s=[];for(const e of r)e.isShot=!1,e.hasShip=""},allShipsSunk:()=>a>=s.length}},s=(e,s)=>({name:e,displayName:s,gameboard:t(10),isActive:!1}),a=(e,t)=>{const s=e;let a=0;return{name:t,getLength:()=>s,getHits:()=>a,hit:()=>{a++},isSunk:()=>a>=s}},r=(()=>{const e=s("AI"),t=[a(5,"Carrier"),a(4,"Battleship"),a(3,"Cruiser"),a(3,"Submarine"),a(2,"Destroyer")];let r=null;const i=()=>{const t=e.gameboard.getBoard().filter((e=>!e.isShot));return t[Math.floor(Math.random()*t.length)].coords};return{getCoords:t=>{let s;return e.gameboard=t,r?e.gameboard.getShips().find((t=>t.name===e.gameboard.at(r).hasShip)).isSunk()?(r=null,s=i()):s=(()=>{const t=function(e){let t=e.length;for(;t--;){const s=Math.floor(Math.random()*t);[e[t],e[s]]=[e[s],e[t]]}return e}([{x:r.x+1,y:r.y},{x:r.x-1,y:r.y},{x:r.x,y:r.y+1},{x:r.x,y:r.y-1}]);let s;for(const a of t){if(a.x<0||a.x>9||a.y<0||a.y>9)continue;let t=e.gameboard.at(a),i=Object.assign({},a);if(t.isShot&&t.hasShip){for(s={x:i.x-r.x,y:i.y-r.y};t.isShot&&t.hasShip;)i.x+=s.x,i.y+=s.y,t=e.gameboard.at(i);if(t.isShot){const e=Object.assign({},r);return e.x-=s.x,e.y-=s.y,e}return i}}for(const s of t)if(!(s.x<0||s.x>9||s.y<0||s.y>9||e.gameboard.at(s).isShot))return s})():s=i(),e.gameboard.isShipHit(s)&&(r=s),s},getAIPlayer:()=>(e.gameboard.setShip(t[0],{x:0,y:0},"x"),e.gameboard.setShip(t[1],{x:9,y:6},"y"),e.gameboard.setShip(t[2],{x:1,y:7},"y"),e.gameboard.setShip(t[3],{x:7,y:1},"x"),e.gameboard.setShip(t[4],{x:4,y:3},"x"),e)}})(),i=(()=>{const t=s("P1","Player"),a=s("P2","Enemy");function i(e){return new Promise((t=>setTimeout(t,e)))}const n=()=>t.isActive?a:t,d=async s=>{const r=n().gameboard;if(r.isValidAttack(s)){if(r.receiveAttack(s),e.updateShipsDisplay(n().name,r.getShips()),r.isShipHit(s)){if(r.allShipsSunk())return void e.showWinner((t.isActive?t:a).displayName)}else await i(300),t.isActive=!t.isActive,a.isActive=!a.isActive,e.toggleActiveBoard();c()}},c=async()=>{a.isActive&&(await i(300*Math.random()+500),d(r.getCoords(n().gameboard)))};return{init:()=>{t.isActive=!0,t.gameboard=o.getSamplePlayer().gameboard,e.renderGameboard("P1",t.name,t.gameboard.getBoard()),e.updateShipsDisplay(t.name,t.gameboard.getShips()),a.isActive=!1,a.gameboard=r.getAIPlayer().gameboard,e.renderGameboard("P2",a.name,a.gameboard.getBoard(),!0),e.updateShipsDisplay(a.name,a.gameboard.getShips())},playTurn:d}})(),o=(()=>{const t=s("sample"),r=[a(5,"Carrier"),a(4,"Battleship"),a(3,"Cruiser"),a(3,"Submarine"),a(2,"Destroyer")];let o={shipNum:0,shipCoordsArray:[],axis:"x"};const n=document.querySelector(".modal"),d=document.querySelector("button.play"),c=document.querySelector("button.reset"),h=e=>document.querySelector(`[data-coords="${e.x} ${e.y}"]`),l=e=>{o.shipNum>=r.length||(0!==o.shipCoordsArray.length&&o.shipCoordsArray.forEach((e=>{h(e).classList.remove("temp"),h(e).classList.remove("invalid")})),o.shipCoordsArray=p(e),o.shipCoordsArray.forEach((e=>{h(e).classList.add("temp")})),m()||o.shipCoordsArray.forEach((e=>{h(e).classList.add("invalid")})))},p=e=>{let t=[],s=e;for(let e=0;e<r[o.shipNum].getLength()&&(t.push({x:s.x,y:s.y}),"x"===o.axis?s.x++:s.y++,!(s.x>9||s.y>9));e++);return t},m=()=>!t.gameboard.isCollisions(o.shipCoordsArray)&&o.shipCoordsArray.length===r[o.shipNum].getLength(),y=()=>{t.gameboard.reset(),t.gameboard.getBoard().forEach((e=>{h(e.coords).classList.remove("ship"),h(e.coords).classList.remove("temp")})),Array.from(document.querySelector(".ships-display").children).forEach((e=>e.classList.remove("sunk"))),o={shipNum:0,shipCoordsArray:[],axis:"x"},d.style.display="none"};return{init:()=>{e.renderGameboard("sample",t.name,t.gameboard.getBoard()),e.updateShipsDisplay(t.name,r),document.addEventListener("keyup",(({key:e})=>{"R"!==e&&"r"!==e||(o.axis="x"===o.axis?"y":"x",l(o.shipCoordsArray[0],o.axis))})),d.addEventListener("click",(()=>{n.remove(),i.init()})),c.addEventListener("click",y)},placeShip:s=>{m()&&(t.gameboard.setShip(r[o.shipNum++],s,o.axis),o.shipCoordsArray.forEach((e=>{h(e).classList.add("ship"),h(e).classList.remove("temp")})),e.updateShipsDisplay(t.name,r,o.shipNum-1),o.shipNum===r.length&&(d.style.display="block"))},showShip:l,getSamplePlayer:()=>t}})();o.init()})();
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWFpbi5qcyIsIm1hcHBpbmdzIjoibUJBR0EsTUFnSEEsRUFoSFcsTUFDVCxNQUFNQSxFQUFRQyxTQUFTQyxjQUFjLFNBQy9CQyxFQUFTRixTQUFTQyxjQUFjLFVBQ2hDRSxFQUFZSCxTQUFTQyxjQUFjLGNBQ3pDLElBQUlHLEVBQU8sT0FFWCxNQUFNQyxFQUFnQkMsSUFDcEIsTUFBTUMsRUFBY0QsRUFBYUUsTUFBTSxLQUN2QyxNQUFPLENBQUNDLEdBQUlGLEVBQVksR0FBSUcsR0FBSUgsRUFBWSxLQUd4Q0ksRUFBb0IsQ0FBQ0MsRUFBTUMsRUFBYSxLQUFNQyxFQUFPLFFBQ3pELE1BQU1DLEVBQVVmLFNBQVNnQixjQUFjSixHQUd2QyxPQUZJQyxHQUFZQSxFQUFXSSxTQUFRQyxHQUFPSCxFQUFRSSxVQUFVQyxJQUFJRixLQUM1REosSUFBTUMsRUFBUU0sWUFBY1AsR0FDekJDLEdBc0ZULE1BQU8sQ0FDTE8sZ0JBakNzQixDQUFDQyxFQUFRQyxFQUFZQyxFQUFPQyxHQUFXLEtBQzdEdEIsRUFBc0IsV0FBZm9CLEVBQTBCLFFBQVMsT0FDMUMsTUFBTUcsRUFYeUIsQ0FBQ0gsSUFDaEMsTUFBTUcsRUFBYWhCLEVBQWtCLE1BQU8sQ0FBQyxjQUs3QyxPQUpBZ0IsRUFBV0MsWUFBWWpCLEVBQWtCLE1BQU8sQ0FBQyxHQUFHYSxJQUFjLFdBQ2xFRyxFQUFXQyxZQUFZakIsRUFBa0IsTUFBTyxDQUFDLG1CQUNwQyxVQUFUUCxFQUFrQkYsRUFBTzBCLFlBQVlELEdBQ3BDNUIsRUFBTTZCLFlBQVlELEdBQ2hCQSxHQUtZRSxDQUF5QkwsR0FDeENFLEdBQVVDLEVBQVdHLFdBQVdYLFVBQVVDLElBQUksVUFDbERLLEVBQU1SLFNBQVFjLEdBQVFKLEVBQVdHLFdBQVdGLFlBdkQzQixDQUFDRyxJQUNoQixNQUFNQyxFQUFRckIsRUFBa0IsTUFBTyxDQUFDLFNBSXhDLE9BSEFxQixFQUFNQyxhQUFhLGNBQWUsR0FBR0YsRUFBS0csT0FBT3pCLEtBQUtzQixFQUFLRyxPQUFPeEIsS0FDOURxQixFQUFLSSxTQUFTSCxFQUFNYixVQUFVQyxJQUFJLFFBS2xCLENBQUNZLElBQ1YsVUFBVDVCLEdBQ0Y0QixFQUFNSSxpQkFBaUIsU0FBUyxLQUM5QixZQUFxQi9CLEVBQWEyQixFQUFNSyxhQUFhLG9CQUd2REwsRUFBTUksaUJBQWlCLGFBQWEsS0FDbEMsV0FBb0IvQixFQUFhMkIsRUFBTUssYUFBYSxxQkFHbkRMLEVBQU1JLGlCQUFpQixTQUFTLEtBQ25DLFdBQXdCL0IsRUFBYTJCLEVBQU1LLGFBQWEscUJBZnhEQyxDQUFnQk4sR0FDVEEsR0FrRCtDTyxDQUFXUixPQThCbkVTLG1CQWZ5QixDQUFDaEIsRUFBWWlCLEVBQU9DLEdBQVUsS0FDdkQsTUFBTUMsRUFBZ0IzQyxTQUFTQyxjQUFjLElBQUl1QixLQUFjb0IsbUJBQy9ERCxFQUFjdEIsWUFBYyxHQUM1Qm9CLEVBQU14QixTQUFRLENBQUM0QixFQUFNQyxLQUNuQkgsRUFBY2YsWUFoQkMsRUFBQ2lCLEVBQU1FLEdBQVcsS0FDbkMsTUFBTUMsRUFBaUJyQyxFQUFrQixNQUFPLENBQUMsb0JBQzdDa0MsRUFBS0ksVUFBc0IsVUFBVDdDLEdBQW9CMkMsSUFBV0MsRUFBZTdCLFVBQVVDLElBQUksUUFDbEY0QixFQUFlcEIsWUFBWWpCLEVBQWtCLE1BQU8sQ0FBQyxhQUFja0MsRUFBS0ssT0FDeEUsTUFBTUMsRUFBWXhDLEVBQWtCLE1BQU8sQ0FBQyxjQUM1QyxJQUFLLElBQUl5QyxFQUFJLEVBQUdBLEVBQUlQLEVBQUtRLFlBQWFELElBQ3BDRCxFQUFVdkIsWUFBWWpCLEVBQWtCLE1BQU8sQ0FBQyxlQUdsRCxPQURBcUMsRUFBZXBCLFlBQVl1QixHQUNwQkgsR0FPcUJNLENBQVdULEVBQU1DLEdBQVNKLFFBWXREYSxRQS9EZXJCLElBQ2YsTUFBTXNCLEVBQWdCLEdBQUd0QixFQUFPekIsS0FBS3lCLEVBQU94QixJQUM5QlYsU0FBU0MsY0FBYywyQkFBMkJ1RCxPQUMxRHJDLFVBQVVDLElBQUksUUE2RHBCcUMsU0FuRGdCbEQsSUFDaEJBLEVBQVlVLFNBQVFpQixJQUNsQmxDLFNBQVNDLGNBQWMsMkJBQTJCaUMsRUFBT3pCLEtBQUt5QixFQUFPeEIsT0FBT1MsVUFBVUMsSUFBSSxZQWtENUZzQyxrQkEzRHdCLEtBQ0tDLE1BQU1DLEtBQUs3RCxFQUFNOEQsVUFDekI1QyxTQUFRNkMsSUFDM0JBLEVBQVdoQyxXQUFXWCxVQUFVNEMsT0FBTyxjQXlEekNDLFdBWGtCQyxJQUNsQjlELEVBQVVrQixZQUFjLEdBQUc0QyxTQUMzQjlELEVBQVVnQixVQUFVQyxJQUFJLGNBbEdqQixHQzRHWCxFQTdHbUI4QyxJQUVqQixJQUFJekIsRUFBUSxHQUNSMEIsRUFBTyxFQUVYLE1BZ0JNMUMsRUFSWSxDQUFDeUMsSUFDakIsTUFBTUUsRUFBTSxHQUNaLElBQUssSUFBSWhCLEVBQUksRUFBR0EsRUFBSWMsRUFBT0EsRUFBTWQsSUFDL0JnQixFQUFJQyxLQVZDLENBQ0xuQyxPQUFRLENBQUN6QixFQVNLMkMsRUFBSWMsRUFUTnhELEVBU1k0RCxLQUFLQyxNQUFNbkIsRUFBSWMsSUFSdkMvQixRQUFTLEdBQ1RxQyxRQUFRLElBU1YsT0FBT0osR0FHS0ssQ0FBVVAsR0FDbEJRLEVBQU14QyxHQUFXVCxFQUFNUyxFQUFPekIsRUFBSXlCLEVBQU94QixFQUFJd0QsR0F5RW5ELE1BQU8sQ0FDTFEsR0FBQUEsRUFDQUMsY0F6RXFCekMsSUFDYndDLEVBQUd4QyxHQUFRc0MsT0F5RW5CSSxVQXRFaUIxQyxHQUNhLEtBQXZCd0MsRUFBR3hDLEdBQVFDLFFBc0VsQjBDLGNBbkVxQjNDLElBQ3JCLE1BQU1ILEVBQU8yQyxFQUFHeEMsR0FHaEIsR0FGQUgsRUFBS3lDLFFBQVMsRUFDZCxVQUFXdEMsR0FDUEgsRUFBS0ksUUFBUyxDQUNoQixNQUFNVSxFQUFPSixFQUFNcUMsTUFBS2pDLEdBQVFBLEVBQUtLLE9BQVNuQixFQUFLSSxVQUNuRFUsRUFBS2tDLE1BQ0RsQyxFQUFLSSxVQWFJLENBQUMrQixJQUNoQmIsSUFDQSxNQUFNNUQsRUFBY2tCLEVBQU13RCxRQUFPbEQsR0FBUUEsRUFBS0ksVUFBWTZDLElBQVVFLEtBQUluRCxHQUFRQSxFQUFLRyxTQUNyRixXQUFZM0IsSUFoQlNrRCxDQUFTWixFQUFLSyxRQTZEbkNpQyxRQXpEYyxDQUFDdEMsRUFBTVgsRUFBUWtELEVBQU8sT0FDcEMzQyxFQUFNNEIsS0FBS3hCLEdBQ1gsSUFBSXdDLEVBQVluRCxFQUNoQixJQUFLLElBQUlrQixFQUFJLEVBQUdBLEVBQUlQLEVBQUtRLFlBQWFELElBQ3BDc0IsRUFBR1csR0FBV2xELFFBQVVVLEVBQUtLLEtBQ3BCLE1BQVRrQyxFQUFlQyxFQUFVNUUsSUFBSzRFLEVBQVUzRSxLQXFEMUM0RSxhQTNDb0JDLElBQ3BCLElBQUssTUFBTUMsS0FBY0QsRUFBaUIsQ0FDeEMsR0FBSUMsRUFBVy9FLEVBQUl5RCxFQUFPLEdBQUtzQixFQUFXOUUsRUFBSXdELEVBQU8sRUFBRyxPQUFPLEVBQy9ELEdBQStCLEtBQTNCUSxFQUFHYyxHQUFZckQsUUFBZ0IsT0FBTyxFQUMxQyxNQUFNc0QsRUFVRCxDQUNMLENBQUNoRixHQUYyQnlCLEVBVGtCc0QsR0FXbkMvRSxFQUFJLEVBQUdDLEVBQUd3QixFQUFPeEIsR0FDNUIsQ0FBQ0QsRUFBR3lCLEVBQU96QixFQUFJLEVBQUdDLEVBQUd3QixFQUFPeEIsR0FDNUIsQ0FBQ0QsRUFBR3lCLEVBQU96QixFQUFHQyxFQUFHd0IsRUFBT3hCLEVBQUksR0FDNUIsQ0FBQ0QsRUFBR3lCLEVBQU96QixFQUFHQyxFQUFHd0IsRUFBT3hCLEVBQUksSUFiNUIsSUFBSyxNQUFNd0IsS0FBVXVELEVBQ25CLEtBQUl2RCxFQUFPekIsRUFBSXlELEVBQU8sR0FBS2hDLEVBQU96QixFQUFJLEdBQUt5QixFQUFPeEIsRUFBSXdELEVBQU8sR0FBS2hDLEVBQU94QixFQUFJLElBQ2xELEtBQXZCZ0UsRUFBR3hDLEdBQVFDLFFBQWdCLE9BQU8sRUFNYixJQUFDRCxFQUg5QixPQUFPLEdBa0NQd0QsU0FWZSxJQUFNakUsRUFXckJrRSxTQVZlLElBQU1sRCxFQVdyQm1ELE1BeEJZLEtBQ1puRCxFQUFRLEdBQ1IsSUFBSyxNQUFNVixLQUFRTixFQUNqQk0sRUFBS3lDLFFBQVMsRUFDZHpDLEVBQUtJLFFBQVUsSUFxQmpCMEQsYUFqQm1CLElBQ1oxQixHQUFRMUIsRUFBTXFELFNDaEZ6QixFQVRlLENBQUM1QyxFQUFNNkMsS0FDYixDQUNMN0MsS0FBQUEsRUFDQTZDLFlBQUFBLEVBQ0FDLFVBQVcsRUFBVSxJQUNyQnRFLFVBQVUsSUNrQmQsRUF6QmEsQ0FBQ29FLEVBQVE1QyxLQUNwQixNQUFNK0MsRUFBYUgsRUFDbkIsSUFBSUksRUFBVyxFQWNmLE1BQU8sQ0FDTGhELEtBQUFBLEVBQ0FHLFVBYmdCLElBQU00QyxFQWN0QkUsUUFiYyxJQUFNRCxFQWNwQm5CLElBWlUsS0FDVm1CLEtBWUFqRCxPQVRhLElBQ05pRCxHQUFZRCxJQ3VGdkIsRUFqR1csTUFFVCxNQUFNRyxFQUFXLEVBQU8sTUFDbEIzRCxFQUFRLENBQUMsRUFBSyxFQUFHLFdBQVksRUFBSyxFQUFHLGNBQWUsRUFBSyxFQUFHLFdBQVksRUFBSyxFQUFHLGFBQWMsRUFBSyxFQUFHLGNBQzVHLElBQUk0RCxFQUFjLEtBR2xCLE1BUU1DLEVBQXVCLEtBQzNCLE1BQ01DLEVBRFFILEVBQVNKLFVBQVVOLFdBQ1JULFFBQU9sRCxJQUFTQSxFQUFLeUMsU0FFOUMsT0FEZStCLEVBQVdqQyxLQUFLQyxNQUFNRCxLQUFLa0MsU0FBV0QsRUFBV1QsU0FBUzVELFFBd0UzRSxNQUFPLENBQ0x1RSxVQXJCaUJoRixJQUNqQixJQUFJUyxFQVdKLE9BVkFrRSxFQUFTSixVQUFZdkUsRUFDakI0RSxFQUVFRCxFQUFTSixVQUFVTCxXQUFXYixNQUFLakMsR0FBUUEsRUFBS0ssT0FBU2tELEVBQVNKLFVBQVV0QixHQUFHMkIsR0FBYWxFLFVBQVNjLFVBQ3ZHb0QsRUFBYyxLQUNkbkUsRUFBU29FLEtBQ0pwRSxFQS9DRyxNQUNaLE1BQU11RCxFQVZSLFNBQTRCaUIsR0FDMUIsSUFBSXRELEVBQUlzRCxFQUFNWixPQUNkLEtBQU8xQyxLQUFLLENBQ1YsTUFBTXVELEVBQUtyQyxLQUFLQyxNQUFNRCxLQUFLa0MsU0FBV3BELElBQ3JDc0QsRUFBTXRELEdBQUlzRCxFQUFNQyxJQUFPLENBQUNELEVBQU1DLEdBQUtELEVBQU10RCxJQUU1QyxPQUFPc0QsRUFJZ0JFLENBQW1CLENBQ3hDLENBQUNuRyxFQUFHNEYsRUFBWTVGLEVBQUksRUFBR0MsRUFBRzJGLEVBQVkzRixHQUN0QyxDQUFDRCxFQUFHNEYsRUFBWTVGLEVBQUksRUFBR0MsRUFBRzJGLEVBQVkzRixHQUN0QyxDQUFDRCxFQUFHNEYsRUFBWTVGLEVBQUdDLEVBQUcyRixFQUFZM0YsRUFBSSxHQUN0QyxDQUFDRCxFQUFHNEYsRUFBWTVGLEVBQUdDLEVBQUcyRixFQUFZM0YsRUFBSSxLQUd4QyxJQUFJbUcsRUFFSixJQUFLLE1BQU0zRSxLQUFVdUQsRUFBZ0IsQ0FDbkMsR0FBSXZELEVBQU96QixFQUFJLEdBQUt5QixFQUFPekIsRUFBSSxHQUFLeUIsRUFBT3hCLEVBQUksR0FBS3dCLEVBQU94QixFQUFJLEVBQUcsU0FDbEUsSUFBSXFCLEVBQU9xRSxFQUFTSixVQUFVdEIsR0FBR3hDLEdBQzdCbUQsRUFBWXlCLE9BQU9DLE9BQU8sR0FBSTdFLEdBQ2xDLEdBQUlILEVBQUt5QyxRQUFVekMsRUFBS0ksUUFBUyxDQUUvQixJQURBMEUsRUFBaUIsQ0FBQ3BHLEVBQUc0RSxFQUFVNUUsRUFBSTRGLEVBQVk1RixFQUFHQyxFQUFHMkUsRUFBVTNFLEVBQUkyRixFQUFZM0YsR0FDeEVxQixFQUFLeUMsUUFBVXpDLEVBQUtJLFNBQ3pCa0QsRUFBVTVFLEdBQUtvRyxFQUFlcEcsRUFDOUI0RSxFQUFVM0UsR0FBS21HLEVBQWVuRyxFQUM5QnFCLEVBQU9xRSxFQUFTSixVQUFVdEIsR0FBR1csR0FFL0IsR0FBSXRELEVBQUt5QyxPQUFRLENBQ2YsTUFBTXdDLEVBQWdCRixPQUFPQyxPQUFPLEdBQUlWLEdBR3hDLE9BRkFXLEVBQWN2RyxHQUFLb0csRUFBZXBHLEVBQ2xDdUcsRUFBY3RHLEdBQUttRyxFQUFlbkcsRUFDM0JzRyxFQUVULE9BQU8zQixHQUlYLElBQUssTUFBTW5ELEtBQVV1RCxFQUNuQixLQUFJdkQsRUFBT3pCLEVBQUksR0FBS3lCLEVBQU96QixFQUFJLEdBQUt5QixFQUFPeEIsRUFBSSxHQUFLd0IsRUFBT3hCLEVBQUksR0FDcEQwRixFQUFTSixVQUFVdEIsR0FBR3hDLEdBQ3hCc0MsUUFDSixPQUFPdEMsR0FZSStFLEdBQ1gvRSxFQUFTb0UsSUFDWkYsRUFBU0osVUFBVXBCLFVBQVUxQyxLQUFTbUUsRUFBY25FLEdBRWpEQSxHQVVQZ0YsWUFQa0IsS0E3RWxCZCxFQUFTSixVQUFVYixRQUFRMUMsRUFBTSxHQUFJLENBQUNoQyxFQUFHLEVBQUdDLEVBQUcsR0FBSSxLQUNuRDBGLEVBQVNKLFVBQVViLFFBQVExQyxFQUFNLEdBQUksQ0FBQ2hDLEVBQUcsRUFBR0MsRUFBRyxHQUFJLEtBQ25EMEYsRUFBU0osVUFBVWIsUUFBUTFDLEVBQU0sR0FBSSxDQUFDaEMsRUFBRyxFQUFHQyxFQUFHLEdBQUksS0FDbkQwRixFQUFTSixVQUFVYixRQUFRMUMsRUFBTSxHQUFJLENBQUNoQyxFQUFHLEVBQUdDLEVBQUcsR0FBSSxLQUNuRDBGLEVBQVNKLFVBQVViLFFBQVExQyxFQUFNLEdBQUksQ0FBQ2hDLEVBQUcsRUFBR0MsRUFBRyxHQUFJLEtBMkU1QzBGLEtBdkZBLEdDMkVYLEVBekV1QixNQUVyQixNQUFNZSxFQUFVLEVBQU8sS0FBTSxVQUN2QkMsRUFBVSxFQUFPLEtBQU0sU0FFN0IsU0FBU0MsRUFBTUMsR0FDYixPQUFPLElBQUlDLFNBQVFDLEdBQVdDLFdBQVdELEVBQVNGLEtBR3BELE1BQU1JLEVBQVcsSUFDUlAsRUFBUXpGLFNBQVcwRixFQUFTRCxFQTRCL0JRLEVBQVdDLE1BQU8xRixJQUN0QixNQUFNMkYsRUFBZ0JILElBQVcxQixVQUNqQyxHQUFLNkIsRUFBY2xELGNBQWN6QyxHQUFqQyxDQUdBLEdBRkEyRixFQUFjaEQsY0FBYzNDLEdBQzVCLHFCQUFzQndGLElBQVd4RSxLQUFNMkUsRUFBY2xDLFlBQ2hEa0MsRUFBY2pELFVBQVUxQyxJQUl4QixHQUFJMkYsRUFBY2hDLGVBRXJCLFlBREEsY0FsQ0tzQixFQUFRekYsU0FBV3lGLEVBQVNDLEdBa0NKckIsd0JBSnZCc0IsRUFBTSxLQTFCZEYsRUFBUXpGLFVBQVl5RixFQUFRekYsU0FDNUIwRixFQUFRMUYsVUFBWTBGLEVBQVExRixTQUM1QixzQkErQkFvRyxNQUdJQSxFQUFXRixVQUNYUixFQUFRMUYsaUJBQ0oyRixFQUFvQixJQUFkL0MsS0FBS2tDLFNBQWUsS0FDaENtQixFQUFTLFlBQWFELElBQVcxQixjQVNyQyxNQUFPLENBQ0wrQixLQU5XLEtBckNYWixFQUFRekYsVUFBVyxFQUNuQnlGLEVBQVFuQixVQUFZLG9CQUE2QkEsVUFDakQsa0JBQW1CLEtBQU1tQixFQUFRakUsS0FBTWlFLEVBQVFuQixVQUFVTixZQUN6RCxxQkFBc0J5QixFQUFRakUsS0FBTWlFLEVBQVFuQixVQUFVTCxZQUl0RHlCLEVBQVExRixVQUFXLEVBQ25CMEYsRUFBUXBCLFVBQVksZ0JBQWlCQSxVQUNyQyxrQkFBbUIsS0FBTW9CLEVBQVFsRSxLQUFNa0UsRUFBUXBCLFVBQVVOLFlBQVksR0FDckUscUJBQXNCMEIsRUFBUWxFLEtBQU1rRSxFQUFRcEIsVUFBVUwsYUFrQ3REZ0MsU0FBQUEsSUFwRW1CLEdDbUh2QixFQW5IbUIsTUFDakIsTUFBTXBHLEVBQVMsRUFBTyxVQUNoQmtCLEVBQVEsQ0FBQyxFQUFLLEVBQUcsV0FBWSxFQUFLLEVBQUcsY0FBZSxFQUFLLEVBQUcsV0FBWSxFQUFLLEVBQUcsYUFBYyxFQUFLLEVBQUcsY0FDNUcsSUFBSXVGLEVBQVUsQ0FDWnRGLFFBQVMsRUFDVDZDLGdCQUFpQixHQUNqQkgsS0FBTSxLQUVSLE1BQU1sRixFQUFTRixTQUFTQyxjQUFjLFVBQ2hDZ0ksRUFBY2pJLFNBQVNDLGNBQWMsZUFDckNpSSxFQUFlbEksU0FBU0MsY0FBYyxnQkFJdENrSSxFQUFVakcsR0FDUGxDLFNBQVNDLGNBQWMsaUJBQWlCaUMsRUFBT3pCLEtBQUt5QixFQUFPeEIsT0FLOUQwSCxFQUFZbEcsSUFDWjhGLEVBQVF0RixTQUFXRCxFQUFNcUQsU0FDVSxJQUFuQ2tDLEVBQVF6QyxnQkFBZ0JPLFFBQzFCa0MsRUFBUXpDLGdCQUFnQnRFLFNBQVFpQixJQUM5QmlHLEVBQU9qRyxHQUFRZixVQUFVa0gsT0FBTyxRQUNoQ0YsRUFBT2pHLEdBQVFmLFVBQVVrSCxPQUFPLGNBR3BDTCxFQUFRekMsZ0JBQWtCK0MsRUFBU3BHLEdBQ25DOEYsRUFBUXpDLGdCQUFnQnRFLFNBQVFpQixJQUM5QmlHLEVBQU9qRyxHQUFRZixVQUFVQyxJQUFJLFdBRTFCbUgsS0FDSFAsRUFBUXpDLGdCQUFnQnRFLFNBQVFpQixJQUM5QmlHLEVBQU9qRyxHQUFRZixVQUFVQyxJQUFJLGdCQUs3QmtILEVBQVlwRyxJQUNoQixJQUFJcUQsRUFBa0IsR0FDbEJGLEVBQVluRCxFQUNoQixJQUFLLElBQUlrQixFQUFJLEVBQUdBLEVBQUlYLEVBQU11RixFQUFRdEYsU0FBU1csY0FDekNrQyxFQUFnQmxCLEtBQUssQ0FBQzVELEVBQUc0RSxFQUFVNUUsRUFBR0MsRUFBRzJFLEVBQVUzRSxJQUNsQyxNQUFqQnNILEVBQVE1QyxLQUFlQyxFQUFVNUUsSUFBSzRFLEVBQVUzRSxNQUM1QzJFLEVBQVU1RSxFQUFJLEdBQUs0RSxFQUFVM0UsRUFBSSxJQUhpQjBDLEtBS3hELE9BQU9tQyxHQUdIZ0QsRUFBYyxLQUNUaEgsRUFBT3lFLFVBQVVWLGFBQWEwQyxFQUFRekMsa0JBQ3pDeUMsRUFBUXpDLGdCQUFnQk8sU0FBV3JELEVBQU11RixFQUFRdEYsU0FBU1csWUFpQjVEdUMsRUFBUSxLQUNackUsRUFBT3lFLFVBQVVKLFFBQ2pCckUsRUFBT3lFLFVBQVVOLFdBQVd6RSxTQUFRYyxJQUNsQ29HLEVBQU9wRyxFQUFLRyxRQUFRZixVQUFVa0gsT0FBTyxRQUNyQ0YsRUFBT3BHLEVBQUtHLFFBQVFmLFVBQVVrSCxPQUFPLFdBRWYxRSxNQUFNQyxLQUFLNUQsU0FBU0MsY0FBYyxrQkFBa0I0RCxVQUM1RDVDLFNBQVErQixHQUFrQkEsRUFBZTdCLFVBQVVrSCxPQUFPLFVBQzFFTCxFQUFVLENBQ1J0RixRQUFTLEVBQ1Q2QyxnQkFBaUIsR0FDakJILEtBQU0sS0FFUjZDLEVBQVlPLE1BQU1DLFFBQVUsUUF3QjlCLE1BQU8sQ0FDTFYsS0FwQlcsS0FDWCxrQkFBbUIsU0FBVXhHLEVBQU8yQixLQUFNM0IsRUFBT3lFLFVBQVVOLFlBQzNELHFCQUFzQm5FLEVBQU8yQixLQUFNVCxHQUVuQ3pDLFNBQVNvQyxpQkFBaUIsU0FBUyxFQUFHc0csSUFBQUEsTUFDeEIsTUFBUkEsR0FBdUIsTUFBUkEsSUFDakJWLEVBQVE1QyxLQUF3QixNQUFqQjRDLEVBQVE1QyxLQUFlLElBQUssSUFDM0NnRCxFQUFTSixFQUFRekMsZ0JBQWdCLEdBQUl5QyxFQUFRNUMsVUFJakQ2QyxFQUFZN0YsaUJBQWlCLFNBQVMsS0FDcENsQyxFQUFPbUksU0FDUCxZQUdGSCxFQUFhOUYsaUJBQWlCLFFBQVN3RCxJQUt2QytDLFVBcERpQnpHLElBQ1pxRyxNQUNMaEgsRUFBT3lFLFVBQVViLFFBQVExQyxFQUFNdUYsRUFBUXRGLFdBQVlSLEVBQVE4RixFQUFRNUMsTUFDbkU0QyxFQUFRekMsZ0JBQWdCdEUsU0FBUWlCLElBQzlCaUcsRUFBT2pHLEdBQVFmLFVBQVVDLElBQUksUUFDN0IrRyxFQUFPakcsR0FBUWYsVUFBVWtILE9BQU8sV0FFbEMscUJBQXNCOUcsRUFBTzJCLEtBQU1ULEVBQU91RixFQUFRdEYsUUFBVSxHQUN4RHNGLEVBQVF0RixVQUFZRCxFQUFNcUQsU0FDNUJtQyxFQUFZTyxNQUFNQyxRQUFVLFdBNEM5QkwsU0FBQUEsRUFDQVEsZ0JBekJzQixJQUFNckgsSUFyRmIsR0NGbkIsVSIsInNvdXJjZXMiOlsid2VicGFjazovL2JhdHRsZXNoaXAvLi9zcmMvTW9kdWxlcy9VSS5qcyIsIndlYnBhY2s6Ly9iYXR0bGVzaGlwLy4vc3JjL0ZhY3Rvcmllcy9HYW1lYm9hcmQuanMiLCJ3ZWJwYWNrOi8vYmF0dGxlc2hpcC8uL3NyYy9GYWN0b3JpZXMvUGxheWVyLmpzIiwid2VicGFjazovL2JhdHRsZXNoaXAvLi9zcmMvRmFjdG9yaWVzL1NoaXAuanMiLCJ3ZWJwYWNrOi8vYmF0dGxlc2hpcC8uL3NyYy9Nb2R1bGVzL0FJUGxheWVyLmpzIiwid2VicGFjazovL2JhdHRsZXNoaXAvLi9zcmMvTW9kdWxlcy9HYW1lQ29udHJvbGxlci5qcyIsIndlYnBhY2s6Ly9iYXR0bGVzaGlwLy4vc3JjL01vZHVsZXMvUGxhY2VTaGlwcy5qcyIsIndlYnBhY2s6Ly9iYXR0bGVzaGlwLy4vc3JjL2luZGV4LmpzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBHYW1lQ29udHJvbGxlciBmcm9tIFwiLi9HYW1lQ29udHJvbGxlclwiO1xuaW1wb3J0IFBsYWNlU2hpcHMgZnJvbSBcIi4vUGxhY2VTaGlwc1wiO1xuXG5jb25zdCBVSSA9ICgoKSA9PiB7XG4gIGNvbnN0ICRtYWluID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignLm1haW4nKTtcbiAgY29uc3QgJG1vZGFsID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignLm1vZGFsJyk7XG4gIGNvbnN0ICR3aW5Nb2RhbCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJy5tb2RhbC13aW4nKTtcbiAgbGV0IG1vZGUgPSAnUExBWSc7XG5cbiAgY29uc3QgZGVjb2RlQ29vcmRzID0gKGNvb3Jkc1N0cmluZykgPT4ge1xuICAgIGNvbnN0IGNvb3Jkc0FycmF5ID0gY29vcmRzU3RyaW5nLnNwbGl0KCcgJyk7XG4gICAgcmV0dXJuIHt4OiArY29vcmRzQXJyYXlbMF0sIHk6ICtjb29yZHNBcnJheVsxXX07XG4gIH1cblxuICBjb25zdCBjcmVhdGVIdG1sRWxlbWVudCA9ICh0eXBlLCBjbGFzc0FycmF5ID0gbnVsbCwgdGV4dCA9IG51bGwpID0+IHtcbiAgICBjb25zdCBlbGVtZW50ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCh0eXBlKTtcbiAgICBpZiAoY2xhc3NBcnJheSkgY2xhc3NBcnJheS5mb3JFYWNoKGNscyA9PiBlbGVtZW50LmNsYXNzTGlzdC5hZGQoY2xzKSk7XG4gICAgaWYgKHRleHQpIGVsZW1lbnQudGV4dENvbnRlbnQgPSB0ZXh0O1xuICAgIHJldHVybiBlbGVtZW50O1xuICB9XG4gIFxuICBjb25zdCBuZXdDZWxsRE9NID0gKGNlbGwpID0+IHtcbiAgICAgIGNvbnN0ICRjZWxsID0gY3JlYXRlSHRtbEVsZW1lbnQoJ2RpdicsIFsnY2VsbCddKTtcbiAgICAgICRjZWxsLnNldEF0dHJpYnV0ZSgnZGF0YS1jb29yZHMnLCBgJHtjZWxsLmNvb3Jkcy54fSAke2NlbGwuY29vcmRzLnl9YCk7XG4gICAgICBpZiAoY2VsbC5oYXNTaGlwKSAkY2VsbC5jbGFzc0xpc3QuYWRkKCdzaGlwJyk7XG4gICAgICBhZGRDZWxsTGlzdGVuZXIoJGNlbGwpO1xuICAgICAgcmV0dXJuICRjZWxsO1xuICB9XG5cbiAgY29uc3QgYWRkQ2VsbExpc3RlbmVyID0gKCRjZWxsKSA9PiB7XG4gICAgaWYgKG1vZGUgPT09ICdQTEFDRScpIHtcbiAgICAgICRjZWxsLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKCkgPT4ge1xuICAgICAgICBQbGFjZVNoaXBzLnBsYWNlU2hpcChkZWNvZGVDb29yZHMoJGNlbGwuZ2V0QXR0cmlidXRlKCdkYXRhLWNvb3JkcycpKSk7XG4gICAgICB9KTtcbiAgXG4gICAgICAkY2VsbC5hZGRFdmVudExpc3RlbmVyKCdtb3VzZW92ZXInLCAoKSA9PiB7XG4gICAgICAgIFBsYWNlU2hpcHMuc2hvd1NoaXAoZGVjb2RlQ29vcmRzKCRjZWxsLmdldEF0dHJpYnV0ZSgnZGF0YS1jb29yZHMnKSkpO1xuICAgICAgfSk7XG4gICAgfVxuICAgIGVsc2UgJGNlbGwuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoKSA9PiB7XG4gICAgICBHYW1lQ29udHJvbGxlci5wbGF5VHVybihkZWNvZGVDb29yZHMoJGNlbGwuZ2V0QXR0cmlidXRlKCdkYXRhLWNvb3JkcycpKSk7XG4gICAgfSk7XG4gIH1cblxuICBjb25zdCBjZWxsSGl0ID0gKGNvb3JkcykgPT4ge1xuICAgIGNvbnN0IGVuY29kZWRDb29yZHMgPSBgJHtjb29yZHMueH0gJHtjb29yZHMueX1gO1xuICAgIGNvbnN0ICRjZWxsID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcihgLmFjdGl2ZSA+IFtkYXRhLWNvb3Jkcz1cIiR7ZW5jb2RlZENvb3Jkc31cIl1gKTtcbiAgICAkY2VsbC5jbGFzc0xpc3QuYWRkKCdoaXQnKTtcbiAgfVxuXG4gIGNvbnN0IHRvZ2dsZUFjdGl2ZUJvYXJkID0gKCkgPT4ge1xuICAgIGNvbnN0ICRnYW1lYm9hcmRDb250YWluZXJzID0gQXJyYXkuZnJvbSgkbWFpbi5jaGlsZHJlbik7XG4gICAgJGdhbWVib2FyZENvbnRhaW5lcnMuZm9yRWFjaCgkZ2FtZWJvYXJkID0+IHtcbiAgICAgICRnYW1lYm9hcmQuZmlyc3RDaGlsZC5jbGFzc0xpc3QudG9nZ2xlKCdhY3RpdmUnKTtcbiAgICB9KTtcbiAgfVxuXG4gIGNvbnN0IHNoaXBTdW5rID0gKGNvb3Jkc0FycmF5KSA9PiB7XG4gICAgY29vcmRzQXJyYXkuZm9yRWFjaChjb29yZHMgPT4ge1xuICAgICAgZG9jdW1lbnQucXVlcnlTZWxlY3RvcihgLmFjdGl2ZSA+IFtkYXRhLWNvb3Jkcz1cIiR7Y29vcmRzLnh9ICR7Y29vcmRzLnl9XCJdYCkuY2xhc3NMaXN0LmFkZCgnc3VuaycpO1xuICAgIH0pXG4gIH1cblxuICBjb25zdCBuZXdHYW1lYm9hcmRDb250YWluZXJET00gPSAocGxheWVyTmFtZSkgPT4ge1xuICAgIGNvbnN0ICRjb250YWluZXIgPSBjcmVhdGVIdG1sRWxlbWVudCgnZGl2JywgWydjb250YWluZXInXSk7XG4gICAgJGNvbnRhaW5lci5hcHBlbmRDaGlsZChjcmVhdGVIdG1sRWxlbWVudCgnZGl2JywgW2Ake3BsYXllck5hbWV9YCwgJ2JvYXJkJ10pKTtcbiAgICAkY29udGFpbmVyLmFwcGVuZENoaWxkKGNyZWF0ZUh0bWxFbGVtZW50KCdkaXYnLCBbJ3NoaXBzLWRpc3BsYXknXSkpO1xuICAgIGlmIChtb2RlID09PSAnUExBQ0UnKSAkbW9kYWwuYXBwZW5kQ2hpbGQoJGNvbnRhaW5lcik7XG4gICAgZWxzZSAkbWFpbi5hcHBlbmRDaGlsZCgkY29udGFpbmVyKTtcbiAgICByZXR1cm4gJGNvbnRhaW5lcjtcbiAgfVxuXG4gIGNvbnN0IHJlbmRlckdhbWVib2FyZCA9IChwbGF5ZXIsIHBsYXllck5hbWUsIGJvYXJkLCBpc0FjdGl2ZSA9IGZhbHNlKSA9PiB7XG4gICAgbW9kZSA9IHBsYXllck5hbWUgPT09ICdzYW1wbGUnID8gJ1BMQUNFJzogJ1BMQVknO1xuICAgIGNvbnN0ICRjb250YWluZXIgPSBuZXdHYW1lYm9hcmRDb250YWluZXJET00ocGxheWVyTmFtZSk7XG4gICAgaWYgKGlzQWN0aXZlKSAkY29udGFpbmVyLmZpcnN0Q2hpbGQuY2xhc3NMaXN0LmFkZCgnYWN0aXZlJyk7XG4gICAgYm9hcmQuZm9yRWFjaChjZWxsID0+ICRjb250YWluZXIuZmlyc3RDaGlsZC5hcHBlbmRDaGlsZChuZXdDZWxsRE9NKGNlbGwpKSk7XG4gIH1cblxuICBjb25zdCBuZXdTaGlwRE9NID0gKHNoaXAsIGlzUGxhY2VkID0gZmFsc2UpID0+IHtcbiAgICBjb25zdCAkc2hpcENvbnRhaW5lciA9IGNyZWF0ZUh0bWxFbGVtZW50KCdkaXYnLCBbJ3NoaXAtY29udGFpbmVyJ10pO1xuICAgIGlmIChzaGlwLmlzU3VuaygpIHx8IChtb2RlID09PSAnUExBQ0UnICYmIGlzUGxhY2VkKSkgJHNoaXBDb250YWluZXIuY2xhc3NMaXN0LmFkZCgnc3VuaycpO1xuICAgICRzaGlwQ29udGFpbmVyLmFwcGVuZENoaWxkKGNyZWF0ZUh0bWxFbGVtZW50KCdkaXYnLCBbJ3NoaXAtbmFtZSddLCBzaGlwLm5hbWUpKTtcbiAgICBjb25zdCAkc2hpcEJvZHkgPSBjcmVhdGVIdG1sRWxlbWVudCgnZGl2JywgWydzaGlwLWJvZHknXSk7XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBzaGlwLmdldExlbmd0aCgpOyBpKyspIHtcbiAgICAgICRzaGlwQm9keS5hcHBlbmRDaGlsZChjcmVhdGVIdG1sRWxlbWVudCgnZGl2JywgWydzaGlwLWNlbGwnXSkpO1xuICAgIH1cbiAgICAkc2hpcENvbnRhaW5lci5hcHBlbmRDaGlsZCgkc2hpcEJvZHkpO1xuICAgIHJldHVybiAkc2hpcENvbnRhaW5lcjtcbiAgfVxuXG4gIGNvbnN0IHVwZGF0ZVNoaXBzRGlzcGxheSA9IChwbGF5ZXJOYW1lLCBzaGlwcywgc2hpcE51bSA9IC0xKSA9PiB7XG4gICAgY29uc3QgJHNoaXBzRGlzcGxheSA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoYC4ke3BsYXllck5hbWV9YCkubmV4dEVsZW1lbnRTaWJsaW5nO1xuICAgICRzaGlwc0Rpc3BsYXkudGV4dENvbnRlbnQgPSAnJztcbiAgICBzaGlwcy5mb3JFYWNoKChzaGlwLCBpbmRleCkgPT4ge1xuICAgICAgJHNoaXBzRGlzcGxheS5hcHBlbmRDaGlsZChuZXdTaGlwRE9NKHNoaXAsIGluZGV4IDw9IHNoaXBOdW0pKTtcbiAgICB9KTtcbiAgfVxuXG4gIGNvbnN0IHNob3dXaW5uZXIgPSAocGxheWVyRGlzcGxheU5hbWUpID0+IHtcbiAgICAkd2luTW9kYWwudGV4dENvbnRlbnQgPSBgJHtwbGF5ZXJEaXNwbGF5TmFtZX0gd2luc2A7XG4gICAgJHdpbk1vZGFsLmNsYXNzTGlzdC5hZGQoJ3Zpc2libGUnKTtcbiAgfVxuXG4gIHJldHVybiB7XG4gICAgcmVuZGVyR2FtZWJvYXJkLFxuICAgIHVwZGF0ZVNoaXBzRGlzcGxheSxcbiAgICBjZWxsSGl0LFxuICAgIHNoaXBTdW5rLFxuICAgIHRvZ2dsZUFjdGl2ZUJvYXJkLFxuICAgIHNob3dXaW5uZXIsXG4gIH07XG5cbn0pKCk7XG5cbmV4cG9ydCBkZWZhdWx0IFVJOyIsImltcG9ydCBVSSBmcm9tIFwiLi4vTW9kdWxlcy9VSVwiO1xuXG5jb25zdCBHYW1lYm9hcmQgPSAoc2l6ZSkgPT4ge1xuXG4gIGxldCBzaGlwcyA9IFtdO1xuICBsZXQgc3VuayA9IDA7XG5cbiAgY29uc3QgY2VsbCA9ICh4LCB5KSA9PiB7XG4gICAgcmV0dXJuIHtcbiAgICAgIGNvb3Jkczoge3gsIHl9LFxuICAgICAgaGFzU2hpcDogJycsXG4gICAgICBpc1Nob3Q6IGZhbHNlXG4gICAgfTtcbiAgfVxuXG4gIGNvbnN0IF9tYWtlR3JpZCA9IChzaXplKSA9PiB7XG4gICAgY29uc3QgYXJyID0gW107XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBzaXplICogc2l6ZTsgaSsrKSB7XG4gICAgICBhcnIucHVzaChjZWxsKGkgJSBzaXplLCBNYXRoLmZsb29yKGkgLyBzaXplKSkpO1xuICAgIH1cbiAgICByZXR1cm4gYXJyO1xuICB9XG5cbiAgY29uc3QgYm9hcmQgPSBfbWFrZUdyaWQoc2l6ZSk7XG4gIGNvbnN0IGF0ID0gKGNvb3JkcykgPT4gYm9hcmRbY29vcmRzLnggKyBjb29yZHMueSAqIHNpemVdO1xuXG4gIGNvbnN0IGlzVmFsaWRBdHRhY2sgPSAoY29vcmRzKSA9PiB7XG4gICAgcmV0dXJuICFhdChjb29yZHMpLmlzU2hvdDtcbiAgfVxuXG4gIGNvbnN0IGlzU2hpcEhpdCA9IChjb29yZHMpID0+IHtcbiAgICByZXR1cm4gYXQoY29vcmRzKS5oYXNTaGlwICE9PSAnJztcbiAgfVxuXG4gIGNvbnN0IHJlY2VpdmVBdHRhY2sgPSAoY29vcmRzKSA9PiB7XG4gICAgY29uc3QgY2VsbCA9IGF0KGNvb3Jkcyk7XG4gICAgY2VsbC5pc1Nob3QgPSB0cnVlO1xuICAgIFVJLmNlbGxIaXQoY29vcmRzKTtcbiAgICBpZiAoY2VsbC5oYXNTaGlwKSB7XG4gICAgICBjb25zdCBzaGlwID0gc2hpcHMuZmluZChzaGlwID0+IHNoaXAubmFtZSA9PT0gY2VsbC5oYXNTaGlwKTtcbiAgICAgIHNoaXAuaGl0KCk7XG4gICAgICBpZiAoc2hpcC5pc1N1bmsoKSkgc2hpcFN1bmsoc2hpcC5uYW1lKTtcbiAgICB9XG4gIH1cblxuICBjb25zdCBzZXRTaGlwID0gKHNoaXAsIGNvb3JkcywgYXhpcyA9ICd4JykgPT4ge1xuICAgIHNoaXBzLnB1c2goc2hpcCk7XG4gICAgbGV0IG5ld0Nvb3JkcyA9IGNvb3JkcztcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHNoaXAuZ2V0TGVuZ3RoKCk7IGkrKykge1xuICAgICAgYXQobmV3Q29vcmRzKS5oYXNTaGlwID0gc2hpcC5uYW1lO1xuICAgICAgYXhpcyA9PT0gJ3gnID8gbmV3Q29vcmRzLngrKzogbmV3Q29vcmRzLnkrKztcbiAgICB9XG4gIH1cblxuICBjb25zdCBzaGlwU3VuayA9IChzaGlwTmFtZSkgPT4ge1xuICAgIHN1bmsrKztcbiAgICBjb25zdCBjb29yZHNBcnJheSA9IGJvYXJkLmZpbHRlcihjZWxsID0+IGNlbGwuaGFzU2hpcCA9PT0gc2hpcE5hbWUpLm1hcChjZWxsID0+IGNlbGwuY29vcmRzKTtcbiAgICBVSS5zaGlwU3Vuayhjb29yZHNBcnJheSk7XG4gIH1cblxuICBjb25zdCBpc0NvbGxpc2lvbnMgPSAoc2hpcENvb3Jkc0FycmF5KSA9PiB7XG4gICAgZm9yIChjb25zdCBzaGlwQ29vcmRzIG9mIHNoaXBDb29yZHNBcnJheSkge1xuICAgICAgaWYgKHNoaXBDb29yZHMueCA+IHNpemUgLSAxIHx8IHNoaXBDb29yZHMueSA+IHNpemUgLSAxKSByZXR1cm4gdHJ1ZTtcbiAgICAgIGlmIChhdChzaGlwQ29vcmRzKS5oYXNTaGlwICE9PSAnJykgcmV0dXJuIHRydWU7XG4gICAgICBjb25zdCBhZGphY2VudENvb3JkcyA9IGdldEFkamFjZW50Q29vcmRzQXJyYXkoc2hpcENvb3Jkcyk7XG4gICAgICBmb3IgKGNvbnN0IGNvb3JkcyBvZiBhZGphY2VudENvb3Jkcykge1xuICAgICAgICBpZiAoY29vcmRzLnggPiBzaXplIC0gMSB8fCBjb29yZHMueCA8IDAgfHwgY29vcmRzLnkgPiBzaXplIC0gMSB8fCBjb29yZHMueSA8IDApIGNvbnRpbnVlO1xuICAgICAgICBpZiAoYXQoY29vcmRzKS5oYXNTaGlwICE9PSAnJykgcmV0dXJuIHRydWU7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiBmYWxzZTtcbiAgfVxuXG4gIGNvbnN0IGdldEFkamFjZW50Q29vcmRzQXJyYXkgPSAoY29vcmRzKSA9PiB7XG4gICAgcmV0dXJuIFtcbiAgICAgIHt4OiBjb29yZHMueCArIDEsIHk6IGNvb3Jkcy55fSxcbiAgICAgIHt4OiBjb29yZHMueCAtIDEsIHk6IGNvb3Jkcy55fSxcbiAgICAgIHt4OiBjb29yZHMueCwgeTogY29vcmRzLnkgKyAxfSxcbiAgICAgIHt4OiBjb29yZHMueCwgeTogY29vcmRzLnkgLSAxfVxuICAgIF07XG4gIH1cblxuICBjb25zdCByZXNldCA9ICgpID0+IHtcbiAgICBzaGlwcyA9IFtdO1xuICAgIGZvciAoY29uc3QgY2VsbCBvZiBib2FyZCkge1xuICAgICAgY2VsbC5pc1Nob3QgPSBmYWxzZTtcbiAgICAgIGNlbGwuaGFzU2hpcCA9ICcnO1xuICAgIH1cbiAgfVxuXG4gIGNvbnN0IGFsbFNoaXBzU3VuayA9ICgpID0+IHtcbiAgICByZXR1cm4gc3VuayA+PSBzaGlwcy5sZW5ndGg7XG4gIH1cblxuICBjb25zdCBnZXRCb2FyZCA9ICgpID0+IGJvYXJkO1xuICBjb25zdCBnZXRTaGlwcyA9ICgpID0+IHNoaXBzO1xuXG4gIHJldHVybiB7XG4gICAgYXQsXG4gICAgaXNWYWxpZEF0dGFjayxcbiAgICBpc1NoaXBIaXQsXG4gICAgcmVjZWl2ZUF0dGFjayxcbiAgICBzZXRTaGlwLFxuICAgIGlzQ29sbGlzaW9ucyxcbiAgICBnZXRCb2FyZCxcbiAgICBnZXRTaGlwcyxcbiAgICByZXNldCxcbiAgICBhbGxTaGlwc1N1bmtcbiAgfTtcbn1cblxuZXhwb3J0IGRlZmF1bHQgR2FtZWJvYXJkOyIsImltcG9ydCBHYW1lYm9hcmQgZnJvbSBcIi4vR2FtZWJvYXJkXCJcblxuY29uc3QgUGxheWVyID0gKG5hbWUsIGRpc3BsYXlOYW1lKSA9PiB7XG4gIHJldHVybiB7XG4gICAgbmFtZSxcbiAgICBkaXNwbGF5TmFtZSxcbiAgICBnYW1lYm9hcmQ6IEdhbWVib2FyZCgxMCksXG4gICAgaXNBY3RpdmU6IGZhbHNlLFxuICB9O1xufVxuXG5leHBvcnQgZGVmYXVsdCBQbGF5ZXI7IiwiY29uc3QgU2hpcCA9IChsZW5ndGgsIG5hbWUpID0+IHtcbiAgY29uc3Qgc2hpcExlbmd0aCA9IGxlbmd0aDtcbiAgbGV0IGhpdENvdW50ID0gMDtcblxuICAvLyBHZXR0ZXJzXG4gIGNvbnN0IGdldExlbmd0aCA9ICgpID0+IHNoaXBMZW5ndGg7XG4gIGNvbnN0IGdldEhpdHMgPSAoKSA9PiBoaXRDb3VudDtcblxuICBjb25zdCBoaXQgPSAoKSA9PiB7XG4gICAgaGl0Q291bnQrKztcbiAgfVxuXG4gIGNvbnN0IGlzU3VuayA9ICgpID0+IHtcbiAgICByZXR1cm4gaGl0Q291bnQgPj0gc2hpcExlbmd0aDtcbiAgfVxuXG4gIHJldHVybiB7XG4gICAgbmFtZSxcbiAgICBnZXRMZW5ndGgsXG4gICAgZ2V0SGl0cyxcbiAgICBoaXQsXG4gICAgaXNTdW5rLFxuICB9O1xufVxuXG5leHBvcnQgZGVmYXVsdCBTaGlwOyIsImltcG9ydCBQbGF5ZXIgZnJvbSBcIi4uL0ZhY3Rvcmllcy9QbGF5ZXJcIjtcbmltcG9ydCBTaGlwIGZyb20gXCIuLi9GYWN0b3JpZXMvU2hpcFwiO1xuXG5jb25zdCBBSSA9ICgoKSA9PiB7XG5cbiAgY29uc3QgQUlwbGF5ZXIgPSBQbGF5ZXIoJ0FJJyk7XG4gIGNvbnN0IHNoaXBzID0gW1NoaXAoNSwgJ0NhcnJpZXInKSwgU2hpcCg0LCAnQmF0dGxlc2hpcCcpLCBTaGlwKDMsICdDcnVpc2VyJyksIFNoaXAoMywgJ1N1Ym1hcmluZScpLCBTaGlwKDIsICdEZXN0cm95ZXInKV07XG4gIGxldCBQcmV2U2hpcEhpdCA9IG51bGw7XG4gIC8vIGxldCBQcmV2SGl0ID0gbnVsbDtcblxuICBjb25zdCBwbGFjZVNoaXBzID0gKCkgPT4ge1xuICAgIEFJcGxheWVyLmdhbWVib2FyZC5zZXRTaGlwKHNoaXBzWzBdLCB7eDogMCwgeTogMH0sICd4Jyk7XG4gICAgQUlwbGF5ZXIuZ2FtZWJvYXJkLnNldFNoaXAoc2hpcHNbMV0sIHt4OiA5LCB5OiA2fSwgJ3knKTtcbiAgICBBSXBsYXllci5nYW1lYm9hcmQuc2V0U2hpcChzaGlwc1syXSwge3g6IDEsIHk6IDd9LCAneScpO1xuICAgIEFJcGxheWVyLmdhbWVib2FyZC5zZXRTaGlwKHNoaXBzWzNdLCB7eDogNywgeTogMX0sICd4Jyk7XG4gICAgQUlwbGF5ZXIuZ2FtZWJvYXJkLnNldFNoaXAoc2hpcHNbNF0sIHt4OiA0LCB5OiAzfSwgJ3gnKTtcbiAgfVxuXG4gIGNvbnN0IGdldFJhbmRvbVZhbGlkQ29vcmRzID0gKCkgPT4ge1xuICAgIGNvbnN0IGJvYXJkID0gQUlwbGF5ZXIuZ2FtZWJvYXJkLmdldEJvYXJkKCk7XG4gICAgY29uc3QgdmFsaWRDZWxscyA9IGJvYXJkLmZpbHRlcihjZWxsID0+ICFjZWxsLmlzU2hvdCk7XG4gICAgY29uc3QgY29vcmRzID0gdmFsaWRDZWxsc1tNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiB2YWxpZENlbGxzLmxlbmd0aCldLmNvb3JkcztcbiAgICByZXR1cm4gY29vcmRzO1xuICB9XG5cbiAgZnVuY3Rpb24gc2h1ZmZsZUZpc2hlcllhdGVzKGFycmF5KSB7XG4gICAgbGV0IGkgPSBhcnJheS5sZW5ndGg7XG4gICAgd2hpbGUgKGktLSkge1xuICAgICAgY29uc3QgcmkgPSBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiBpKTtcbiAgICAgIFthcnJheVtpXSwgYXJyYXlbcmldXSA9IFthcnJheVtyaV0sIGFycmF5W2ldXTtcbiAgICB9XG4gICAgcmV0dXJuIGFycmF5O1xuICB9XG5cbiAgY29uc3QgdHJhY2UgPSAoKSA9PiB7XG4gICAgY29uc3QgYWRqYWNlbnRDb29yZHMgPSBzaHVmZmxlRmlzaGVyWWF0ZXMoW1xuICAgICAge3g6IFByZXZTaGlwSGl0LnggKyAxLCB5OiBQcmV2U2hpcEhpdC55fSxcbiAgICAgIHt4OiBQcmV2U2hpcEhpdC54IC0gMSwgeTogUHJldlNoaXBIaXQueX0sXG4gICAgICB7eDogUHJldlNoaXBIaXQueCwgeTogUHJldlNoaXBIaXQueSArIDF9LFxuICAgICAge3g6IFByZXZTaGlwSGl0LngsIHk6IFByZXZTaGlwSGl0LnkgLSAxfVxuICAgIF0pO1xuXG4gICAgbGV0IGFkZGl0aXZlQ29vcmRzO1xuXG4gICAgZm9yIChjb25zdCBjb29yZHMgb2YgYWRqYWNlbnRDb29yZHMpIHtcbiAgICAgIGlmIChjb29yZHMueCA8IDAgfHwgY29vcmRzLnggPiA5IHx8IGNvb3Jkcy55IDwgMCB8fCBjb29yZHMueSA+IDkpIGNvbnRpbnVlO1xuICAgICAgbGV0IGNlbGwgPSBBSXBsYXllci5nYW1lYm9hcmQuYXQoY29vcmRzKTtcbiAgICAgIGxldCBuZXdDb29yZHMgPSBPYmplY3QuYXNzaWduKHt9LCBjb29yZHMpO1xuICAgICAgaWYgKGNlbGwuaXNTaG90ICYmIGNlbGwuaGFzU2hpcCkge1xuICAgICAgICBhZGRpdGl2ZUNvb3JkcyA9IHt4OiBuZXdDb29yZHMueCAtIFByZXZTaGlwSGl0LngsIHk6IG5ld0Nvb3Jkcy55IC0gUHJldlNoaXBIaXQueX07XG4gICAgICAgIHdoaWxlIChjZWxsLmlzU2hvdCAmJiBjZWxsLmhhc1NoaXApIHtcbiAgICAgICAgICBuZXdDb29yZHMueCArPSBhZGRpdGl2ZUNvb3Jkcy54O1xuICAgICAgICAgIG5ld0Nvb3Jkcy55ICs9IGFkZGl0aXZlQ29vcmRzLnk7XG4gICAgICAgICAgY2VsbCA9IEFJcGxheWVyLmdhbWVib2FyZC5hdChuZXdDb29yZHMpO1xuICAgICAgICB9XG4gICAgICAgIGlmIChjZWxsLmlzU2hvdCkge1xuICAgICAgICAgIGNvbnN0IGN1cnJlbnRDb29yZHMgPSBPYmplY3QuYXNzaWduKHt9LCBQcmV2U2hpcEhpdCk7XG4gICAgICAgICAgY3VycmVudENvb3Jkcy54IC09IGFkZGl0aXZlQ29vcmRzLng7XG4gICAgICAgICAgY3VycmVudENvb3Jkcy55IC09IGFkZGl0aXZlQ29vcmRzLnk7XG4gICAgICAgICAgcmV0dXJuIGN1cnJlbnRDb29yZHM7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIG5ld0Nvb3JkcztcbiAgICAgIH1cbiAgICB9XG5cbiAgICBmb3IgKGNvbnN0IGNvb3JkcyBvZiBhZGphY2VudENvb3Jkcykge1xuICAgICAgaWYgKGNvb3Jkcy54IDwgMCB8fCBjb29yZHMueCA+IDkgfHwgY29vcmRzLnkgPCAwIHx8IGNvb3Jkcy55ID4gOSkgY29udGludWU7XG4gICAgICBsZXQgY2VsbCA9IEFJcGxheWVyLmdhbWVib2FyZC5hdChjb29yZHMpO1xuICAgICAgaWYgKGNlbGwuaXNTaG90KSBjb250aW51ZTtcbiAgICAgIGVsc2UgcmV0dXJuIGNvb3JkcztcbiAgICB9XG4gIH1cblxuICBjb25zdCBnZXRDb29yZHMgPSAoYm9hcmQpID0+IHtcbiAgICBsZXQgY29vcmRzO1xuICAgIEFJcGxheWVyLmdhbWVib2FyZCA9IGJvYXJkO1xuICAgIGlmIChQcmV2U2hpcEhpdCkge1xuICAgICAgLy8gaWYgcHJldiBoaXQgc3VuayBhIHNoaXAgdGhlbiByZXNldFxuICAgICAgaWYgKEFJcGxheWVyLmdhbWVib2FyZC5nZXRTaGlwcygpLmZpbmQoc2hpcCA9PiBzaGlwLm5hbWUgPT09IEFJcGxheWVyLmdhbWVib2FyZC5hdChQcmV2U2hpcEhpdCkuaGFzU2hpcCkuaXNTdW5rKCkpIHtcbiAgICAgICAgUHJldlNoaXBIaXQgPSBudWxsO1xuICAgICAgICBjb29yZHMgPSBnZXRSYW5kb21WYWxpZENvb3JkcygpO1xuICAgICAgfSBlbHNlIGNvb3JkcyA9IHRyYWNlKCk7XG4gICAgfSBlbHNlIGNvb3JkcyA9IGdldFJhbmRvbVZhbGlkQ29vcmRzKCk7XG4gICAgaWYgKEFJcGxheWVyLmdhbWVib2FyZC5pc1NoaXBIaXQoY29vcmRzKSkgUHJldlNoaXBIaXQgPSBjb29yZHM7XG4gICAgLy8gUHJldkhpdCA9IEFJcGxheWVyLmdhbWVib2FyZC5pc1NoaXBIaXQoY29vcmRzKSA/IGNvb3JkczogbnVsbDtcbiAgICByZXR1cm4gY29vcmRzO1xuICB9O1xuXG4gIGNvbnN0IGdldEFJUGxheWVyID0gKCkgPT4ge1xuICAgIHBsYWNlU2hpcHMoKTtcbiAgICByZXR1cm4gQUlwbGF5ZXI7XG4gIH1cblxuICByZXR1cm4ge1xuICAgIGdldENvb3JkcyxcbiAgICBnZXRBSVBsYXllcixcbiAgfTtcblxufSkoKTtcblxuZXhwb3J0IGRlZmF1bHQgQUk7IiwiaW1wb3J0IFBsYXllciBmcm9tIFwiLi4vRmFjdG9yaWVzL1BsYXllclwiO1xuaW1wb3J0IFVJIGZyb20gXCIuL1VJXCI7XG5pbXBvcnQgQUkgZnJvbSBcIi4vQUlQbGF5ZXJcIjtcbmltcG9ydCBQbGFjZVNoaXBzIGZyb20gXCIuL1BsYWNlU2hpcHNcIjtcblxuY29uc3QgR2FtZUNvbnRyb2xsZXIgPSAoKCkgPT4ge1xuXG4gIGNvbnN0IHBsYXllcjEgPSBQbGF5ZXIoJ1AxJywgJ1BsYXllcicpO1xuICBjb25zdCBwbGF5ZXIyID0gUGxheWVyKCdQMicsICdFbmVteScpO1xuXG4gIGZ1bmN0aW9uIHNsZWVwKG1zKSB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKHJlc29sdmUgPT4gc2V0VGltZW91dChyZXNvbHZlLCBtcykpO1xuICB9IFxuXG4gIGNvbnN0IG9wcG9uZW50ID0gKCkgPT4ge1xuICAgIHJldHVybiBwbGF5ZXIxLmlzQWN0aXZlID8gcGxheWVyMjogcGxheWVyMTtcbiAgfVxuXG4gIGNvbnN0IGFjdGl2ZVBsYXllciA9ICgpID0+IHtcbiAgICByZXR1cm4gcGxheWVyMS5pc0FjdGl2ZSA/IHBsYXllcjE6IHBsYXllcjI7XG4gIH1cblxuICBjb25zdCB0b2dnbGVBY3RpdmVQbGF5ZXIgPSAoKSA9PiB7XG4gICAgcGxheWVyMS5pc0FjdGl2ZSA9ICFwbGF5ZXIxLmlzQWN0aXZlO1xuICAgIHBsYXllcjIuaXNBY3RpdmUgPSAhcGxheWVyMi5pc0FjdGl2ZTtcbiAgICBVSS50b2dnbGVBY3RpdmVCb2FyZCgpO1xuICB9XG5cbiAgY29uc3QgaW5pdFBsYXllcjEgPSAoKSA9PiB7XG4gICAgcGxheWVyMS5pc0FjdGl2ZSA9IHRydWU7XG4gICAgcGxheWVyMS5nYW1lYm9hcmQgPSBQbGFjZVNoaXBzLmdldFNhbXBsZVBsYXllcigpLmdhbWVib2FyZDtcbiAgICBVSS5yZW5kZXJHYW1lYm9hcmQoJ1AxJywgcGxheWVyMS5uYW1lLCBwbGF5ZXIxLmdhbWVib2FyZC5nZXRCb2FyZCgpKTtcbiAgICBVSS51cGRhdGVTaGlwc0Rpc3BsYXkocGxheWVyMS5uYW1lLCBwbGF5ZXIxLmdhbWVib2FyZC5nZXRTaGlwcygpKTtcbiAgfVxuXG4gIGNvbnN0IGluaXRQbGF5ZXIyID0gKCkgPT4ge1xuICAgIHBsYXllcjIuaXNBY3RpdmUgPSBmYWxzZTtcbiAgICBwbGF5ZXIyLmdhbWVib2FyZCA9IEFJLmdldEFJUGxheWVyKCkuZ2FtZWJvYXJkO1xuICAgIFVJLnJlbmRlckdhbWVib2FyZCgnUDInLCBwbGF5ZXIyLm5hbWUsIHBsYXllcjIuZ2FtZWJvYXJkLmdldEJvYXJkKCksIHRydWUpO1xuICAgIFVJLnVwZGF0ZVNoaXBzRGlzcGxheShwbGF5ZXIyLm5hbWUsIHBsYXllcjIuZ2FtZWJvYXJkLmdldFNoaXBzKCkpO1xuXG4gIH1cblxuICBjb25zdCBwbGF5VHVybiA9IGFzeW5jIChjb29yZHMpID0+IHtcbiAgICBjb25zdCBvcHBvbmVudEJvYXJkID0gb3Bwb25lbnQoKS5nYW1lYm9hcmQ7XG4gICAgaWYgKCFvcHBvbmVudEJvYXJkLmlzVmFsaWRBdHRhY2soY29vcmRzKSkgcmV0dXJuO1xuICAgIG9wcG9uZW50Qm9hcmQucmVjZWl2ZUF0dGFjayhjb29yZHMpO1xuICAgIFVJLnVwZGF0ZVNoaXBzRGlzcGxheShvcHBvbmVudCgpLm5hbWUsIG9wcG9uZW50Qm9hcmQuZ2V0U2hpcHMoKSk7XG4gICAgaWYgKCFvcHBvbmVudEJvYXJkLmlzU2hpcEhpdChjb29yZHMpKSB7XG4gICAgICBhd2FpdCBzbGVlcCgzMDApO1xuICAgICAgdG9nZ2xlQWN0aXZlUGxheWVyKCk7XG4gICAgfVxuICAgIGVsc2UgaWYgKG9wcG9uZW50Qm9hcmQuYWxsU2hpcHNTdW5rKCkpIHtcbiAgICAgIFVJLnNob3dXaW5uZXIoYWN0aXZlUGxheWVyKCkuZGlzcGxheU5hbWUpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBwbGF5R2FtZSgpO1xuICB9XG5cbiAgY29uc3QgcGxheUdhbWUgPSBhc3luYyAoKSA9PiB7XG4gICAgaWYgKHBsYXllcjIuaXNBY3RpdmUpIHtcbiAgICAgIGF3YWl0IHNsZWVwKE1hdGgucmFuZG9tKCkqMzAwICsgNTAwKTtcbiAgICAgIHBsYXlUdXJuKEFJLmdldENvb3JkcyhvcHBvbmVudCgpLmdhbWVib2FyZCkpO1xuICAgIH1cbiAgfVxuXG4gIGNvbnN0IGluaXQgPSAoKSA9PiB7XG4gICAgaW5pdFBsYXllcjEoKTtcbiAgICBpbml0UGxheWVyMigpO1xuICB9O1xuXG4gIHJldHVybiB7XG4gICAgaW5pdCxcbiAgICBwbGF5VHVybixcbiAgfTtcblxufSkoKTtcblxuZXhwb3J0IGRlZmF1bHQgR2FtZUNvbnRyb2xsZXI7IiwiaW1wb3J0IEdhbWVDb250cm9sbGVyIGZyb20gXCIuL0dhbWVDb250cm9sbGVyXCI7XG5pbXBvcnQgUGxheWVyIGZyb20gXCIuLi9GYWN0b3JpZXMvUGxheWVyXCI7XG5pbXBvcnQgU2hpcCBmcm9tIFwiLi4vRmFjdG9yaWVzL1NoaXBcIjtcbmltcG9ydCBVSSBmcm9tIFwiLi9VSVwiO1xuXG5jb25zdCBQbGFjZVNoaXBzID0gKCgpID0+IHtcbiAgY29uc3QgcGxheWVyID0gUGxheWVyKCdzYW1wbGUnKTtcbiAgY29uc3Qgc2hpcHMgPSBbU2hpcCg1LCAnQ2FycmllcicpLCBTaGlwKDQsICdCYXR0bGVzaGlwJyksIFNoaXAoMywgJ0NydWlzZXInKSwgU2hpcCgzLCAnU3VibWFyaW5lJyksIFNoaXAoMiwgJ0Rlc3Ryb3llcicpXTtcbiAgbGV0IGN1cnJlbnQgPSB7XG4gICAgc2hpcE51bTogMCxcbiAgICBzaGlwQ29vcmRzQXJyYXk6IFtdLFxuICAgIGF4aXM6ICd4J1xuICB9O1xuICBjb25zdCAkbW9kYWwgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcubW9kYWwnKTtcbiAgY29uc3QgJHBsYXlCdXR0b24gPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCdidXR0b24ucGxheScpO1xuICBjb25zdCAkcmVzZXRCdXR0b24gPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCdidXR0b24ucmVzZXQnKTtcblxuICAvLyBVdGlsIFxuXG4gIGNvbnN0IGNlbGxBdCA9IChjb29yZHMpID0+IHtcbiAgICByZXR1cm4gZG9jdW1lbnQucXVlcnlTZWxlY3RvcihgW2RhdGEtY29vcmRzPVwiJHtjb29yZHMueH0gJHtjb29yZHMueX1cIl1gKTtcbiAgfVxuXG4gIC8vIERPTVxuXG4gIGNvbnN0IHNob3dTaGlwID0gKGNvb3JkcykgPT4ge1xuICAgIGlmIChjdXJyZW50LnNoaXBOdW0gPj0gc2hpcHMubGVuZ3RoKSByZXR1cm47XG4gICAgaWYgKGN1cnJlbnQuc2hpcENvb3Jkc0FycmF5Lmxlbmd0aCAhPT0gMCkge1xuICAgICAgY3VycmVudC5zaGlwQ29vcmRzQXJyYXkuZm9yRWFjaChjb29yZHMgPT4ge1xuICAgICAgICBjZWxsQXQoY29vcmRzKS5jbGFzc0xpc3QucmVtb3ZlKCd0ZW1wJyk7XG4gICAgICAgIGNlbGxBdChjb29yZHMpLmNsYXNzTGlzdC5yZW1vdmUoJ2ludmFsaWQnKTtcbiAgICAgIH0pXG4gICAgfVxuICAgIGN1cnJlbnQuc2hpcENvb3Jkc0FycmF5ID0gbWFrZVNoaXAoY29vcmRzKTtcbiAgICBjdXJyZW50LnNoaXBDb29yZHNBcnJheS5mb3JFYWNoKGNvb3JkcyA9PiB7XG4gICAgICBjZWxsQXQoY29vcmRzKS5jbGFzc0xpc3QuYWRkKFwidGVtcFwiKTtcbiAgICB9KVxuICAgIGlmICghaXNTaGlwVmFsaWQoKSkge1xuICAgICAgY3VycmVudC5zaGlwQ29vcmRzQXJyYXkuZm9yRWFjaChjb29yZHMgPT4ge1xuICAgICAgICBjZWxsQXQoY29vcmRzKS5jbGFzc0xpc3QuYWRkKFwiaW52YWxpZFwiKTtcbiAgICAgIH0pXG4gICAgfVxuICB9XG5cbiAgY29uc3QgbWFrZVNoaXAgPSAoY29vcmRzKSA9PiB7XG4gICAgbGV0IHNoaXBDb29yZHNBcnJheSA9IFtdO1xuICAgIGxldCBuZXdDb29yZHMgPSBjb29yZHM7XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBzaGlwc1tjdXJyZW50LnNoaXBOdW1dLmdldExlbmd0aCgpOyBpKyspIHtcbiAgICAgIHNoaXBDb29yZHNBcnJheS5wdXNoKHt4OiBuZXdDb29yZHMueCwgeTogbmV3Q29vcmRzLnl9KTtcbiAgICAgIGN1cnJlbnQuYXhpcyA9PT0gJ3gnID8gbmV3Q29vcmRzLngrKzogbmV3Q29vcmRzLnkrKztcbiAgICAgIGlmIChuZXdDb29yZHMueCA+IDkgfHwgbmV3Q29vcmRzLnkgPiA5KSBicmVhaztcbiAgICB9XG4gICAgcmV0dXJuIHNoaXBDb29yZHNBcnJheTtcbiAgfVxuXG4gIGNvbnN0IGlzU2hpcFZhbGlkID0gKCkgPT4ge1xuICAgIHJldHVybiAoIXBsYXllci5nYW1lYm9hcmQuaXNDb2xsaXNpb25zKGN1cnJlbnQuc2hpcENvb3Jkc0FycmF5KSAmJiBcbiAgICAgICAgICBjdXJyZW50LnNoaXBDb29yZHNBcnJheS5sZW5ndGggPT09IHNoaXBzW2N1cnJlbnQuc2hpcE51bV0uZ2V0TGVuZ3RoKCkpO1xuICB9XG5cbiAgXG4gIGNvbnN0IHBsYWNlU2hpcCA9IChjb29yZHMpID0+IHtcbiAgICBpZiAoIWlzU2hpcFZhbGlkKCkpIHJldHVybjtcbiAgICBwbGF5ZXIuZ2FtZWJvYXJkLnNldFNoaXAoc2hpcHNbY3VycmVudC5zaGlwTnVtKytdLCBjb29yZHMsIGN1cnJlbnQuYXhpcyk7XG4gICAgY3VycmVudC5zaGlwQ29vcmRzQXJyYXkuZm9yRWFjaChjb29yZHMgPT4ge1xuICAgICAgY2VsbEF0KGNvb3JkcykuY2xhc3NMaXN0LmFkZCgnc2hpcCcpO1xuICAgICAgY2VsbEF0KGNvb3JkcykuY2xhc3NMaXN0LnJlbW92ZSgndGVtcCcpO1xuICAgIH0pO1xuICAgIFVJLnVwZGF0ZVNoaXBzRGlzcGxheShwbGF5ZXIubmFtZSwgc2hpcHMsIGN1cnJlbnQuc2hpcE51bSAtIDEpO1xuICAgIGlmIChjdXJyZW50LnNoaXBOdW0gPT09IHNoaXBzLmxlbmd0aCkge1xuICAgICAgJHBsYXlCdXR0b24uc3R5bGUuZGlzcGxheSA9ICdibG9jayc7XG4gICAgfVxuICB9XG5cbiAgY29uc3QgcmVzZXQgPSAoKSA9PiB7XG4gICAgcGxheWVyLmdhbWVib2FyZC5yZXNldCgpO1xuICAgIHBsYXllci5nYW1lYm9hcmQuZ2V0Qm9hcmQoKS5mb3JFYWNoKGNlbGwgPT4ge1xuICAgICAgY2VsbEF0KGNlbGwuY29vcmRzKS5jbGFzc0xpc3QucmVtb3ZlKCdzaGlwJyk7XG4gICAgICBjZWxsQXQoY2VsbC5jb29yZHMpLmNsYXNzTGlzdC5yZW1vdmUoJ3RlbXAnKTtcbiAgICB9KTtcbiAgICBjb25zdCAkc2hpcENvbnRhaW5lcnMgPSBBcnJheS5mcm9tKGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJy5zaGlwcy1kaXNwbGF5JykuY2hpbGRyZW4pO1xuICAgICRzaGlwQ29udGFpbmVycy5mb3JFYWNoKCRzaGlwQ29udGFpbmVyID0+ICRzaGlwQ29udGFpbmVyLmNsYXNzTGlzdC5yZW1vdmUoJ3N1bmsnKSk7XG4gICAgY3VycmVudCA9IHtcbiAgICAgIHNoaXBOdW06IDAsXG4gICAgICBzaGlwQ29vcmRzQXJyYXk6IFtdLFxuICAgICAgYXhpczogJ3gnXG4gICAgfTtcbiAgICAkcGxheUJ1dHRvbi5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnO1xuICB9XG4gIFxuICBjb25zdCBnZXRTYW1wbGVQbGF5ZXIgPSAoKSA9PiBwbGF5ZXI7XG5cbiAgY29uc3QgaW5pdCA9ICgpID0+IHtcbiAgICBVSS5yZW5kZXJHYW1lYm9hcmQoJ3NhbXBsZScsIHBsYXllci5uYW1lLCBwbGF5ZXIuZ2FtZWJvYXJkLmdldEJvYXJkKCkpO1xuICAgIFVJLnVwZGF0ZVNoaXBzRGlzcGxheShwbGF5ZXIubmFtZSwgc2hpcHMpO1xuXG4gICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigna2V5dXAnLCAoeyBrZXkgfSkgPT4ge1xuICAgICAgaWYgKGtleSA9PT0gJ1InIHx8IGtleSA9PT0gJ3InKSB7XG4gICAgICAgIGN1cnJlbnQuYXhpcyA9IGN1cnJlbnQuYXhpcyA9PT0gJ3gnID8gJ3knOiAneCc7XG4gICAgICAgIHNob3dTaGlwKGN1cnJlbnQuc2hpcENvb3Jkc0FycmF5WzBdLCBjdXJyZW50LmF4aXMpO1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgJHBsYXlCdXR0b24uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoKSA9PiB7XG4gICAgICAkbW9kYWwucmVtb3ZlKCk7XG4gICAgICBHYW1lQ29udHJvbGxlci5pbml0KCk7XG4gICAgfSlcblxuICAgICRyZXNldEJ1dHRvbi5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIHJlc2V0KTtcbiAgfVxuXG4gIHJldHVybiB7XG4gICAgaW5pdCxcbiAgICBwbGFjZVNoaXAsXG4gICAgc2hvd1NoaXAsXG4gICAgZ2V0U2FtcGxlUGxheWVyLFxuICB9XG5cbn0pKCk7XG5cbmV4cG9ydCBkZWZhdWx0IFBsYWNlU2hpcHM7IiwiLy8gaW1wb3J0IEdhbWVDb250cm9sbGVyIGZyb20gXCIuL01vZHVsZXMvR2FtZUNvbnRyb2xsZXJcIjtcbmltcG9ydCBQbGFjZVNoaXBzIGZyb20gXCIuL01vZHVsZXMvUGxhY2VTaGlwc1wiO1xuXG5QbGFjZVNoaXBzLmluaXQoKTsiXSwibmFtZXMiOlsiJG1haW4iLCJkb2N1bWVudCIsInF1ZXJ5U2VsZWN0b3IiLCIkbW9kYWwiLCIkd2luTW9kYWwiLCJtb2RlIiwiZGVjb2RlQ29vcmRzIiwiY29vcmRzU3RyaW5nIiwiY29vcmRzQXJyYXkiLCJzcGxpdCIsIngiLCJ5IiwiY3JlYXRlSHRtbEVsZW1lbnQiLCJ0eXBlIiwiY2xhc3NBcnJheSIsInRleHQiLCJlbGVtZW50IiwiY3JlYXRlRWxlbWVudCIsImZvckVhY2giLCJjbHMiLCJjbGFzc0xpc3QiLCJhZGQiLCJ0ZXh0Q29udGVudCIsInJlbmRlckdhbWVib2FyZCIsInBsYXllciIsInBsYXllck5hbWUiLCJib2FyZCIsImlzQWN0aXZlIiwiJGNvbnRhaW5lciIsImFwcGVuZENoaWxkIiwibmV3R2FtZWJvYXJkQ29udGFpbmVyRE9NIiwiZmlyc3RDaGlsZCIsImNlbGwiLCIkY2VsbCIsInNldEF0dHJpYnV0ZSIsImNvb3JkcyIsImhhc1NoaXAiLCJhZGRFdmVudExpc3RlbmVyIiwiZ2V0QXR0cmlidXRlIiwiYWRkQ2VsbExpc3RlbmVyIiwibmV3Q2VsbERPTSIsInVwZGF0ZVNoaXBzRGlzcGxheSIsInNoaXBzIiwic2hpcE51bSIsIiRzaGlwc0Rpc3BsYXkiLCJuZXh0RWxlbWVudFNpYmxpbmciLCJzaGlwIiwiaW5kZXgiLCJpc1BsYWNlZCIsIiRzaGlwQ29udGFpbmVyIiwiaXNTdW5rIiwibmFtZSIsIiRzaGlwQm9keSIsImkiLCJnZXRMZW5ndGgiLCJuZXdTaGlwRE9NIiwiY2VsbEhpdCIsImVuY29kZWRDb29yZHMiLCJzaGlwU3VuayIsInRvZ2dsZUFjdGl2ZUJvYXJkIiwiQXJyYXkiLCJmcm9tIiwiY2hpbGRyZW4iLCIkZ2FtZWJvYXJkIiwidG9nZ2xlIiwic2hvd1dpbm5lciIsInBsYXllckRpc3BsYXlOYW1lIiwic2l6ZSIsInN1bmsiLCJhcnIiLCJwdXNoIiwiTWF0aCIsImZsb29yIiwiaXNTaG90IiwiX21ha2VHcmlkIiwiYXQiLCJpc1ZhbGlkQXR0YWNrIiwiaXNTaGlwSGl0IiwicmVjZWl2ZUF0dGFjayIsImZpbmQiLCJoaXQiLCJzaGlwTmFtZSIsImZpbHRlciIsIm1hcCIsInNldFNoaXAiLCJheGlzIiwibmV3Q29vcmRzIiwiaXNDb2xsaXNpb25zIiwic2hpcENvb3Jkc0FycmF5Iiwic2hpcENvb3JkcyIsImFkamFjZW50Q29vcmRzIiwiZ2V0Qm9hcmQiLCJnZXRTaGlwcyIsInJlc2V0IiwiYWxsU2hpcHNTdW5rIiwibGVuZ3RoIiwiZGlzcGxheU5hbWUiLCJnYW1lYm9hcmQiLCJzaGlwTGVuZ3RoIiwiaGl0Q291bnQiLCJnZXRIaXRzIiwiQUlwbGF5ZXIiLCJQcmV2U2hpcEhpdCIsImdldFJhbmRvbVZhbGlkQ29vcmRzIiwidmFsaWRDZWxscyIsInJhbmRvbSIsImdldENvb3JkcyIsImFycmF5IiwicmkiLCJzaHVmZmxlRmlzaGVyWWF0ZXMiLCJhZGRpdGl2ZUNvb3JkcyIsIk9iamVjdCIsImFzc2lnbiIsImN1cnJlbnRDb29yZHMiLCJ0cmFjZSIsImdldEFJUGxheWVyIiwicGxheWVyMSIsInBsYXllcjIiLCJzbGVlcCIsIm1zIiwiUHJvbWlzZSIsInJlc29sdmUiLCJzZXRUaW1lb3V0Iiwib3Bwb25lbnQiLCJwbGF5VHVybiIsImFzeW5jIiwib3Bwb25lbnRCb2FyZCIsInBsYXlHYW1lIiwiaW5pdCIsImN1cnJlbnQiLCIkcGxheUJ1dHRvbiIsIiRyZXNldEJ1dHRvbiIsImNlbGxBdCIsInNob3dTaGlwIiwicmVtb3ZlIiwibWFrZVNoaXAiLCJpc1NoaXBWYWxpZCIsInN0eWxlIiwiZGlzcGxheSIsImtleSIsInBsYWNlU2hpcCIsImdldFNhbXBsZVBsYXllciJdLCJzb3VyY2VSb290IjoiIn0=